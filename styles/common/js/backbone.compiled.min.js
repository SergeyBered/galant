!function(e){var t="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(i,n,r){t.Backbone=e(t,r,i,n)});else if("undefined"!=typeof exports){var i,n=require("underscore");try{i=require("jquery")}catch(e){}e(t,exports,n,i)}else t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(function(e,t,i,n){var r=e.Backbone,s=Array.prototype.slice;t.VERSION="1.3.3",t.$=n,t.noConflict=function(){return e.Backbone=r,this},t.emulateHTTP=!1,t.emulateJSON=!1;var o=function(e,t,n){i.each(t,function(t,r){i[r]&&(e.prototype[r]=function(e,t,n){switch(e){case 1:return function(){return i[t](this[n])};case 2:return function(e){return i[t](this[n],e)};case 3:return function(e,r){return i[t](this[n],a(e,this),r)};case 4:return function(e,r,s){return i[t](this[n],a(e,this),r,s)};default:return function(){var e=s.call(arguments);return e.unshift(this[n]),i[t].apply(i,e)}}}(t,r,n))})},a=function(e,t){return i.isFunction(e)?e:i.isObject(e)&&!t._isModel(e)?l(e):i.isString(e)?function(t){return t.get(e)}:e},l=function(e){var t=i.matches(e);return function(e){return t(e.attributes)}},h=t.Events={},c=/\s+/,p=function(e,t,n,r,s){var o,a=0;if(n&&"object"==typeof n){void 0!==r&&"context"in s&&void 0===s.context&&(s.context=r);for(o=i.keys(n);a<o.length;a++)t=p(e,t,o[a],n[o[a]],s)}else if(n&&c.test(n))for(o=n.split(c);a<o.length;a++)t=e(t,o[a],r,s);else t=e(t,n,r,s);return t};h.on=function(e,t,i){return u(this,e,t,i)};var u=function(e,t,i,n,r){(e._events=p(d,e._events||{},t,i,{context:n,ctx:e,listening:r}),r)&&((e._listeners||(e._listeners={}))[r.id]=r);return e};h.listenTo=function(e,t,n){if(!e)return this;var r=e._listenId||(e._listenId=i.uniqueId("l")),s=this._listeningTo||(this._listeningTo={}),o=s[r];if(!o){var a=this._listenId||(this._listenId=i.uniqueId("l"));o=s[r]={obj:e,objId:r,id:a,listeningTo:s,count:0}}return u(e,t,n,this,o),this};var d=function(e,t,i,n){if(i){var r=e[t]||(e[t]=[]),s=n.context,o=n.ctx,a=n.listening;a&&a.count++,r.push({callback:i,context:s,ctx:s||o,listening:a})}return e};h.off=function(e,t,i){return this._events?(this._events=p(f,this._events,e,t,{context:i,listeners:this._listeners}),this):this},h.stopListening=function(e,t,n){var r=this._listeningTo;if(!r)return this;for(var s=e?[e._listenId]:i.keys(r),o=0;o<s.length;o++){var a=r[s[o]];if(!a)break;a.obj.off(t,n,this)}return this};var f=function(e,t,n,r){if(e){var s,o=0,a=r.context,l=r.listeners;if(t||n||a){for(var h=t?[t]:i.keys(e);o<h.length;o++){var c=e[t=h[o]];if(!c)break;for(var p=[],u=0;u<c.length;u++){var d=c[u];n&&n!==d.callback&&n!==d.callback._callback||a&&a!==d.context?p.push(d):(s=d.listening)&&0==--s.count&&(delete l[s.id],delete s.listeningTo[s.objId])}p.length?e[t]=p:delete e[t]}return e}for(var f=i.keys(l);o<f.length;o++)delete l[(s=l[f[o]]).id],delete s.listeningTo[s.objId]}};h.once=function(e,t,n){var r=p(g,{},e,t,i.bind(this.off,this));return"string"==typeof e&&null==n&&(t=void 0),this.on(r,t,n)},h.listenToOnce=function(e,t,n){var r=p(g,{},t,n,i.bind(this.stopListening,this,e));return this.listenTo(e,r)};var g=function(e,t,n,r){if(n){var s=e[t]=i.once(function(){r(t,s),n.apply(this,arguments)});s._callback=n}return e};h.trigger=function(e){if(!this._events)return this;for(var t=Math.max(0,arguments.length-1),i=Array(t),n=0;n<t;n++)i[n]=arguments[n+1];return p(y,this._events,e,void 0,i),this};var y=function(e,t,i,n){if(e){var r=e[t],s=e.all;r&&s&&(s=s.slice()),r&&m(r,n),s&&m(s,[t].concat(n))}return e},m=function(e,t){var i,n=-1,r=e.length,s=t[0],o=t[1],a=t[2];switch(t.length){case 0:for(;++n<r;)(i=e[n]).callback.call(i.ctx);return;case 1:for(;++n<r;)(i=e[n]).callback.call(i.ctx,s);return;case 2:for(;++n<r;)(i=e[n]).callback.call(i.ctx,s,o);return;case 3:for(;++n<r;)(i=e[n]).callback.call(i.ctx,s,o,a);return;default:for(;++n<r;)(i=e[n]).callback.apply(i.ctx,t);return}};h.bind=h.on,h.unbind=h.off,i.extend(t,h);var v=t.Model=function(e,t){var n=e||{};t||(t={}),this.cid=i.uniqueId(this.cidPrefix),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{});var r=i.result(this,"defaults");n=i.defaults(i.extend({},r,n),r),this.set(n,t),this.changed={},this.initialize.apply(this,arguments)};i.extend(v.prototype,h,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(e){return i.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return i.escape(this.get(e))},has:function(e){return null!=this.get(e)},matches:function(e){return!!i.iteratee(e,this)(this.attributes)},set:function(e,t,n){if(null==e)return this;var r;if("object"==typeof e?(r=e,n=t):(r={})[e]=t,n||(n={}),!this._validate(r,n))return!1;var s=n.unset,o=n.silent,a=[],l=this._changing;this._changing=!0,l||(this._previousAttributes=i.clone(this.attributes),this.changed={});var h=this.attributes,c=this.changed,p=this._previousAttributes;for(var u in r)t=r[u],i.isEqual(h[u],t)||a.push(u),i.isEqual(p[u],t)?delete c[u]:c[u]=t,s?delete h[u]:h[u]=t;if(this.idAttribute in r&&(this.id=this.get(this.idAttribute)),!o){a.length&&(this._pending=n);for(var d=0;d<a.length;d++)this.trigger("change:"+a[d],this,h[a[d]],n)}if(l)return this;if(!o)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,i.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,i.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!i.isEmpty(this.changed):i.has(this.changed,e)},changedAttributes:function(e){if(!e)return!!this.hasChanged()&&i.clone(this.changed);var t=this._changing?this._previousAttributes:this.attributes,n={};for(var r in e){var s=e[r];i.isEqual(t[r],s)||(n[r]=s)}return!!i.size(n)&&n},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(e){e=i.extend({parse:!0},e);var t=this,n=e.success;return e.success=function(i){var r=e.parse?t.parse(i,e):i;if(!t.set(r,e))return!1;n&&n.call(e.context,t,i,e),t.trigger("sync",t,i,e)},F(this,e),this.sync("read",this,e)},save:function(e,t,n){var r;null==e||"object"==typeof e?(r=e,n=t):(r={})[e]=t;var s=(n=i.extend({validate:!0,parse:!0},n)).wait;if(r&&!s){if(!this.set(r,n))return!1}else if(!this._validate(r,n))return!1;var o=this,a=n.success,l=this.attributes;n.success=function(e){o.attributes=l;var t=n.parse?o.parse(e,n):e;if(s&&(t=i.extend({},r,t)),t&&!o.set(t,n))return!1;a&&a.call(n.context,o,e,n),o.trigger("sync",o,e,n)},F(this,n),r&&s&&(this.attributes=i.extend({},l,r));var h=this.isNew()?"create":n.patch?"patch":"update";"patch"!==h||n.attrs||(n.attrs=r);var c=this.sync(h,this,n);return this.attributes=l,c},destroy:function(e){e=e?i.clone(e):{};var t=this,n=e.success,r=e.wait,s=function(){t.stopListening(),t.trigger("destroy",t,t.collection,e)};e.success=function(i){r&&s(),n&&n.call(e.context,t,i,e),t.isNew()||t.trigger("sync",t,i,e)};var o=!1;return this.isNew()?i.defer(e.success):(F(this,e),o=this.sync("delete",this,e)),r||s(),o},url:function(){var e=i.result(this,"urlRoot")||i.result(this.collection,"url")||z();if(this.isNew())return e;var t=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(t)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},i.extend({},e,{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=i.extend({},this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return!n||(this.trigger("invalid",this,n,i.extend(t,{validationError:n})),!1)}});o(v,{keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1},"attributes");var _=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,i.extend({silent:!0},t))},b={add:!0,remove:!0,merge:!0},w={add:!0,remove:!1},x=function(e,t,i){i=Math.min(Math.max(i,0),e.length);var n,r=Array(e.length-i),s=t.length;for(n=0;n<r.length;n++)r[n]=e[n+i];for(n=0;n<s;n++)e[n+i]=t[n];for(n=0;n<r.length;n++)e[n+s+i]=r[n]};i.extend(_.prototype,h,{model:v,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){return this.set(e,i.extend({merge:!1},t,w))},remove:function(e,t){t=i.extend({},t);var n=!i.isArray(e);e=n?[e]:e.slice();var r=this._removeModels(e,t);return!t.silent&&r.length&&(t.changes={added:[],merged:[],removed:r},this.trigger("update",this,t)),n?r[0]:r},set:function(e,t){if(null!=e){(t=i.extend({},b,t)).parse&&!this._isModel(e)&&(e=this.parse(e,t)||[]);var n=!i.isArray(e);e=n?[e]:e.slice();var r=t.at;null!=r&&(r=+r),r>this.length&&(r=this.length),r<0&&(r+=this.length+1);var s,o,a=[],l=[],h=[],c=[],p={},u=t.add,d=t.merge,f=t.remove,g=!1,y=this.comparator&&null==r&&!1!==t.sort,m=i.isString(this.comparator)?this.comparator:null;for(o=0;o<e.length;o++){s=e[o];var v=this.get(s);if(v){if(d&&s!==v){var _=this._isModel(s)?s.attributes:s;t.parse&&(_=v.parse(_,t)),v.set(_,t),h.push(v),y&&!g&&(g=v.hasChanged(m))}p[v.cid]||(p[v.cid]=!0,a.push(v)),e[o]=v}else u&&(s=e[o]=this._prepareModel(s,t))&&(l.push(s),this._addReference(s,t),p[s.cid]=!0,a.push(s))}if(f){for(o=0;o<this.length;o++)p[(s=this.models[o]).cid]||c.push(s);c.length&&this._removeModels(c,t)}var w=!1,k=!y&&u&&f;if(a.length&&k?(w=this.length!==a.length||i.some(this.models,function(e,t){return e!==a[t]}),this.models.length=0,x(this.models,a,0),this.length=this.models.length):l.length&&(y&&(g=!0),x(this.models,l,null==r?this.length:r),this.length=this.models.length),g&&this.sort({silent:!0}),!t.silent){for(o=0;o<l.length;o++)null!=r&&(t.index=r+o),(s=l[o]).trigger("add",s,this,t);(g||w)&&this.trigger("sort",this,t),(l.length||c.length||h.length)&&(t.changes={added:l,removed:c,merged:h},this.trigger("update",this,t))}return n?e[0]:e}},reset:function(e,t){t=t?i.clone(t):{};for(var n=0;n<this.models.length;n++)this._removeReference(this.models[n],t);return t.previousModels=this.models,this._reset(),e=this.add(e,i.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,i.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e)},unshift:function(e,t){return this.add(e,i.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e)},slice:function(){return s.apply(this.models,arguments)},get:function(e){if(null!=e)return this._byId[e]||this._byId[this.modelId(e.attributes||e)]||e.cid&&this._byId[e.cid]},has:function(e){return null!=this.get(e)},at:function(e){return e<0&&(e+=this.length),this.models[e]},where:function(e,t){return this[t?"find":"filter"](e)},findWhere:function(e){return this.where(e,!0)},sort:function(e){var t=this.comparator;if(!t)throw new Error("Cannot sort a set without a comparator");e||(e={});var n=t.length;return i.isFunction(t)&&(t=i.bind(t,this)),1===n||i.isString(t)?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("sort",this,e),this},pluck:function(e){return this.map(e+"")},fetch:function(e){var t=(e=i.extend({parse:!0},e)).success,n=this;return e.success=function(i){var r=e.reset?"reset":"set";n[r](i,e),t&&t.call(e.context,n,i,e),n.trigger("sync",n,i,e)},F(this,e),this.sync("read",this,e)},create:function(e,t){var n=(t=t?i.clone(t):{}).wait;if(!(e=this._prepareModel(e,t)))return!1;n||this.add(e,t);var r=this,s=t.success;return t.success=function(e,t,i){n&&r.add(e,i),s&&s.call(i.context,e,t,i)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(e){return e[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(this._isModel(e))return e.collection||(e.collection=this),e;(t=t?i.clone(t):{}).collection=this;var n=new this.model(e,t);return n.validationError?(this.trigger("invalid",this,n.validationError,t),!1):n},_removeModels:function(e,t){for(var i=[],n=0;n<e.length;n++){var r=this.get(e[n]);if(r){var s=this.indexOf(r);this.models.splice(s,1),this.length--,delete this._byId[r.cid];var o=this.modelId(r.attributes);null!=o&&delete this._byId[o],t.silent||(t.index=s,r.trigger("remove",r,this,t)),i.push(r),this._removeReference(r,t)}}return i},_isModel:function(e){return e instanceof v},_addReference:function(e,t){this._byId[e.cid]=e;var i=this.modelId(e.attributes);null!=i&&(this._byId[i]=e),e.on("all",this._onModelEvent,this)},_removeReference:function(e,t){delete this._byId[e.cid];var i=this.modelId(e.attributes);null!=i&&delete this._byId[i],this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,i,n){if(t){if(("add"===e||"remove"===e)&&i!==this)return;if("destroy"===e&&this.remove(t,n),"change"===e){var r=this.modelId(t.previousAttributes()),s=this.modelId(t.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=t))}}this.trigger.apply(this,arguments)}});o(_,{forEach:3,each:3,map:3,collect:3,reduce:0,foldl:0,inject:0,reduceRight:0,foldr:0,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3,findIndex:3,findLastIndex:3},"models");var k=t.View=function(e){this.cid=i.uniqueId("view"),i.extend(this,i.pick(e,R)),this._ensureElement(),this.initialize.apply(this,arguments)},M=/^(\S+)\s*(.*)$/,R=["model","collection","el","id","attributes","className","tagName","events"];i.extend(k.prototype,h,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(e){return this.undelegateEvents(),this._setElement(e),this.delegateEvents(),this},_setElement:function(e){this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0]},delegateEvents:function(e){if(e||(e=i.result(this,"events")),!e)return this;for(var t in this.undelegateEvents(),e){var n=e[t];if(i.isFunction(n)||(n=this[n]),n){var r=t.match(M);this.delegate(r[1],r[2],i.bind(n,this))}}return this},delegate:function(e,t,i){return this.$el.on(e+".delegateEvents"+this.cid,t,i),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this},undelegate:function(e,t,i){return this.$el.off(e+".delegateEvents"+this.cid,t,i),this},_createElement:function(e){return document.createElement(e)},_ensureElement:function(){if(this.el)this.setElement(i.result(this,"el"));else{var e=i.extend({},i.result(this,"attributes"));this.id&&(e.id=i.result(this,"id")),this.className&&(e.class=i.result(this,"className")),this.setElement(this._createElement(i.result(this,"tagName"))),this._setAttributes(e)}},_setAttributes:function(e){this.$el.attr(e)}}),t.sync=function(e,n,r){var s=C[e];i.defaults(r||(r={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var o={type:s,dataType:"json"};if(r.url||(o.url=i.result(n,"url")||z()),null!=r.data||!n||"create"!==e&&"update"!==e&&"patch"!==e||(o.contentType="application/json",o.data=JSON.stringify(r.attrs||n.toJSON(r))),r.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),r.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){o.type="POST",r.emulateJSON&&(o.data._method=s);var a=r.beforeSend;r.beforeSend=function(e){if(e.setRequestHeader("X-HTTP-Method-Override",s),a)return a.apply(this,arguments)}}"GET"===o.type||r.emulateJSON||(o.processData=!1);var l=r.error;r.error=function(e,t,i){r.textStatus=t,r.errorThrown=i,l&&l.call(r.context,e,t,i)};var h=r.xhr=t.ajax(i.extend(o,r));return n.trigger("request",n,h,r),h};var C={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};t.ajax=function(){return t.$.ajax.apply(t.$,arguments)};var T=t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},E=/\((.*?)\)/g,O=/(\(\?)?:\w+/g,S=/\*\w+/g,A=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend(T.prototype,h,{initialize:function(){},route:function(e,n,r){i.isRegExp(e)||(e=this._routeToRegExp(e)),i.isFunction(n)&&(r=n,n=""),r||(r=this[n]);var s=this;return t.history.route(e,function(i){var o=s._extractParameters(e,i);!1!==s.execute(r,o,n)&&(s.trigger.apply(s,["route:"+n].concat(o)),s.trigger("route",n,o),t.history.trigger("route",s,n,o))}),this},execute:function(e,t,i){e&&e.apply(this,t)},navigate:function(e,i){return t.history.navigate(e,i),this},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var e,t=i.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(A,"\\$&").replace(E,"(?:$1)?").replace(O,function(e,t){return t?e:"([^/?]+)"}).replace(S,"([^?]*?)"),new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(e,t){var n=e.exec(t).slice(1);return i.map(n,function(e,t){return t===n.length-1?e||null:e?decodeURIComponent(e):null})}});var I=t.History=function(){this.handlers=[],this.checkUrl=i.bind(this.checkUrl,this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},V=/^[#\/]|\s+$/g,j=/^\/+|\/+$/g,N=/#.*$/;I.started=!1,i.extend(I.prototype,h,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root&&!this.getSearch()},matchRoot:function(){return this.decodeFragment(this.location.pathname).slice(0,this.root.length-1)+"/"===this.root},decodeFragment:function(e){return decodeURI(e.replace(/%25/g,"%2525"))},getSearch:function(){var e=this.location.href.replace(/#.*/,"").match(/\?.+/);return e?e[0]:""},getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getPath:function(){var e=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===e.charAt(0)?e.slice(1):e},getFragment:function(e){return null==e&&(e=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),e.replace(V,"")},start:function(e){if(I.started)throw new Error("Backbone.history has already been started");if(I.started=!0,this.options=i.extend({root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=!1!==this.options.hashChange,this._hasHashChange="onhashchange"in window&&(void 0===document.documentMode||document.documentMode>7),this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(j,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var t=this.root.slice(0,-1)||"/";return this.location.replace(t+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var n=document.body,r=n.insertBefore(this.iframe,n.firstChild).contentWindow;r.document.open(),r.document.close(),r.location.hash="#"+this.fragment}var s=window.addEventListener||function(e,t){return attachEvent("on"+e,t)};if(this._usePushState?s("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?s("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var e=window.removeEventListener||function(e,t){return detachEvent("on"+e,t)};this._usePushState?e("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&e("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),I.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();if(t===this.fragment&&this.iframe&&(t=this.getHash(this.iframe.contentWindow)),t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()},loadUrl:function(e){return!!this.matchRoot()&&(e=this.fragment=this.getFragment(e),i.some(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0}))},navigate:function(e,t){if(!I.started)return!1;t&&!0!==t||(t={trigger:!!t}),e=this.getFragment(e||"");var i=this.root;""!==e&&"?"!==e.charAt(0)||(i=i.slice(0,-1)||"/");var n=i+e;if(e=this.decodeFragment(e.replace(N,"")),this.fragment!==e){if(this.fragment=e,this._usePushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);if(this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getHash(this.iframe.contentWindow)){var r=this.iframe.contentWindow;t.replace||(r.document.open(),r.document.close()),this._updateHash(r.location,e,t.replace)}}return t.trigger?this.loadUrl(e):void 0}},_updateHash:function(e,t,i){if(i){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}}),t.history=new I;v.extend=_.extend=T.extend=k.extend=I.extend=function(e,t){var n,r=this;return n=e&&i.has(e,"constructor")?e.constructor:function(){return r.apply(this,arguments)},i.extend(n,r,t),n.prototype=i.create(r.prototype,e),n.prototype.constructor=n,n.__super__=r.prototype,n};var z=function(){throw new Error('A "url" property or function must be specified')},F=function(e,t){var i=t.error;t.error=function(n){i&&i.call(t.context,e,n,t),e.trigger("error",e,n,t)}};return t}),function(e){"use strict";e.Templates.registerLoader("ajax",function(t,i,n,r){var s,o,a=i.precompiled,l=this.parsers[i.parser]||this.parser.twig;if("undefined"==typeof XMLHttpRequest)throw new e.Error('Unsupported platform: Unable to do ajax requests because there is no "XMLHTTPRequest" implementation');return(o=new XMLHttpRequest).onreadystatechange=function(){var h=null;4===o.readyState&&(200===o.status||window.cordova&&0==o.status?(e.log.debug("Got template ",o.responseText),h=!0===a?JSON.parse(o.responseText):o.responseText,i.url=t,i.data=h,s=l.call(this,i),"function"==typeof n&&n(s)):"function"==typeof r&&r(o))},o.open("GET",t,!!i.async),o.send(),!!i.async||s})}(Twig=function(e){"use strict";return e.trace=!1,e.debug=!1,e.cache=!0,e.placeholders={parent:"{{|PARENT|}}"},e.indexOf=function(e,t){if(Array.prototype.hasOwnProperty("indexOf"))return e.indexOf(t);if(null==e)throw new TypeError;var i=Object(e),n=i.length>>>0;if(0===n)return-1;var r=0;if(arguments.length>0&&((r=Number(arguments[1]))!=r?r=0:0!==r&&r!==1/0&&r!==-1/0&&(r=(r>0||-1)*Math.floor(Math.abs(r)))),r>=n)return-1;for(var s=r>=0?r:Math.max(n-Math.abs(r),0);s<n;s++)if(s in i&&i[s]===t)return s;return e==t?0:-1},e.forEach=function(e,t,i){if(Array.prototype.forEach)return e.forEach(t,i);var n,r;if(null==e)throw new TypeError(" this is null or not defined");var s=Object(e),o=s.length>>>0;if("[object Function]"!={}.toString.call(t))throw new TypeError(t+" is not a function");for(i&&(n=i),r=0;r<o;){var a;r in s&&(a=s[r],t.call(n,a,r,s)),r++}},e.merge=function(t,i,n){return e.forEach(Object.keys(i),function(e){(!n||e in t)&&(t[e]=i[e])}),t},e.Error=function(e){this.message=e,this.name="TwigException",this.type="TwigException"},e.Error.prototype.toString=function(){return this.name+": "+this.message},e.log={trace:function(){e.trace&&console&&console.log(Array.prototype.slice.call(arguments))},debug:function(){e.debug&&console&&console.log(Array.prototype.slice.call(arguments))}},"undefined"!=typeof console?void 0!==console.error?e.log.error=function(){console.error.apply(console,arguments)}:void 0!==console.log&&(e.log.error=function(){console.log.apply(console,arguments)}):e.log.error=function(){},e.ChildContext=function(e){var t=function(){};return t.prototype=e,new t},e.token={},e.token.type={output:"output",logic:"logic",comment:"comment",raw:"raw",output_whitespace_pre:"output_whitespace_pre",output_whitespace_post:"output_whitespace_post",output_whitespace_both:"output_whitespace_both",logic_whitespace_pre:"logic_whitespace_pre",logic_whitespace_post:"logic_whitespace_post",logic_whitespace_both:"logic_whitespace_both"},e.token.definitions=[{type:e.token.type.raw,open:"{% raw %}",close:"{% endraw %}"},{type:e.token.type.raw,open:"{% verbatim %}",close:"{% endverbatim %}"},{type:e.token.type.output_whitespace_pre,open:"{{-",close:"}}"},{type:e.token.type.output_whitespace_post,open:"{{",close:"-}}"},{type:e.token.type.output_whitespace_both,open:"{{-",close:"-}}"},{type:e.token.type.logic_whitespace_pre,open:"{%-",close:"%}"},{type:e.token.type.logic_whitespace_post,open:"{%",close:"-%}"},{type:e.token.type.logic_whitespace_both,open:"{%-",close:"-%}"},{type:e.token.type.output,open:"{{",close:"}}"},{type:e.token.type.logic,open:"{%",close:"%}"},{type:e.token.type.comment,open:"{#",close:"#}"}],e.token.strings=['"',"'"],e.token.findStart=function(t){var i,n,r,s,o={position:null,close_position:null,def:null};for(i=0;i<e.token.definitions.length;i++)n=e.token.definitions[i],r=t.indexOf(n.open),s=t.indexOf(n.close),e.log.trace("Twig.token.findStart: ","Searching for ",n.open," found at ",r),r>=0&&n.open.length!==n.close.length&&s<0||(r>=0&&(null===o.position||r<o.position)?(o.position=r,o.def=n,o.close_position=s):r>=0&&null!==o.position&&r===o.position&&(n.open.length>o.def.open.length?(o.position=r,o.def=n,o.close_position=s):n.open.length===o.def.open.length&&(n.close.length,o.def.close.length,s>=0&&s<o.close_position&&(o.position=r,o.def=n,o.close_position=s))));return delete o.close_position,o},e.token.findEnd=function(t,i,n){for(var r,s,o=null,a=!1,l=0,h=null,c=null,p=null,u=null,d=null,f=null;!a;){if(h=null,c=null,!((p=t.indexOf(i.close,l))>=0))throw new e.Error("Unable to find closing bracket '"+i.close+"' opened near template position "+n);if(o=p,a=!0,i.type===e.token.type.comment)break;if(i.type===e.token.type.raw)break;for(s=e.token.strings.length,r=0;r<s;r+=1)(d=t.indexOf(e.token.strings[r],l))>0&&d<p&&(null===h||d<h)&&(h=d,c=e.token.strings[r]);if(null!==h)for(u=h+1,o=null,a=!1;;){if((f=t.indexOf(c,u))<0)throw"Unclosed string in template";if("\\"!==t.substr(f-1,1)){l=f+1;break}u=f+1}}return o},e.tokenize=function(t){for(var i=[],n=0,r=null,s=null;t.length>0;)if(r=e.token.findStart(t),e.log.trace("Twig.tokenize: ","Found token: ",r),null!==r.position){if(r.position>0&&i.push({type:e.token.type.raw,value:t.substring(0,r.position)}),t=t.substr(r.position+r.def.open.length),n+=r.position+r.def.open.length,s=e.token.findEnd(t,r.def,n),e.log.trace("Twig.tokenize: ","Token ends at ",s),i.push({type:r.def.type,value:t.substring(0,s).trim()}),"\n"===t.substr(s+r.def.close.length,1))switch(r.def.type){case"logic_whitespace_pre":case"logic_whitespace_post":case"logic_whitespace_both":case"logic":s+=1}t=t.substr(s+r.def.close.length),n+=s+r.def.close.length}else i.push({type:e.token.type.raw,value:t}),t="";return i},e.compile=function(t){try{for(var i=[],n=[],r=[],s=null,o=null,a=null,l=null,h=null,c=null,p=null,u=null,d=null,f=null,g=null,y=null,m=function(t){e.expression.compile.apply(this,[t]),n.length>0?r.push(t):i.push(t)},v=function(t){if(o=e.logic.compile.apply(this,[t]),f=o.type,g=e.logic.handler[f].open,y=e.logic.handler[f].next,e.log.trace("Twig.compile: ","Compiled logic token to ",o," next is: ",y," open is : ",g),void 0!==g&&!g){if(l=n.pop(),p=e.logic.handler[l.type],e.indexOf(p.next,f)<0)throw new Error(f+" not expected after a "+l.type);l.output=l.output||[],l.output=l.output.concat(r),r=[],d={type:e.token.type.logic,token:l},n.length>0?r.push(d):i.push(d)}void 0!==y&&y.length>0?(e.log.trace("Twig.compile: ","Pushing ",o," to logic stack."),n.length>0&&((l=n.pop()).output=l.output||[],l.output=l.output.concat(r),n.push(l),r=[]),n.push(o)):void 0!==g&&g&&(d={type:e.token.type.logic,token:o},n.length>0?r.push(d):i.push(d))};t.length>0;){switch(s=t.shift(),h=i[i.length-1],c=r[r.length-1],u=t[0],e.log.trace("Compiling token ",s),s.type){case e.token.type.raw:n.length>0?r.push(s):i.push(s);break;case e.token.type.logic:v.call(this,s);break;case e.token.type.comment:break;case e.token.type.output:m.call(this,s);break;case e.token.type.logic_whitespace_pre:case e.token.type.logic_whitespace_post:case e.token.type.logic_whitespace_both:case e.token.type.output_whitespace_pre:case e.token.type.output_whitespace_post:case e.token.type.output_whitespace_both:switch(s.type!==e.token.type.output_whitespace_post&&s.type!==e.token.type.logic_whitespace_post&&(h&&h.type===e.token.type.raw&&(i.pop(),null===h.value.match(/^\s*$/)&&(h.value=h.value.trim(),i.push(h))),c&&c.type===e.token.type.raw&&(r.pop(),null===c.value.match(/^\s*$/)&&(c.value=c.value.trim(),r.push(c)))),s.type){case e.token.type.output_whitespace_pre:case e.token.type.output_whitespace_post:case e.token.type.output_whitespace_both:m.call(this,s);break;case e.token.type.logic_whitespace_pre:case e.token.type.logic_whitespace_post:case e.token.type.logic_whitespace_both:v.call(this,s)}s.type!==e.token.type.output_whitespace_pre&&s.type!==e.token.type.logic_whitespace_pre&&u&&u.type===e.token.type.raw&&(t.shift(),null===u.value.match(/^\s*$/)&&(u.value=u.value.trim(),t.unshift(u)))}e.log.trace("Twig.compile: "," Output: ",i," Logic Stack: ",n," Pending Output: ",r)}if(n.length>0)throw a=n.pop(),new Error("Unable to find an end tag for "+a.type+", expecting one of "+a.next);return i}catch(t){if(e.log.error("Error compiling twig template "+this.id+": "),t.stack?e.log.error(t.stack):e.log.error(t.toString()),this.options.rethrow)throw t}},e.parse=function(t,i){try{var n=[],r=!0,s=this;return e.forEach(t,function(t){switch(e.log.debug("Twig.parse: ","Parsing token: ",t),t.type){case e.token.type.raw:n.push(e.filters.raw(t.value));break;case e.token.type.logic:var o=t.token,a=e.logic.parse.apply(s,[o,i,r]);void 0!==a.chain&&(r=a.chain),void 0!==a.context&&(i=a.context),void 0!==a.output&&n.push(a.output);break;case e.token.type.comment:break;case e.token.type.output_whitespace_pre:case e.token.type.output_whitespace_post:case e.token.type.output_whitespace_both:case e.token.type.output:e.log.debug("Twig.parse: ","Output token: ",t.stack),n.push(e.expression.parse.apply(s,[t.stack,i]))}}),e.output.apply(this,[n])}catch(t){if(e.log.error("Error parsing twig template "+this.id+": "),t.stack?e.log.error(t.stack):e.log.error(t.toString()),this.options.rethrow)throw t;if(e.debug)return t.toString()}},e.prepare=function(t){var i,n;return e.log.debug("Twig.prepare: ","Tokenizing ",t),n=e.tokenize.apply(this,[t]),e.log.debug("Twig.prepare: ","Compiling ",n),i=e.compile.apply(this,[n]),e.log.debug("Twig.prepare: ","Compiled ",i),i},e.output=function(t){if(!this.options.autoescape)return t.join("");var i="html";"string"==typeof this.options.autoescape&&(i=this.options.autoescape);var n=[];return e.forEach(t,function(t){t&&!0!==t.twig_markup&&t.twig_markup!=i&&(t=e.filters.escape(t,[i])),n.push(t)}),e.Markup(n.join(""))},e.Templates={loaders:{},parsers:{},registry:{}},e.validateId=function(t){if("prototype"===t)throw new e.Error(t+" is not a valid twig identifier");if(e.cache&&e.Templates.registry.hasOwnProperty(t))throw new e.Error("There is already a template with the ID "+t);return!0},e.Templates.registerLoader=function(t,i,n){if("function"!=typeof i)throw new e.Error("Unable to add loader for "+t+": Invalid function reference given.");n&&(i=i.bind(n)),this.loaders[t]=i},e.Templates.unRegisterLoader=function(e){this.isRegisteredLoader(e)&&delete this.loaders[e]},e.Templates.isRegisteredLoader=function(e){return this.loaders.hasOwnProperty(e)},e.Templates.registerParser=function(t,i,n){if("function"!=typeof i)throw new e.Error("Unable to add parser for "+t+": Invalid function regerence given.");n&&(i=i.bind(n)),this.parsers[t]=i},e.Templates.unRegisterParser=function(e){this.isRegisteredParser(e)&&delete this.parsers[e]},e.Templates.isRegisteredParser=function(e){return this.parsers.hasOwnProperty(e)},e.Templates.save=function(t){if(void 0===t.id)throw new e.Error("Unable to save template with no id");e.Templates.registry[t.id]=t},e.Templates.load=function(t){return e.Templates.registry.hasOwnProperty(t)?e.Templates.registry[t]:null},e.Templates.loadRemote=function(t,i,n,r){return void 0===i.async&&(i.async=!0),void 0===i.id&&(i.id=t),e.cache&&e.Templates.registry.hasOwnProperty(i.id)?("function"==typeof n&&n(e.Templates.registry[i.id]),e.Templates.registry[i.id]):(i.parser=i.parser||"twig",(this.loaders[i.method]||this.loaders.fs).apply(this,arguments))},e.Template=function(t){var i,n,r,s=t.data,o=t.id,a=t.blocks,l=t.macros||{},h=t.base,c=t.path,p=t.url,u=t.name,d=t.method,f=t.options;this.id=o,this.method=d,this.base=h,this.path=c,this.url=p,this.name=u,this.macros=l,this.options=f,this.reset(a),i="String",n=s,r=Object.prototype.toString.call(n).slice(8,-1),this.tokens=null!=n&&r===i?e.prepare.apply(this,[s]):s,void 0!==o&&e.Templates.save(this)},e.Template.prototype.reset=function(t){e.log.debug("Twig.Template.reset","Reseting template "+this.id),this.blocks={},this.importedBlocks=[],this.originalBlockTokens={},this.child={blocks:t||{}},this.extend=null},e.Template.prototype.render=function(t,i){var n,r,s;return i=i||{},this.context=t||{},this.reset(),i.blocks&&(this.blocks=i.blocks),i.macros&&(this.macros=i.macros),n=e.parse.apply(this,[this.tokens,this.context]),this.extend?(this.options.allowInlineIncludes&&(s=e.Templates.load(this.extend))&&(s.options=this.options),s||(r=e.path.parsePath(this,this.extend),s=e.Templates.loadRemote(r,{method:this.getLoaderMethod(),base:this.base,async:!1,id:r,options:this.options})),this.parent=s,this.parent.render(this.context,{blocks:this.blocks})):"blocks"==i.output?this.blocks:"macros"==i.output?this.macros:n},e.Template.prototype.importFile=function(t){var i,n;if(!this.url&&this.options.allowInlineIncludes){if(t=this.path?this.path+"/"+t:t,!(n=e.Templates.load(t))&&!(n=e.Templates.loadRemote(i,{id:t,method:this.getLoaderMethod(),async:!1,options:this.options})))throw new e.Error("Unable to find the template "+t);return n.options=this.options,n}return i=e.path.parsePath(this,t),n=e.Templates.loadRemote(i,{method:this.getLoaderMethod(),base:this.base,async:!1,options:this.options,id:i})},e.Template.prototype.importBlocks=function(t,i){var n=this.importFile(t),r=this.context,s=this;i=i||!1,n.render(r),e.forEach(Object.keys(n.blocks),function(e){(i||void 0===s.blocks[e])&&(s.blocks[e]=n.blocks[e],s.importedBlocks.push(e))})},e.Template.prototype.importMacros=function(t){var i=e.path.parsePath(this,t);return e.Templates.loadRemote(i,{method:this.getLoaderMethod(),async:!1,id:i})},e.Template.prototype.getLoaderMethod=function(){return this.path?"fs":this.url?"ajax":this.method||"fs"},e.Template.prototype.compile=function(t){return e.compiler.compile(this,t)},e.Markup=function(e,t){return void 0===t&&(t=!0),"string"==typeof e&&e.length>0&&((e=new String(e)).twig_markup=t),e},e}((Twig=function(e){return e.VERSION="0.8.9",e}(Twig||{}))||{})),function(e){"use strict";var t,i;try{t=require("fs"),i=require("path")}catch(e){}e.Templates.registerLoader("fs",function(n,r,s,o){var a,l=null,h=r.precompiled,c=this.parsers[r.parser]||this.parser.twig;if(!t||!i)throw new e.Error('Unsupported platform: Unable to load from file because there is no "fs" or "path" implementation');var p=function(e,t){e?"function"==typeof o&&o(e):(!0===h&&(t=JSON.parse(t)),r.data=t,r.path=r.path||n,a=c.call(this,r),"function"==typeof s&&s(a))};if(r.path=r.path||n,r.async)return t.stat(r.path,function(i,s){if(i||!s.isFile())throw new e.Error("Unable to find template file "+n);t.readFile(r.path,"utf8",p)}),!0;if(!t.statSync(r.path).isFile())throw new e.Error("Unable to find template file "+n);return l=t.readFileSync(r.path,"utf8"),p(void 0,l),a})}(Twig),function(e){"use strict";e.Templates.registerParser("source",function(e){return e.data||""})}(Twig),function(e){"use strict";e.Templates.registerParser("twig",function(t){return new e.Template(t)})}(Twig),function(){"use strict";String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t,i=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&i.push(t);return i})}();var Twig=function(e){return e.compiler={module:{}},e.compiler.compile=function(t,i){var n,r=JSON.stringify(t.tokens),s=t.id;if(i.module){if(void 0===e.compiler.module[i.module])throw new e.Error("Unable to find module type "+i.module);n=e.compiler.module[i.module](s,r,i.twig)}else n=e.compiler.wrap(s,r);return n},e.compiler.module={amd:function(t,i,n){return'define(["'+n+'"], function (Twig) {\n\tvar twig, templates;\ntwig = Twig.twig;\ntemplates = '+e.compiler.wrap(t,i)+"\n\treturn templates;\n});"},node:function(t,i){return'var twig = require("twig").twig;\nexports.template = '+e.compiler.wrap(t,i)},cjs2:function(t,i,n){return'module.declare([{ twig: "'+n+'" }], function (require, exports, module) {\n\tvar twig = require("twig").twig;\n\texports.template = '+e.compiler.wrap(t,i)+"\n});"}},e.compiler.wrap=function(e,t){return'twig({id:"'+e.replace('"','\\"')+'", data:'+t+", precompiled: true});\n"},e}((Twig=function(e){"use strict";return e.exports={VERSION:e.VERSION},e.exports.twig=function(t){var i=t.id,n={strict_variables:t.strict_variables||!1,autoescape:null!=t.autoescape&&t.autoescape||!1,allowInlineIncludes:t.allowInlineIncludes||!1,rethrow:t.rethrow||!1,namespaces:t.namespaces};if(e.cache&&i&&e.validateId(i),void 0!==t.debug&&(e.debug=t.debug),void 0!==t.trace&&(e.trace=t.trace),void 0!==t.data)return e.Templates.parsers.twig({data:t.data,path:t.hasOwnProperty("path")?t.path:void 0,module:t.module,id:i,options:n});if(void 0!==t.ref){if(void 0!==t.id)throw new e.Error("Both ref and id cannot be set on a twig.js template.");return e.Templates.load(t.ref)}if(void 0!==t.method){if(!e.Templates.isRegisteredLoader(t.method))throw new e.Error('Loader for "'+t.method+'" is not defined.');return e.Templates.loadRemote(t.name||t.href||t.path||i||void 0,{id:i,method:t.method,parser:t.parser||"twig",base:t.base,module:t.module,precompiled:t.precompiled,async:t.async,options:n},t.load,t.error)}return void 0!==t.href?e.Templates.loadRemote(t.href,{id:i,method:"ajax",parser:t.parser||"twig",base:t.base,module:t.module,precompiled:t.precompiled,async:t.async,options:n},t.load,t.error):void 0!==t.path?e.Templates.loadRemote(t.path,{id:i,method:"fs",parser:t.parser||"twig",base:t.base,module:t.module,precompiled:t.precompiled,async:t.async,options:n},t.load,t.error):void 0},e.exports.extendFilter=function(t,i){e.filter.extend(t,i)},e.exports.extendFunction=function(t,i){e._function.extend(t,i)},e.exports.extendTest=function(t,i){e.test.extend(t,i)},e.exports.extendTag=function(t){e.logic.extend(t)},e.exports.extend=function(t){t(e)},e.exports.compile=function(t,i){var n,r=i.filename,s=i.filename;return n=new e.Template({data:t,path:s,id:r,options:i.settings["twig options"]}),function(e){return n.render(e)}},e.exports.renderFile=function(t,i,n){"function"==typeof i&&(n=i,i={});var r=(i=i||{}).settings||{},s={path:t,base:r.views,load:function(e){n(null,e.render(i))}},o=r["twig options"];if(o)for(var a in o)o.hasOwnProperty(a)&&(s[a]=o[a]);e.exports.twig(s)},e.exports.__express=e.exports.renderFile,e.exports.cache=function(t){e.cache=t},e.exports.path=e.path,e}((Twig=function(e){"use strict";return e.tests={empty:function(e){if(null==e)return!0;if("number"==typeof e)return!1;if(e.length&&e.length>0)return!1;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},odd:function(e){return e%2==1},even:function(e){return e%2==0},divisibleby:function(e,t){return e%t[0]==0},defined:function(e){return void 0!==e},none:function(e){return null===e},null:function(e){return this.none(e)},sameas:function(e,t){return e===t[0]},iterable:function(t){return t&&(e.lib.is("Array",t)||e.lib.is("Object",t))}},e.test=function(t,i,n){if(!e.tests[t])throw"Test "+t+" is not defined.";return e.tests[t](i,n)},e.test.extend=function(t,i){e.tests[t]=i},e}((Twig=function(e){"use strict";return e.path={},e.path.parsePath=function(t,i){var n=null;i=i||"";if("object"==typeof t&&"object"==typeof t.options&&(n=t.options.namespaces),"object"==typeof n&&i.indexOf("::")>0||i.indexOf("@")>=0){for(var r in n)n.hasOwnProperty(r)&&(i=(i=i.replace(r+"::",n[r])).replace("@"+r,n[r]));return i}return e.path.relativePath(t,i)},e.path.relativePath=function(t,i){var n,r,s,o="/",a=[];i=i||"";if(t.url)n=void 0!==t.base?t.base+("/"===t.base.charAt(t.base.length-1)?"":"/"):t.url;else if(t.path){var l=require("path"),h=l.sep||o,c=new RegExp("^\\.{1,2}"+h.replace("\\","\\\\"));i=i.replace(/\//g,h),void 0!==t.base&&null==i.match(c)?(i=i.replace(t.base,""),n=t.base+h):n=l.normalize(t.path),n=n.replace(h+h,h),o=h}else{if(!t.name&&!t.id||!t.method||"fs"===t.method||"ajax"===t.method)throw new e.Error("Cannot extend an inline template.");n=t.base||t.name||t.id}for((r=n.split(o)).pop(),r=r.concat(i.split(o));r.length>0;)"."==(s=r.shift())||(".."==s&&a.length>0&&".."!=a[a.length-1]?a.pop():a.push(s));return a.join(o)},e}((Twig=function(e){return e.functions={range:function(e,t,i){var n,r,s=[],o=i||1,a=!1;if(isNaN(e)||isNaN(t)?isNaN(e)&&isNaN(t)?(a=!0,n=e.charCodeAt(0),r=t.charCodeAt(0)):(n=isNaN(e)?0:e,r=isNaN(t)?0:t):(n=parseInt(e,10),r=parseInt(t,10)),!(n>r))for(;n<=r;)s.push(a?String.fromCharCode(n):n),n+=o;else for(;n>=r;)s.push(a?String.fromCharCode(n):n),n-=o;return s},cycle:function(e,t){return e[t%e.length]},dump:function(){var t=0,i="",n=Array.prototype.slice.call(arguments),r=function(e){for(var t="";e>0;)e--,t+="  ";return t},s=function(e){i+=r(t),"object"==typeof e?o(e):"function"==typeof e?i+="function()\n":"string"==typeof e?i+="string("+e.length+') "'+e+'"\n':"number"==typeof e?i+="number("+e+")\n":"boolean"==typeof e&&(i+="bool("+e+")\n")},o=function(e){var n;if(null===e)i+="NULL\n";else if(void 0===e)i+="undefined\n";else if("object"==typeof e){for(n in i+=r(t)+typeof e,t++,i+="("+function(e){var t,i=0;for(t in e)e.hasOwnProperty(t)&&i++;return i}(e)+") {\n",e)i+=r(t)+"["+n+"]=> \n",s(e[n]);i+=r(--t)+"}\n"}else s(e)};return 0==n.length&&n.push(this.context),e.forEach(n,function(e){o(e)}),i},date:function(t,i){var n;if(void 0===t)n=new Date;else if(e.lib.is("Date",t))n=t;else if(e.lib.is("String",t))n=t.match(/^[0-9]+$/)?new Date(1e3*t):new Date(1e3*e.lib.strtotime(t));else{if(!e.lib.is("Number",t))throw new e.Error("Unable to parse date "+t);n=new Date(1e3*t)}return n},block:function(t){return this.originalBlockTokens[t]?e.logic.parse.apply(this,[this.originalBlockTokens[t],this.context]).output:this.blocks[t]},parent:function(){return e.placeholders.parent},attribute:function(t,i,n){return e.lib.is("Object",t)&&t.hasOwnProperty(i)?"function"==typeof t[i]?t[i].apply(void 0,n):t[i]:t[i]||void 0},max:function(t){return e.lib.is("Object",t)?(delete t._keys,e.lib.max(t)):e.lib.max.apply(null,arguments)},min:function(t){return e.lib.is("Object",t)?(delete t._keys,e.lib.min(t)):e.lib.min.apply(null,arguments)},template_from_string:function(t){return void 0===t&&(t=""),e.Templates.parsers.twig({options:this.options,data:t})},random:function(t){var i=2147483648;function n(e){var t=Math.floor(Math.random()*i),n=[0,e],r=Math.min.apply(null,n),s=Math.max.apply(null,n);return r+Math.floor((s-r+1)*t/i)}if(e.lib.is("Number",t))return n(t);if(e.lib.is("String",t))return t.charAt(n(t.length-1));if(e.lib.is("Array",t))return t[n(t.length-1)];if(e.lib.is("Object",t)){var r=Object.keys(t);return t[r[n(r.length-1)]]}return n(i-1)},source:function(t,i){var n,r,s,o=!1;"undefined"!=typeof module&&void 0!==module.exports&&"undefined"==typeof window?(r="fs",s=__dirname+"/"+t):(r="ajax",s=t);var a={id:t,path:s,method:r,parser:"source",async:!1,fetchTemplateSource:!0};void 0===i&&(i=!1);try{null==(n=e.Templates.loadRemote(t,a))?n="":o=!0}catch(t){e.log.debug("Twig.functions.source: ","Problem loading template  ",t)}return o||i?n:'Template "{name}" is not defined.'.replace("{name}",t)}},e._function=function(t,i,n){if(!e.functions[t])throw"Unable to find function "+t;return e.functions[t](i,n)},e._function.extend=function(t,i){e.functions[t]=i},e}((Twig=function(e){function t(e,t){var i=Object.prototype.toString.call(t).slice(8,-1);return null!=t&&i===e}return e.filters={upper:function(e){return"string"!=typeof e?e:e.toUpperCase()},lower:function(e){return"string"!=typeof e?e:e.toLowerCase()},capitalize:function(e){return"string"!=typeof e?e:e.substr(0,1).toUpperCase()+e.toLowerCase().substr(1)},title:function(e){return"string"!=typeof e?e:e.toLowerCase().replace(/(^|\s)([a-z])/g,function(e,t,i){return t+i.toUpperCase()})},length:function(t){return e.lib.is("Array",t)||"string"==typeof t?t.length:e.lib.is("Object",t)?void 0===t._keys?Object.keys(t).length:t._keys.length:0},reverse:function(e){if(t("Array",e))return e.reverse();if(t("String",e))return e.split("").reverse().join("");if(t("Object",e)){var i=e._keys||Object.keys(e).reverse();return e._keys=i,e}},sort:function(e){if(t("Array",e))return e.sort();if(t("Object",e)){delete e._keys;var i=Object.keys(e).sort(function(t,i){var n;return e[t]>e[i]==!(e[t]<=e[i])?e[t]>e[i]?1:e[t]<e[i]?-1:0:isNaN(n=parseFloat(e[t]))||isNaN(b1=parseFloat(e[i]))?"string"==typeof e[t]?e[t]>e[i].toString()?1:e[t]<e[i].toString()?-1:0:"string"==typeof e[i]?e[t].toString()>e[i]?1:e[t].toString()<e[i]?-1:0:null:n>b1?1:n<b1?-1:0});return e._keys=i,e}},keys:function(t){if(null!=t){var i=t._keys||Object.keys(t),n=[];return e.forEach(i,function(e){"_keys"!==e&&t.hasOwnProperty(e)&&n.push(e)}),n}},url_encode:function(e){if(null!=e){var t=encodeURIComponent(e);return t=t.replace("'","%27")}},join:function(i,n){if(null!=i){var r="",s=[],o=null;return n&&n[0]&&(r=n[0]),t("Array",i)?s=i:(o=i._keys||Object.keys(i),e.forEach(o,function(e){"_keys"!==e&&i.hasOwnProperty(e)&&s.push(i[e])})),s.join(r)}},default:function(t,i){if(void 0!==i&&i.length>1)throw new e.Error("default filter expects one argument");return null==t||""===t?void 0===i?"":i[0]:t},json_encode:function(i){if(null==i)return"null";if("object"==typeof i&&t("Array",i))return r=[],e.forEach(i,function(t){r.push(e.filters.json_encode(t))}),"["+r.join(",")+"]";if("object"==typeof i){var n=i._keys||Object.keys(i),r=[];return e.forEach(n,function(t){r.push(JSON.stringify(t)+":"+e.filters.json_encode(i[t]))}),"{"+r.join(",")+"}"}return JSON.stringify(i)},merge:function(i,n){var r=[],s=0,o=[];if(t("Array",i)?e.forEach(n,function(e){t("Array",e)||(r={})}):r={},t("Array",r)||(r._keys=[]),t("Array",i)?e.forEach(i,function(e){r._keys&&r._keys.push(s),r[s]=e,s++}):(o=i._keys||Object.keys(i),e.forEach(o,function(e){r[e]=i[e],r._keys.push(e);var t=parseInt(e,10);!isNaN(t)&&t>=s&&(s=t+1)})),e.forEach(n,function(i){t("Array",i)?e.forEach(i,function(e){r._keys&&r._keys.push(s),r[s]=e,s++}):(o=i._keys||Object.keys(i),e.forEach(o,function(e){r[e]||r._keys.push(e),r[e]=i[e];var t=parseInt(e,10);!isNaN(t)&&t>=s&&(s=t+1)}))}),0===n.length)throw new e.Error("Filter merge expects at least one parameter");return r},date:function(t,i){var n=e.functions.date(t),r=i&&i.length?i[0]:"F j, Y H:i";return e.lib.formatDate(n,r)},date_modify:function(t,i){if(null!=t){if(void 0===i||1!==i.length)throw new e.Error("date_modify filter expects 1 argument");var n,r=i[0];return e.lib.is("Date",t)&&(n=e.lib.strtotime(r,t.getTime()/1e3)),e.lib.is("String",t)&&(n=e.lib.strtotime(r,e.lib.strtotime(t))),e.lib.is("Number",t)&&(n=e.lib.strtotime(r,t)),new Date(1e3*n)}},replace:function(t,i){if(null!=t){var n,r=i[0];for(n in r)r.hasOwnProperty(n)&&"_keys"!==n&&(t=e.lib.replaceAll(t,n,r[n]));return t}},format:function(t,i){if(null!=t)return e.lib.vsprintf(t,i)},striptags:function(t){if(null!=t)return e.lib.strip_tags(t)},escape:function(t,i){if(null!=t){var n="html";if(i&&i.length&&!0!==i[0]&&(n=i[0]),"html"==n){var r=t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return e.Markup(r,"html")}if("js"==n){r=t.toString();for(var s="",o=0;o<r.length;o++){if(r[o].match(/^[a-zA-Z0-9,\._]$/))s+=r[o];else s+=(a=r.charCodeAt(o))<128?"\\x"+a.toString(16).toUpperCase():e.lib.sprintf("\\u%04s",a.toString(16).toUpperCase())}return e.Markup(s,"js")}if("css"==n){for(r=t.toString(),s="",o=0;o<r.length;o++){if(r[o].match(/^[a-zA-Z0-9]$/))s+=r[o];else s+="\\"+(a=r.charCodeAt(o)).toString(16).toUpperCase()+" "}return e.Markup(s,"css")}if("url"==n){s=e.filters.url_encode(t);return e.Markup(s,"url")}if("html_attr"==n){for(r=t.toString(),s="",o=0;o<r.length;o++)if(r[o].match(/^[a-zA-Z0-9,\.\-_]$/))s+=r[o];else if(r[o].match(/^[&<>"]$/))s+=r[o].replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");else{var a;s+=(a=r.charCodeAt(o))<=31&&9!=a&&10!=a&&13!=a?"&#xFFFD;":a<128?e.lib.sprintf("&#x%02s;",a.toString(16).toUpperCase()):e.lib.sprintf("&#x%04s;",a.toString(16).toUpperCase())}return e.Markup(s,"html_attr")}throw new e.Error("escape strategy unsupported")}},e:function(t,i){return e.filters.escape(t,i)},nl2br:function(t){if(null!=t){var i="<br />BACKSLASH_n_replace";return t=e.filters.escape(t).replace(/\r\n/g,i).replace(/\r/g,i).replace(/\n/g,i),t=e.lib.replaceAll(t,"BACKSLASH_n_replace","\n"),e.Markup(t)}},number_format:function(e,t){var i=e,n=t&&t[0]?t[0]:void 0,r=t&&void 0!==t[1]?t[1]:".",s=t&&void 0!==t[2]?t[2]:",";i=(i+"").replace(/[^0-9+\-Ee.]/g,"");var o=isFinite(+i)?+i:0,a=isFinite(+n)?Math.abs(n):0,l="";return(l=(a?function(e,t){var i=Math.pow(10,t);return""+Math.round(e*i)/i}(o,a):""+Math.round(o)).split("."))[0].length>3&&(l[0]=l[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,s)),(l[1]||"").length<a&&(l[1]=l[1]||"",l[1]+=new Array(a-l[1].length+1).join("0")),l.join(r)},trim:function(t,i){if(null!=t){var n,r=e.filters.escape(""+t);n=i&&i[0]?""+i[0]:" \n\r\t\f\v            ​\u2028\u2029　";for(var s=0;s<r.length;s++)if(-1===n.indexOf(r.charAt(s))){r=r.substring(s);break}for(s=r.length-1;s>=0;s--)if(-1===n.indexOf(r.charAt(s))){r=r.substring(0,s+1);break}return-1===n.indexOf(r.charAt(0))?r:""}},truncate:function(e,t){var i=30,n=!1,r="...";if(e+="",t&&(t[0]&&(i=t[0]),t[1]&&(n=t[1]),t[2]&&(r=t[2])),e.length>i){if(n&&-1===(i=e.indexOf(" ",i)))return e;e=e.substr(0,i)+r}return e},slice:function(t,i){if(null!=t){if(void 0===i||i.length<1)throw new e.Error("slice filter expects at least 1 argument");var n=i[0]||0,r=i.length>1?i[1]:t.length,s=n>=0?n:Math.max(t.length+n,0);if(e.lib.is("Array",t)){for(var o=[],a=s;a<s+r&&a<t.length;a++)o.push(t[a]);return o}if(e.lib.is("String",t))return t.substr(s,r);throw new e.Error("slice filter expects value to be an array or string")}},abs:function(e){if(null!=e)return Math.abs(e)},first:function(e){if(t("Array",e))return e[0];if(t("Object",e)){if("_keys"in e)return e[e._keys[0]]}else if("string"==typeof e)return e.substr(0,1)},split:function(t,i){if(null!=t){if(void 0===i||i.length<1||i.length>2)throw new e.Error("split filter expects 1 or 2 argument");if(e.lib.is("String",t)){var n=i[0],r=i[1],s=t.split(n);if(void 0===r)return s;if(r<0)return t.split(n,s.length+r);var o=[];if(""==n)for(;s.length>0;){for(var a="",l=0;l<r&&s.length>0;l++)a+=s.shift();o.push(a)}else{for(l=0;l<r-1&&s.length>0;l++)o.push(s.shift());s.length>0&&o.push(s.join(n))}return o}throw new e.Error("split filter expects value to be a string")}},last:function(t){var i;return e.lib.is("Object",t)?t[(i=void 0===t._keys?Object.keys(t):t._keys)[i.length-1]]:t[t.length-1]},raw:function(t){return e.Markup(t)},batch:function(t,i){var n,r,s,o=i.shift(),a=i.shift();if(!e.lib.is("Array",t))throw new e.Error("batch filter expects items to be an array");if(!e.lib.is("Number",o))throw new e.Error("batch filter expects size to be a number");if(o=Math.ceil(o),n=e.lib.chunkArray(t,o),a&&t.length%o!=0){for(s=o-(r=n.pop()).length;s--;)r.push(a);n.push(r)}return n},round:function(t,i){var n=(i=i||[]).length>0?i[0]:0,r=i.length>1?i[1]:"common";if(t=parseFloat(t),n&&!e.lib.is("Number",n))throw new e.Error("round filter expects precision to be a number");if("common"===r)return e.lib.round(t,n);if(!e.lib.is("Function",Math[r]))throw new e.Error("round filter expects method to be 'floor', 'ceil', or 'common'");return Math[r](t*Math.pow(10,n))/Math.pow(10,n)}},e.filter=function(t,i,n){if(!e.filters[t])throw"Unable to find filter "+t;return e.filters[t].apply(this,[i,n])},e.filter.extend=function(t,i){e.filters[t]=i},e}((Twig=function(e){"use strict";e.expression.operator={leftToRight:"leftToRight",rightToLeft:"rightToLeft"};var t=function(e,t){if(null==t)return null;if(void 0!==t.indexOf)return e===t||""!==e&&t.indexOf(e)>-1;var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return!0;return!1};return e.expression.operator.lookup=function(t,i){switch(t){case"..":case"not in":case"in":i.precidence=20,i.associativity=e.expression.operator.leftToRight;break;case",":i.precidence=18,i.associativity=e.expression.operator.leftToRight;break;case"?":case":":i.precidence=16,i.associativity=e.expression.operator.rightToLeft;break;case"or":i.precidence=14,i.associativity=e.expression.operator.leftToRight;break;case"and":i.precidence=13,i.associativity=e.expression.operator.leftToRight;break;case"==":case"!=":i.precidence=9,i.associativity=e.expression.operator.leftToRight;break;case"<":case"<=":case">":case">=":i.precidence=8,i.associativity=e.expression.operator.leftToRight;break;case"~":case"+":case"-":i.precidence=6,i.associativity=e.expression.operator.leftToRight;break;case"//":case"**":case"*":case"/":case"%":i.precidence=5,i.associativity=e.expression.operator.leftToRight;break;case"not":i.precidence=3,i.associativity=e.expression.operator.rightToLeft;break;default:throw new e.Error(t+" is an unknown operator.")}return i.operator=t,i},e.expression.operator.parse=function(i,n){var r,s,o;switch(e.log.trace("Twig.expression.operator.parse: ","Handling ",i),i){case":":break;case"?":o=n.pop(),s=n.pop(),(r=n.pop())?n.push(s):n.push(o);break;case"+":s=parseFloat(n.pop()),r=parseFloat(n.pop()),n.push(r+s);break;case"-":s=parseFloat(n.pop()),r=parseFloat(n.pop()),n.push(r-s);break;case"*":s=parseFloat(n.pop()),r=parseFloat(n.pop()),n.push(r*s);break;case"/":s=parseFloat(n.pop()),r=parseFloat(n.pop()),n.push(r/s);break;case"//":s=parseFloat(n.pop()),r=parseFloat(n.pop()),n.push(parseInt(r/s));break;case"%":s=parseFloat(n.pop()),r=parseFloat(n.pop()),n.push(r%s);break;case"~":s=n.pop(),r=n.pop(),n.push((null!=r?r.toString():"")+(null!=s?s.toString():""));break;case"not":case"!":n.push(!n.pop());break;case"<":s=n.pop(),r=n.pop(),n.push(r<s);break;case"<=":s=n.pop(),r=n.pop(),n.push(r<=s);break;case">":s=n.pop(),r=n.pop(),n.push(r>s);break;case">=":s=n.pop(),r=n.pop(),n.push(r>=s);break;case"===":s=n.pop(),r=n.pop(),n.push(r===s);break;case"==":s=n.pop(),r=n.pop(),n.push(r==s);break;case"!==":s=n.pop(),r=n.pop(),n.push(r!==s);break;case"!=":s=n.pop(),r=n.pop(),n.push(r!=s);break;case"or":s=n.pop(),r=n.pop(),n.push(r||s);break;case"and":s=n.pop(),r=n.pop(),n.push(r&&s);break;case"**":s=n.pop(),r=n.pop(),n.push(Math.pow(r,s));break;case"not in":s=n.pop(),r=n.pop(),n.push(!t(r,s));break;case"in":s=n.pop(),r=n.pop(),n.push(t(r,s));break;case"..":s=n.pop(),r=n.pop(),n.push(e.functions.range(r,s));break;default:throw new e.Error(i+" is an unknown operator.")}},e}((Twig=function(e){"use strict";for(e.expression={},e.expression.reservedWords=["true","false","null","TRUE","FALSE","NULL","_context"],e.expression.type={comma:"Twig.expression.type.comma",operator:{unary:"Twig.expression.type.operator.unary",binary:"Twig.expression.type.operator.binary"},string:"Twig.expression.type.string",bool:"Twig.expression.type.bool",array:{start:"Twig.expression.type.array.start",end:"Twig.expression.type.array.end"},object:{start:"Twig.expression.type.object.start",end:"Twig.expression.type.object.end"},parameter:{start:"Twig.expression.type.parameter.start",end:"Twig.expression.type.parameter.end"},key:{period:"Twig.expression.type.key.period",brackets:"Twig.expression.type.key.brackets"},filter:"Twig.expression.type.filter",_function:"Twig.expression.type._function",variable:"Twig.expression.type.variable",number:"Twig.expression.type.number",_null:"Twig.expression.type.null",context:"Twig.expression.type.context",test:"Twig.expression.type.test"},e.expression.set={operations:[e.expression.type.filter,e.expression.type.operator.unary,e.expression.type.operator.binary,e.expression.type.array.end,e.expression.type.object.end,e.expression.type.parameter.end,e.expression.type.comma,e.expression.type.test],expressions:[e.expression.type._function,e.expression.type.bool,e.expression.type.string,e.expression.type.variable,e.expression.type.number,e.expression.type._null,e.expression.type.context,e.expression.type.parameter.start,e.expression.type.array.start,e.expression.type.object.start]},e.expression.set.operations_extended=e.expression.set.operations.concat([e.expression.type.key.period,e.expression.type.key.brackets]),e.expression.fn={compile:{push:function(e,t,i){i.push(e)},push_both:function(e,t,i){i.push(e),t.push(e)}},parse:{push:function(e,t,i){t.push(e)},push_value:function(e,t,i){t.push(e.value)}}},e.expression.definitions=[{type:e.expression.type.test,regex:/^is\s+(not)?\s*([a-zA-Z_][a-zA-Z0-9_]*)/,next:e.expression.set.operations.concat([e.expression.type.parameter.start]),compile:function(e,t,i){e.filter=e.match[2],e.modifier=e.match[1],delete e.match,delete e.value,i.push(e)},parse:function(t,i,n){var r=i.pop(),s=t.params&&e.expression.parse.apply(this,[t.params,n]),o=e.test(t.filter,r,s);"not"==t.modifier?i.push(!o):i.push(o)}},{type:e.expression.type.comma,regex:/^,/,next:e.expression.set.expressions.concat([e.expression.type.array.end,e.expression.type.object.end]),compile:function(t,i,n){var r,s=i.length-1;for(delete t.match,delete t.value;s>=0;s--){if((r=i.pop()).type===e.expression.type.object.start||r.type===e.expression.type.parameter.start||r.type===e.expression.type.array.start){i.push(r);break}n.push(r)}n.push(t)}},{type:e.expression.type.operator.binary,regex:/(^[\+\-~%\?\:]|^[!=]==?|^[!<>]=?|^\*\*?|^\/\/?|^and\s+|^or\s+|^in\s+|^not in\s+|^\.\.)/,next:e.expression.set.expressions.concat([e.expression.type.operator.unary]),compile:function(t,i,n){delete t.match,t.value=t.value.trim();var r=t.value,s=e.expression.operator.lookup(r,t);for(e.log.trace("Twig.expression.compile: ","Operator: ",s," from ",r);i.length>0&&(i[i.length-1].type==e.expression.type.operator.unary||i[i.length-1].type==e.expression.type.operator.binary)&&(s.associativity===e.expression.operator.leftToRight&&s.precidence>=i[i.length-1].precidence||s.associativity===e.expression.operator.rightToLeft&&s.precidence>i[i.length-1].precidence);){var o=i.pop();n.push(o)}if(":"===r){if(!i[i.length-1]||"?"!==i[i.length-1].value){var a=n.pop();if(a.type===e.expression.type.string||a.type===e.expression.type.variable)t.key=a.value;else if(a.type===e.expression.type.number)t.key=a.value.toString();else{if(a.type!==e.expression.type.parameter.end||!a.expression)throw new e.Error("Unexpected value before ':' of "+a.type+" = "+a.value);t.params=a.params}return void n.push(t)}}else i.push(s)},parse:function(t,i,n){t.key?i.push(t):t.params?(t.key=e.expression.parse.apply(this,[t.params,n]),i.push(t),delete t.params):e.expression.operator.parse(t.value,i)}},{type:e.expression.type.operator.unary,regex:/(^not\s+)/,next:e.expression.set.expressions,compile:function(t,i,n){delete t.match,t.value=t.value.trim();var r=t.value,s=e.expression.operator.lookup(r,t);for(e.log.trace("Twig.expression.compile: ","Operator: ",s," from ",r);i.length>0&&(i[i.length-1].type==e.expression.type.operator.unary||i[i.length-1].type==e.expression.type.operator.binary)&&(s.associativity===e.expression.operator.leftToRight&&s.precidence>=i[i.length-1].precidence||s.associativity===e.expression.operator.rightToLeft&&s.precidence>i[i.length-1].precidence);){var o=i.pop();n.push(o)}i.push(s)},parse:function(t,i,n){e.expression.operator.parse(t.value,i)}},{type:e.expression.type.string,regex:/^(["'])(?:(?=(\\?))\2[\s\S])*?\1/,next:e.expression.set.operations,compile:function(t,i,n){var r=t.value;delete t.match,r='"'===r.substring(0,1)?r.replace('\\"','"'):r.replace("\\'","'"),t.value=r.substring(1,r.length-1).replace(/\\n/g,"\n").replace(/\\r/g,"\r"),e.log.trace("Twig.expression.compile: ","String value: ",t.value),n.push(t)},parse:e.expression.fn.parse.push_value},{type:e.expression.type.parameter.start,regex:/^\(/,next:e.expression.set.expressions.concat([e.expression.type.parameter.end]),compile:e.expression.fn.compile.push_both,parse:e.expression.fn.parse.push},{type:e.expression.type.parameter.end,regex:/^\)/,next:e.expression.set.operations_extended,compile:function(t,i,n){var r,s=t;for(r=i.pop();i.length>0&&r.type!=e.expression.type.parameter.start;)n.push(r),r=i.pop();for(var o=[];t.type!==e.expression.type.parameter.start;)o.unshift(t),t=n.pop();o.unshift(t);void 0===(t=n[n.length-1])||t.type!==e.expression.type._function&&t.type!==e.expression.type.filter&&t.type!==e.expression.type.test&&t.type!==e.expression.type.key.brackets&&t.type!==e.expression.type.key.period?(s.expression=!0,o.pop(),o.shift(),s.params=o,n.push(s)):(s.expression=!1,t.params=o)},parse:function(t,i,n){var r=[],s=!1,o=null;if(t.expression)o=e.expression.parse.apply(this,[t.params,n]),i.push(o);else{for(;i.length>0;){if((o=i.pop())&&o.type&&o.type==e.expression.type.parameter.start){s=!0;break}r.unshift(o)}if(!s)throw new e.Error("Expected end of parameter set.");i.push(r)}}},{type:e.expression.type.array.start,regex:/^\[/,next:e.expression.set.expressions.concat([e.expression.type.array.end]),compile:e.expression.fn.compile.push_both,parse:e.expression.fn.parse.push},{type:e.expression.type.array.end,regex:/^\]/,next:e.expression.set.operations_extended,compile:function(t,i,n){for(var r,s=i.length-1;s>=0&&(r=i.pop()).type!==e.expression.type.array.start;s--)n.push(r);n.push(t)},parse:function(t,i,n){for(var r=[],s=!1,o=null;i.length>0;){if((o=i.pop()).type&&o.type==e.expression.type.array.start){s=!0;break}r.unshift(o)}if(!s)throw new e.Error("Expected end of array.");i.push(r)}},{type:e.expression.type.object.start,regex:/^\{/,next:e.expression.set.expressions.concat([e.expression.type.object.end]),compile:e.expression.fn.compile.push_both,parse:e.expression.fn.parse.push},{type:e.expression.type.object.end,regex:/^\}/,next:e.expression.set.operations_extended,compile:function(t,i,n){for(var r,s=i.length-1;s>=0&&(!(r=i.pop())||r.type!==e.expression.type.object.start);s--)n.push(r);n.push(t)},parse:function(t,i,n){for(var r={},s=!1,o=null,a=!1,l=null;i.length>0;){if((o=i.pop())&&o.type&&o.type===e.expression.type.object.start){s=!0;break}if(o&&o.type&&(o.type===e.expression.type.operator.binary||o.type===e.expression.type.operator.unary)&&o.key){if(!a)throw new e.Error("Missing value for key '"+o.key+"' in object definition.");r[o.key]=l,void 0===r._keys&&(r._keys=[]),r._keys.unshift(o.key),l=null,a=!1}else a=!0,l=o}if(!s)throw new e.Error("Unexpected end of object.");i.push(r)}},{type:e.expression.type.filter,regex:/^\|\s?([a-zA-Z_][a-zA-Z0-9_\-]*)/,next:e.expression.set.operations_extended.concat([e.expression.type.parameter.start]),compile:function(e,t,i){e.value=e.match[1],i.push(e)},parse:function(t,i,n){var r=i.pop(),s=t.params&&e.expression.parse.apply(this,[t.params,n]);i.push(e.filter.apply(this,[t.value,r,s]))}},{type:e.expression.type._function,regex:/^([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/,next:e.expression.type.parameter.start,transform:function(e,t){return"("},compile:function(e,t,i){var n=e.match[1];e.fn=n,delete e.match,delete e.value,i.push(e)},parse:function(t,i,n){var r,s=t.params&&e.expression.parse.apply(this,[t.params,n]),o=t.fn;if(e.functions[o])r=e.functions[o].apply(this,s);else{if("function"!=typeof n[o])throw new e.Error(o+" function does not exist and is not defined in the context");r=n[o].apply(n,s)}i.push(r)}},{type:e.expression.type.variable,regex:/^[a-zA-Z_][a-zA-Z0-9_]*/,next:e.expression.set.operations_extended.concat([e.expression.type.parameter.start]),compile:e.expression.fn.compile.push,validate:function(t,i){return e.indexOf(e.expression.reservedWords,t[0])<0},parse:function(t,i,n){var r=e.expression.resolve(n[t.value],n);i.push(r)}},{type:e.expression.type.key.period,regex:/^\.([a-zA-Z0-9_]+)/,next:e.expression.set.operations_extended.concat([e.expression.type.parameter.start]),compile:function(e,t,i){e.key=e.match[1],delete e.match,delete e.value,i.push(e)},parse:function(t,i,n){var r,s=t.params&&e.expression.parse.apply(this,[t.params,n]),o=t.key,a=i.pop();if(null==a){if(this.options.strict_variables)throw new e.Error("Can't access a key "+o+" on an null or undefined object.");return null}var l=function(e){return e.substr(0,1).toUpperCase()+e.substr(1)};r="object"==typeof a&&o in a?a[o]:void 0!==a["get"+l(o)]?a["get"+l(o)]:void 0!==a["is"+l(o)]?a["is"+l(o)]:void 0,i.push(e.expression.resolve(r,a,s))}},{type:e.expression.type.key.brackets,regex:/^\[([^\]]*)\]/,next:e.expression.set.operations_extended.concat([e.expression.type.parameter.start]),compile:function(t,i,n){var r=t.match[1];delete t.value,delete t.match,t.stack=e.expression.compile({value:r}).stack,n.push(t)},parse:function(t,i,n){var r,s=t.params&&e.expression.parse.apply(this,[t.params,n]),o=e.expression.parse.apply(this,[t.stack,n]),a=i.pop();if(null==a){if(this.options.strict_variables)throw new e.Error("Can't access a key "+o+" on an null or undefined object.");return null}r="object"==typeof a&&o in a?a[o]:null,i.push(e.expression.resolve(r,a,s))}},{type:e.expression.type._null,regex:/^(null|NULL|none|NONE)/,next:e.expression.set.operations,compile:function(e,t,i){delete e.match,e.value=null,i.push(e)},parse:e.expression.fn.parse.push_value},{type:e.expression.type.context,regex:/^_context/,next:e.expression.set.operations_extended.concat([e.expression.type.parameter.start]),compile:e.expression.fn.compile.push,parse:function(e,t,i){t.push(i)}},{type:e.expression.type.number,regex:/^\-?\d+(\.\d+)?/,next:e.expression.set.operations,compile:function(e,t,i){e.value=Number(e.value),i.push(e)},parse:e.expression.fn.parse.push_value},{type:e.expression.type.bool,regex:/^(true|TRUE|false|FALSE)/,next:e.expression.set.operations,compile:function(e,t,i){e.value="true"===e.match[0].toLowerCase(),delete e.match,i.push(e)},parse:e.expression.fn.parse.push_value}],e.expression.resolve=function(e,t,i){return"function"==typeof e?e.apply(t,i||[]):e},e.expression.handler={},e.expression.extendType=function(t){e.expression.type[t]="Twig.expression.type."+t},e.expression.extend=function(t){if(!t.type)throw new e.Error("Unable to extend logic definition. No type provided for "+t);e.expression.handler[t.type]=t};e.expression.definitions.length>0;)e.expression.extend(e.expression.definitions.shift());return e.expression.tokenize=function(t){var i,n,r,s,o,a,l=[],h=0,c=null,p=[];for(a=function(){var t=Array.prototype.slice.apply(arguments);t.pop(),t.pop();return e.log.trace("Twig.expression.tokenize","Matched a ",i," regular expression of ",t),c&&e.indexOf(c,i)<0?(p.push(i+" cannot follow a "+l[l.length-1].type+" at template:"+h+" near '"+t[0].substring(0,20)+"...'"),t[0]):e.expression.handler[i].validate&&!e.expression.handler[i].validate(t,l)?t[0]:(p=[],l.push({type:i,value:t[0],match:t}),o=!0,c=s,h+=t[0].length,e.expression.handler[i].transform?e.expression.handler[i].transform(t,l):"")},e.log.debug("Twig.expression.tokenize","Tokenizing expression ",t);t.length>0;){for(i in t=t.trim(),e.expression.handler)if(e.expression.handler.hasOwnProperty(i)){for(s=e.expression.handler[i].next,r=(n=e.expression.handler[i].regex)instanceof Array?n:[n],o=!1;r.length>0;)n=r.pop(),t=t.replace(n,a);if(o)break}if(!o)throw p.length>0?new e.Error(p.join(" OR ")):new e.Error("Unable to parse '"+t+"' at template position"+h)}return e.log.trace("Twig.expression.tokenize","Tokenized to ",l),l},e.expression.compile=function(t){var i=t.value,n=e.expression.tokenize(i),r=null,s=[],o=[],a=null;for(e.log.trace("Twig.expression.compile: ","Compiling ",i);n.length>0;)r=n.shift(),a=e.expression.handler[r.type],e.log.trace("Twig.expression.compile: ","Compiling ",r),a.compile&&a.compile(r,o,s),e.log.trace("Twig.expression.compile: ","Stack is",o),e.log.trace("Twig.expression.compile: ","Output is",s);for(;o.length>0;)s.push(o.pop());return e.log.trace("Twig.expression.compile: ","Final output is",s),t.stack=s,delete t.value,t},e.expression.parse=function(t,i){var n=this;t instanceof Array||(t=[t]);var r=[],s=null;return e.forEach(t,function(t){(s=e.expression.handler[t.type]).parse&&s.parse.apply(n,[t,r,i])}),r.pop()},e}((Twig=function(e){"use strict";for(e.logic={},e.logic.type={if_:"Twig.logic.type.if",endif:"Twig.logic.type.endif",for_:"Twig.logic.type.for",endfor:"Twig.logic.type.endfor",else_:"Twig.logic.type.else",elseif:"Twig.logic.type.elseif",set:"Twig.logic.type.set",setcapture:"Twig.logic.type.setcapture",endset:"Twig.logic.type.endset",filter:"Twig.logic.type.filter",endfilter:"Twig.logic.type.endfilter",shortblock:"Twig.logic.type.shortblock",block:"Twig.logic.type.block",endblock:"Twig.logic.type.endblock",extends_:"Twig.logic.type.extends",use:"Twig.logic.type.use",include:"Twig.logic.type.include",spaceless:"Twig.logic.type.spaceless",endspaceless:"Twig.logic.type.endspaceless",macro:"Twig.logic.type.macro",endmacro:"Twig.logic.type.endmacro",import_:"Twig.logic.type.import",from:"Twig.logic.type.from",embed:"Twig.logic.type.embed",endembed:"Twig.logic.type.endembed"},e.logic.definitions=[{type:e.logic.type.if_,regex:/^if\s+([\s\S]+)$/,next:[e.logic.type.else_,e.logic.type.elseif,e.logic.type.endif],open:!0,compile:function(t){var i=t.match[1];return t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,delete t.match,t},parse:function(t,i,n){var r="";return n=!0,e.expression.parse.apply(this,[t.stack,i])&&(n=!1,r=e.parse.apply(this,[t.output,i])),{chain:n,output:r}}},{type:e.logic.type.elseif,regex:/^elseif\s+([^\s].*)$/,next:[e.logic.type.else_,e.logic.type.elseif,e.logic.type.endif],open:!1,compile:function(t){var i=t.match[1];return t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,delete t.match,t},parse:function(t,i,n){var r="";return n&&!0===e.expression.parse.apply(this,[t.stack,i])&&(n=!1,r=e.parse.apply(this,[t.output,i])),{chain:n,output:r}}},{type:e.logic.type.else_,regex:/^else$/,next:[e.logic.type.endif,e.logic.type.endfor],open:!1,parse:function(t,i,n){var r="";return n&&(r=e.parse.apply(this,[t.output,i])),{chain:n,output:r}}},{type:e.logic.type.endif,regex:/^endif$/,next:[],open:!1},{type:e.logic.type.for_,regex:/^for\s+([a-zA-Z0-9_,\s]+)\s+in\s+([^\s].*?)(?:\s+if\s+([^\s].*))?$/,next:[e.logic.type.else_,e.logic.type.endfor],open:!0,compile:function(t){var i=t.match[1],n=t.match[2],r=t.match[3],s=null;if(t.key_var=null,t.value_var=null,i.indexOf(",")>=0){if(2!==(s=i.split(",")).length)throw new e.Error("Invalid expression in for loop: "+i);t.key_var=s[0].trim(),t.value_var=s[1].trim()}else t.value_var=i;return t.expression=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:n}]).stack,r&&(t.conditional=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:r}]).stack),delete t.match,t},parse:function(t,i,n){var r,s,o=e.expression.parse.apply(this,[t.expression,i]),a=[],l=0,h=this,c=t.conditional,p=function(n,s){var o=e.ChildContext(i);o[t.value_var]=s,t.key_var&&(o[t.key_var]=n),o.loop=function(e,t){var n=void 0!==c;return{index:e+1,index0:e,revindex:n?void 0:t-e,revindex0:n?void 0:t-e-1,first:0===e,last:n?void 0:e===t-1,length:n?void 0:t,parent:i}}(l,r),(void 0===c||e.expression.parse.apply(h,[c,o]))&&(a.push(e.parse.apply(h,[t.output,o])),l+=1),delete o.loop,delete o[t.value_var],delete o[t.key_var],e.merge(i,o,!0)};return e.lib.is("Array",o)?(r=o.length,e.forEach(o,function(e){p(l,e)})):e.lib.is("Object",o)&&(s=void 0!==o._keys?o._keys:Object.keys(o),r=s.length,e.forEach(s,function(e){"_keys"!==e&&p(e,o[e])})),{chain:0===a.length,output:e.output.apply(this,[a])}}},{type:e.logic.type.endfor,regex:/^endfor$/,next:[],open:!1},{type:e.logic.type.set,regex:/^set\s+([a-zA-Z0-9_,\s]+)\s*=\s*([\s\S]+)$/,next:[],open:!0,compile:function(t){var i=t.match[1].trim(),n=t.match[2],r=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:n}]).stack;return t.key=i,t.expression=r,delete t.match,t},parse:function(t,i,n){var r=e.expression.parse.apply(this,[t.expression,i]);return i[t.key]=r,{chain:n,context:i}}},{type:e.logic.type.setcapture,regex:/^set\s+([a-zA-Z0-9_,\s]+)$/,next:[e.logic.type.endset],open:!0,compile:function(e){var t=e.match[1].trim();return e.key=t,delete e.match,e},parse:function(t,i,n){var r=e.parse.apply(this,[t.output,i]),s=t.key;return this.context[s]=r,i[s]=r,{chain:n,context:i}}},{type:e.logic.type.endset,regex:/^endset$/,next:[],open:!1},{type:e.logic.type.filter,regex:/^filter\s+(.+)$/,next:[e.logic.type.endfilter],open:!0,compile:function(t){var i="|"+t.match[1].trim();return t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,delete t.match,t},parse:function(t,i,n){var r=e.parse.apply(this,[t.output,i]),s=[{type:e.expression.type.string,value:r}].concat(t.stack);return{chain:n,output:e.expression.parse.apply(this,[s,i])}}},{type:e.logic.type.endfilter,regex:/^endfilter$/,next:[],open:!1},{type:e.logic.type.block,regex:/^block\s+([a-zA-Z0-9_]+)$/,next:[e.logic.type.endblock],open:!0,compile:function(e){return e.block=e.match[1].trim(),delete e.match,e},parse:function(t,i,n){var r,s=e.indexOf(this.importedBlocks,t.block)>-1,o=this.blocks[t.block]&&e.indexOf(this.blocks[t.block],e.placeholders.parent)>-1;return(void 0===this.blocks[t.block]||s||o||i.loop||t.overwrite)&&(r=t.expression?e.expression.parse.apply(this,[{type:e.expression.type.string,value:e.expression.parse.apply(this,[t.output,i])},i]):e.expression.parse.apply(this,[{type:e.expression.type.string,value:e.parse.apply(this,[t.output,i])},i]),s&&this.importedBlocks.splice(this.importedBlocks.indexOf(t.block),1),this.blocks[t.block]=o?e.Markup(this.blocks[t.block].replace(e.placeholders.parent,r)):r,this.originalBlockTokens[t.block]={type:t.type,block:t.block,output:t.output,overwrite:!0}),{chain:n,output:this.child.blocks[t.block]?this.child.blocks[t.block]:this.blocks[t.block]}}},{type:e.logic.type.shortblock,regex:/^block\s+([a-zA-Z0-9_]+)\s+(.+)$/,next:[],open:!0,compile:function(t){return t.expression=t.match[2].trim(),t.output=e.expression.compile({type:e.expression.type.expression,value:t.expression}).stack,t.block=t.match[1].trim(),delete t.match,t},parse:function(t,i,n){return e.logic.handler[e.logic.type.block].parse.apply(this,arguments)}},{type:e.logic.type.endblock,regex:/^endblock(?:\s+([a-zA-Z0-9_]+))?$/,next:[],open:!1},{type:e.logic.type.extends_,regex:/^extends\s+(.+)$/,next:[],open:!0,compile:function(t){var i=t.match[1].trim();return delete t.match,t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,t},parse:function(t,i,n){var r=e.expression.parse.apply(this,[t.stack,i]);return this.extend=r,{chain:n,output:""}}},{type:e.logic.type.use,regex:/^use\s+(.+)$/,next:[],open:!0,compile:function(t){var i=t.match[1].trim();return delete t.match,t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,t},parse:function(t,i,n){var r=e.expression.parse.apply(this,[t.stack,i]);return this.importBlocks(r),{chain:n,output:""}}},{type:e.logic.type.include,regex:/^include\s+(ignore missing\s+)?(.+?)\s*(?:with\s+([\S\s]+?))?\s*(only)?$/,next:[],open:!0,compile:function(t){var i=t.match,n=void 0!==i[1],r=i[2].trim(),s=i[3],o=void 0!==i[4]&&i[4].length;return delete t.match,t.only=o,t.includeMissing=n,t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:r}]).stack,void 0!==s&&(t.withStack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:s.trim()}]).stack),t},parse:function(t,i,n){var r,s,o={};if(t.only||(o=e.ChildContext(i)),void 0!==t.withStack)for(s in r=e.expression.parse.apply(this,[t.withStack,i]))r.hasOwnProperty(s)&&(o[s]=r[s]);var a=e.expression.parse.apply(this,[t.stack,o]);return{chain:n,output:(a instanceof e.Template?a:this.importFile(a)).render(o)}}},{type:e.logic.type.spaceless,regex:/^spaceless$/,next:[e.logic.type.endspaceless],open:!0,parse:function(t,i,n){return{chain:n,output:e.parse.apply(this,[t.output,i]).replace(/>\s+</g,"><").trim()}}},{type:e.logic.type.endspaceless,regex:/^endspaceless$/,next:[],open:!1},{type:e.logic.type.macro,regex:/^macro\s+([a-zA-Z0-9_]+)\s*\(\s*((?:[a-zA-Z0-9_]+(?:,\s*)?)*)\s*\)$/,next:[e.logic.type.endmacro],open:!0,compile:function(t){for(var i=t.match[1],n=t.match[2].split(/[\s,]+/),r=0;r<n.length;r++)for(var s=0;s<n.length;s++)if(n[r]===n[s]&&r!==s)throw new e.Error("Duplicate arguments for parameter: "+n[r]);return t.macroName=i,t.parameters=n,delete t.match,t},parse:function(t,i,n){var r=this;return this.macros[t.macroName]=function(){for(var i={_self:r.macros},n=0;n<t.parameters.length;n++){var s=t.parameters[n];void 0!==arguments[n]?i[s]=arguments[n]:i[s]=void 0}return e.parse.apply(r,[t.output,i])},{chain:n,output:""}}},{type:e.logic.type.endmacro,regex:/^endmacro$/,next:[],open:!1},{type:e.logic.type.import_,regex:/^import\s+(.+)\s+as\s+([a-zA-Z0-9_]+)$/,next:[],open:!0,compile:function(t){var i=t.match[1].trim(),n=t.match[2].trim();return delete t.match,t.expression=i,t.contextName=n,t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,t},parse:function(t,i,n){if("_self"!==t.expression){var r=e.expression.parse.apply(this,[t.stack,i]),s=this.importFile(r||t.expression);i[t.contextName]=s.render({},{output:"macros"})}else i[t.contextName]=this.macros;return{chain:n,output:""}}},{type:e.logic.type.from,regex:/^from\s+(.+)\s+import\s+([a-zA-Z0-9_, ]+)$/,next:[],open:!0,compile:function(t){for(var i=t.match[1].trim(),n=t.match[2].trim().split(/[ ,]+/),r={},s=0;s<n.length;s++){var o=n[s],a=o.match(/^([a-zA-Z0-9_]+)\s+(.+)\s+as\s+([a-zA-Z0-9_]+)$/);a?r[a[1].trim()]=a[2].trim():o.match(/^([a-zA-Z0-9_]+)$/)&&(r[o]=o)}return delete t.match,t.expression=i,t.macroNames=r,t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:i}]).stack,t},parse:function(t,i,n){var r;if("_self"!==t.expression){var s=e.expression.parse.apply(this,[t.stack,i]);r=this.importFile(s||t.expression).render({},{output:"macros"})}else r=this.macros;for(var o in t.macroNames)r.hasOwnProperty(o)&&(i[t.macroNames[o]]=r[o]);return{chain:n,output:""}}},{type:e.logic.type.embed,regex:/^embed\s+(ignore missing\s+)?(.+?)\s*(?:with\s+(.+?))?\s*(only)?$/,next:[e.logic.type.endembed],open:!0,compile:function(t){var i=t.match,n=void 0!==i[1],r=i[2].trim(),s=i[3],o=void 0!==i[4]&&i[4].length;return delete t.match,t.only=o,t.includeMissing=n,t.stack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:r}]).stack,void 0!==s&&(t.withStack=e.expression.compile.apply(this,[{type:e.expression.type.expression,value:s.trim()}]).stack),t},parse:function(t,i,n){var r,s,o,a={};if(!t.only)for(s in i)i.hasOwnProperty(s)&&(a[s]=i[s]);if(void 0!==t.withStack)for(s in r=e.expression.parse.apply(this,[t.withStack,i]))r.hasOwnProperty(s)&&(a[s]=r[s]);var l=e.expression.parse.apply(this,[t.stack,a]);o=l instanceof e.Template?l:this.importFile(l),this.blocks={};e.parse.apply(this,[t.output,a]);return{chain:n,output:o.render(a,{blocks:this.blocks})}}},{type:e.logic.type.endembed,regex:/^endembed$/,next:[],open:!1}],e.logic.handler={},e.logic.extendType=function(t,i){i=i||"Twig.logic.type"+t,e.logic.type[t]=i},e.logic.extend=function(t){if(!t.type)throw new e.Error("Unable to extend logic definition. No type provided for "+t);e.logic.extendType(t.type),e.logic.handler[t.type]=t};e.logic.definitions.length>0;)e.logic.extend(e.logic.definitions.shift());return e.logic.compile=function(t){var i=t.value.trim(),n=e.logic.tokenize.apply(this,[i]),r=e.logic.handler[n.type];return r.compile&&(n=r.compile.apply(this,[n]),e.log.trace("Twig.logic.compile: ","Compiled logic token to ",n)),n},e.logic.tokenize=function(t){var i={},n=null,r=null,s=null,o=null,a=null;for(n in t=t.trim(),e.logic.handler)if(e.logic.handler.hasOwnProperty(n))for(r=e.logic.handler[n].type,o=[],(s=e.logic.handler[n].regex)instanceof Array?o=s:o.push(s);o.length>0;)if(null!==(a=o.shift().exec(t.trim())))return i.type=r,i.match=a,e.log.trace("Twig.logic.tokenize: ","Matched a ",r," regular expression of ",a),i;throw new e.Error("Unable to parse '"+t.trim()+"'")},e.logic.parse=function(t,i,n){var r,s="";return i=i||{},e.log.debug("Twig.logic.parse: ","Parsing logic token ",t),(r=e.logic.handler[t.type]).parse&&(s=r.parse.apply(this,[t,i,n])),s},e}((Twig=function(e){e.lib={};var t=function(){var e={not_string:/[^s]/,number:/[diefg]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};function t(){var e=arguments[0],i=t.cache;return i[e]&&i.hasOwnProperty(e)||(i[e]=t.parse(e)),t.format.call(null,i[e],arguments)}t.format=function(n,r){var s,o,a,l,h,c,p,u,d=1,f=n.length,g="",y=[],m=!0,v="";for(o=0;o<f;o++)if("string"===(g=i(n[o])))y[y.length]=n[o];else if("array"===g){if((l=n[o])[2])for(s=r[d],a=0;a<l[2].length;a++){if(!s.hasOwnProperty(l[2][a]))throw new Error(t("[sprintf] property '%s' does not exist",l[2][a]));s=s[l[2][a]]}else s=l[1]?r[l[1]]:r[d++];if("function"==i(s)&&(s=s()),e.not_string.test(l[8])&&e.not_json.test(l[8])&&"number"!=i(s)&&isNaN(s))throw new TypeError(t("[sprintf] expecting number but found %s",i(s)));switch(e.number.test(l[8])&&(m=s>=0),l[8]){case"b":s=s.toString(2);break;case"c":s=String.fromCharCode(s);break;case"d":case"i":s=parseInt(s,10);break;case"j":s=JSON.stringify(s,null,l[6]?parseInt(l[6]):0);break;case"e":s=l[7]?s.toExponential(l[7]):s.toExponential();break;case"f":s=l[7]?parseFloat(s).toFixed(l[7]):parseFloat(s);break;case"g":s=l[7]?parseFloat(s).toPrecision(l[7]):parseFloat(s);break;case"o":s=s.toString(8);break;case"s":s=(s=String(s))&&l[7]?s.substring(0,l[7]):s;break;case"u":s>>>=0;break;case"x":s=s.toString(16);break;case"X":s=s.toString(16).toUpperCase()}e.json.test(l[8])?y[y.length]=s:(!e.number.test(l[8])||m&&!l[3]?v="":(v=m?"+":"-",s=s.toString().replace(e.sign,"")),c=l[4]?"0"===l[4]?"0":l[4].charAt(1):" ",p=l[6]-(v+s).length,h=l[6]&&p>0?(u=c,Array(p+1).join(u)):"",y[y.length]=l[5]?v+s+h:"0"===c?v+h+s:h+v+s)}return y.join("")},t.cache={},t.parse=function(t){for(var i=t,n=[],r=[],s=0;i;){if(null!==(n=e.text.exec(i)))r[r.length]=n[0];else if(null!==(n=e.modulo.exec(i)))r[r.length]="%";else{if(null===(n=e.placeholder.exec(i)))throw new SyntaxError("[sprintf] unexpected placeholder");if(n[2]){s|=1;var o=[],a=n[2],l=[];if(null===(l=e.key.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(o[o.length]=l[1];""!==(a=a.substring(l[0].length));)if(null!==(l=e.key_access.exec(a)))o[o.length]=l[1];else{if(null===(l=e.index_access.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");o[o.length]=l[1]}n[2]=o}else s|=2;if(3===s)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");r[r.length]=n}i=i.substring(n[0].length)}return r};function i(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}return{sprintf:t,vsprintf:function(e,i,n){return(n=(i||[]).slice(0)).splice(0,0,e),t.apply(null,n)}}}(),i=t.sprintf,n=t.vsprintf;return e.lib.sprintf=i,e.lib.vsprintf=n,function(){var t="Sun,Mon,Tue,Wed,Thu,Fri,Sat".split(","),i="Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(","),n="Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(","),r="January,February,March,April,May,June,July,August,September,October,November,December".split(",");function s(e){var t=new Date(e.getFullYear()+1,0,4);return(t-e)/864e5<7&&(e.getDay()+6)%7<(t.getDay()+6)%7?t.getFullYear():e.getMonth()>0||e.getDate()>=4?e.getFullYear():e.getFullYear()-((e.getDay()+6)%7-e.getDate()>2?1:0)}e.lib.formatDate=function(e,o){if("string"!=typeof o||/^\s*$/.test(o))return e+"";var a=new Date(e.getFullYear(),0,1),l=e;return o.replace(/[dDjlNSwzWFmMntLoYyaABgGhHisuU]/g,function(e){switch(e){case"d":return("0"+l.getDate()).replace(/^.+(..)$/,"$1");case"D":return t[l.getDay()];case"j":return l.getDate();case"l":return i[l.getDay()];case"N":return(l.getDay()+6)%7+1;case"S":return c=l.getDate(),(c=Math.abs(c)%100)%10==1&&11!=c?"st":c%10==2&&12!=c?"nd":c%10==3&&13!=c?"rd":"th";case"w":return l.getDay();case"z":return Math.ceil((a-l)/864e5);case"W":return("0"+(o=l,h=new Date(s(o),0,4),h.setDate(h.getDate()-(h.getDay()+6)%7),parseInt((o-h)/6048e5)+1)).replace(/^.(..)$/,"$1");case"F":return r[l.getMonth()];case"m":return("0"+(l.getMonth()+1)).replace(/^.+(..)$/,"$1");case"M":return n[l.getMonth()];case"n":return l.getMonth()+1;case"t":return new Date(l.getFullYear(),l.getMonth()+1,-1).getDate();case"L":return 29==new Date(l.getFullYear(),1,29).getDate()?1:0;case"o":return s(l);case"Y":return l.getFullYear();case"y":return(l.getFullYear()+"").replace(/^.+(..)$/,"$1");case"a":return l.getHours()<12?"am":"pm";case"A":return l.getHours()<12?"AM":"PM";case"B":return Math.floor(1e3*((l.getUTCHours()+1)%24+l.getUTCMinutes()/60+l.getUTCSeconds()/3600)/24);case"g":return l.getHours()%12!=0?l.getHours()%12:12;case"G":return l.getHours();case"h":return("0"+(l.getHours()%12!=0?l.getHours()%12:12)).replace(/^.+(..)$/,"$1");case"H":return("0"+l.getHours()).replace(/^.+(..)$/,"$1");case"i":return("0"+l.getMinutes()).replace(/^.+(..)$/,"$1");case"s":return("0"+l.getSeconds()).replace(/^.+(..)$/,"$1");case"u":return l.getMilliseconds();case"U":return l.getTime()/1e3}var o,h,c})}}(),e.lib.strip_tags=function(e,t){t=(((t||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return e.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(e,i){return t.indexOf("<"+i.toLowerCase()+">")>-1?e:""})},e.lib.parseISO8601Date=function(e){var t=[];if(!(t=e.match(/(\d{4})-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)(\.\d+)?(Z|([+-])(\d\d):(\d\d))/)))throw"Couldn't parse ISO 8601 date string '"+e+"'";var i=[1,2,3,4,5,6,10,11];for(var n in i)t[i[n]]=parseInt(t[i[n]],10);t[7]=parseFloat(t[7]);var r=Date.UTC(t[1],t[2]-1,t[3],t[4],t[5],t[6]);if(t[7]>0&&(r+=Math.round(1e3*t[7])),"Z"!=t[8]&&t[10]){var s=60*t[10]*60*1e3;t[11]&&(s+=60*t[11]*1e3),"-"==t[9]?r-=s:r+=s}return new Date(r)},e.lib.strtotime=function(e,t){var i,n,r,s,o,a,l,h,c,p;if(!e)return!1;if((n=(e=e.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").replace(/[\t\r\n]/g,"").toLowerCase()).match(/^(\d{1,4})([\-\.\/\:])(\d{1,2})([\-\.\/\:])(\d{1,4})(?:\s(\d{1,2}):(\d{2})?:?(\d{2})?)?(?:\s([A-Z]+)?)?$/))&&n[2]===n[4])if(n[1]>1901)switch(n[2]){case"-":return!(n[3]>12||n[5]>31)&&new Date(n[1],parseInt(n[3],10)-1,n[5],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3;case".":return!1;case"/":return!(n[3]>12||n[5]>31)&&new Date(n[1],parseInt(n[3],10)-1,n[5],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}else if(n[5]>1901)switch(n[2]){case"-":case".":return!(n[3]>12||n[1]>31)&&new Date(n[5],parseInt(n[3],10)-1,n[1],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3;case"/":return!(n[1]>12||n[3]>31)&&new Date(n[5],parseInt(n[1],10)-1,n[3],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3}else switch(n[2]){case"-":return!(n[3]>12||n[5]>31||n[1]<70&&n[1]>38)&&(s=n[1]>=0&&n[1]<=38?+n[1]+2e3:n[1],new Date(s,parseInt(n[3],10)-1,n[5],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3);case".":return n[5]>=70?!(n[3]>12||n[1]>31)&&new Date(n[5],parseInt(n[3],10)-1,n[1],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3:n[5]<60&&!n[6]&&(!(n[1]>23||n[3]>59)&&(r=new Date,new Date(r.getFullYear(),r.getMonth(),r.getDate(),n[1]||0,n[3]||0,n[5]||0,n[9]||0)/1e3));case"/":return!(n[1]>12||n[3]>31||n[5]<70&&n[5]>38)&&(s=n[5]>=0&&n[5]<=38?+n[5]+2e3:n[5],new Date(s,parseInt(n[1],10)-1,n[3],n[6]||0,n[7]||0,n[8]||0,n[9]||0)/1e3);case":":return!(n[1]>23||n[3]>59||n[5]>59)&&(r=new Date,new Date(r.getFullYear(),r.getMonth(),r.getDate(),n[1]||0,n[3]||0,n[5]||0)/1e3)}if("now"===e)return null===t||isNaN(t)?(new Date).getTime()/1e3|0:0|t;if(!isNaN(i=Date.parse(e)))return i/1e3|0;if((n=e.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2})[ t]([0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]+)?)([\+-][0-9]{2}(:[0-9]{2})?|z)/))&&("z"==n[4]?n[4]="Z":n[4].match(/^([\+-][0-9]{2})$/)&&(n[4]=n[4]+":00"),!isNaN(i=Date.parse(n[1]+"T"+n[2]+n[4]))))return i/1e3|0;function u(e){var t=e.split(" "),i=t[0],n=t[1].substring(0,3),r=/\d+/.test(i),s=("last"===i?-1:1)*("ago"===t[2]?-1:1);if(r&&(s*=parseInt(i,10)),l.hasOwnProperty(n)&&!t[1].match(/^mon(day|\.)?$/i))return o["set"+l[n]](o["get"+l[n]]()+s);if("wee"===n)return o.setDate(o.getDate()+7*s);if("next"===i||"last"===i)!function(e,t,i){var n,r=a[t];void 0!==r&&(0==(n=r-o.getDay())?n=7*i:n>0&&"last"===e?n-=7:n<0&&"next"===e&&(n+=7),o.setDate(o.getDate()+n))}(i,n,s);else if(!r)return!1;return!0}if(o=t?new Date(1e3*t):new Date,a={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6},l={yea:"FullYear",mon:"Month",day:"Date",hou:"Hours",min:"Minutes",sec:"Seconds"},"([+-]?\\d+\\s"+(c="(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)")+"|(last|next)\\s"+c+")(\\sago)?",!(n=e.match(new RegExp("([+-]?\\d+\\s(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)|(last|next)\\s(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?))(\\sago)?","gi"))))return!1;for(p=0,h=n.length;p<h;p++)if(!u(n[p]))return!1;return o.getTime()/1e3},e.lib.is=function(e,t){var i=Object.prototype.toString.call(t).slice(8,-1);return null!=t&&i===e},e.lib.copy=function(e){var t,i={};for(t in e)i[t]=e[t];return i},e.lib.replaceAll=function(e,t,i){return e.split(t).join(i)},e.lib.chunkArray=function(t,i){var n=[],r=0,s=t.length;if(i<1||!e.lib.is("Array",t))return[];for(;r<s;)n.push(t.slice(r,r+=i));return n},e.lib.round=function(e,t,i){var n,r,s,o;if(t|=0,s=(e*=n=Math.pow(10,t))%1==.5*(o=e>0|-(e<0)),r=Math.floor(e),s)switch(i){case"PHP_ROUND_HALF_DOWN":e=r+(o<0);break;case"PHP_ROUND_HALF_EVEN":e=r+r%2*o;break;case"PHP_ROUND_HALF_ODD":e=r+!(r%2);break;default:e=r+(o>0)}return(s?e:Math.round(e))/n},e.lib.max=function(){var e,t,i,n=0,r=arguments,s=r.length,o=function(e){if("[object Array]"===Object.prototype.toString.call(e))return e;var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(e[i]);return t},a=function(e,t){var i=0,n=0,r=0,s=0,l=0;if(e===t)return 0;if("object"==typeof e){if("object"==typeof t){if(e=o(e),t=o(t),l=e.length,(s=t.length)>l)return 1;if(s<l)return-1;for(i=0,n=l;i<n;++i){if(1==(r=a(e[i],t[i])))return 1;if(-1==r)return-1}return 0}return-1}return"object"==typeof t?1:isNaN(t)&&!isNaN(e)?0==e?0:e<0?1:-1:isNaN(e)&&!isNaN(t)?0==t?0:t>0?1:-1:t==e?0:t>e?1:-1};if(0===s)throw new Error("At least one value should be passed to max()");if(1===s){if("object"!=typeof r[0])throw new Error("Wrong parameter count for max()");if(0===(e=o(r[0])).length)throw new Error("Array must contain at least one element for max()")}else e=r;for(t=e[0],n=1,i=e.length;n<i;++n)1==a(t,e[n])&&(t=e[n]);return t},e.lib.min=function(){var e,t,i,n=0,r=arguments,s=r.length,o=function(e){if("[object Array]"===Object.prototype.toString.call(e))return e;var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(e[i]);return t},a=function(e,t){var i=0,n=0,r=0,s=0,l=0;if(e===t)return 0;if("object"==typeof e){if("object"==typeof t){if(e=o(e),t=o(t),l=e.length,(s=t.length)>l)return 1;if(s<l)return-1;for(i=0,n=l;i<n;++i){if(1==(r=a(e[i],t[i])))return 1;if(-1==r)return-1}return 0}return-1}return"object"==typeof t?1:isNaN(t)&&!isNaN(e)?0==e?0:e<0?1:-1:isNaN(e)&&!isNaN(t)?0==t?0:t>0?1:-1:t==e?0:t>e?1:-1};if(0===s)throw new Error("At least one value should be passed to min()");if(1===s){if("object"!=typeof r[0])throw new Error("Wrong parameter count for min()");if(0===(e=o(r[0])).length)throw new Error("Array must contain at least one element for min()")}else e=r;for(t=e[0],n=1,i=e.length;n<i;++n)-1==a(t,e[n])&&(t=e[n]);return t},e}(Twig||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{});"undefined"!=typeof module&&module.declare?module.declare([],function(e,t,i){for(key in Twig.exports)Twig.exports.hasOwnProperty(key)&&(t[key]=Twig.exports[key])}):"function"==typeof define&&define.amd?define(function(){return Twig.exports}):"undefined"!=typeof module&&module.exports?module.exports=Twig.exports:(window.twig=Twig.exports.twig,window.Twig=Twig.exports),function(e,t){"function"==typeof define&&define.amd?define(["exports","backbone","underscore"],t):"undefined"!=typeof exports?t(exports,require("backbone"),require("underscore")):t(e,e.Backbone,e._)}(this,function(e,t,i){"use strict";t.Relational={showWarnings:!0},t.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},t.BlockingQueue=function(){this._queue=[]},i.extend(t.BlockingQueue.prototype,t.Semaphore,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){var e=this._queue;for(this._queue=[];e&&e.length;)e.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),t.Relational.eventQueue=new t.BlockingQueue,t.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[e]},i.extend(t.Store.prototype,t.Events,{initializeRelation:function(e,n,r){var s=i.isString(n.type)?t[n.type]||this.getObjectByName(n.type):n.type;if(s&&s.prototype instanceof t.Relation)new s(e,n,r);else t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",n)},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=i.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){i.find(this._subModels,function(t){return i.filter(t.subModels||[],function(i,n){var r=this.getObjectByName(i);if(e===r)return t.superModelType._subModels[n]=e,e._superModel=t.superModelType,e._subModelTypeValue=n,e._subModelTypeAttribute=t.superModelType.prototype.subModelTypeAttribute,!0},this).length},this)},addReverseRelation:function(e){!i.any(this._reverseRelations,function(t){return i.all(e||[],function(e,i){return e===t[i]})})&&e.model&&e.type&&(this._reverseRelations.push(e),this._addRelation(e.model,e),this.retroFitRelation(e))},addOrphanRelation:function(e){!i.any(this._orphanRelations,function(t){return i.all(e||[],function(e,i){return e===t[i]})})&&e.model&&e.type&&this._orphanRelations.push(e)},processOrphanRelations:function(){i.each(this._orphanRelations.slice(0),function(e){t.Relational.store.getObjectByName(e.relatedModel)&&(this.initializeRelation(null,e),this._orphanRelations=i.without(this._orphanRelations,e))},this)},_addRelation:function(e,t){e.prototype.relations||(e.prototype.relations=[]),e.prototype.relations.push(t),i.each(e._subModels||[],function(e){this._addRelation(e,t)},this)},retroFitRelation:function(e){var t=this.getCollection(e.model,!1);t&&t.each(function(t){if(t instanceof e.model)new e.type(t,e)},this)},getCollection:function(e,n){e instanceof t.RelationalModel&&(e=e.constructor);for(var r=e;r._superModel;)r=r._superModel;var s=i.find(this._collections,function(e){return e.model===r});return s||!1===n||(s=this._createCollection(r)),s},getObjectByName:function(e){var t=e.split("."),n=null;return i.find(this._modelScopes,function(e){if((n=i.reduce(t||[],function(e,t){return e?e[t]:void 0},e))&&n!==e)return!0},this),n},_createCollection:function(e){var i;return e instanceof t.RelationalModel&&(e=e.constructor),e.prototype instanceof t.RelationalModel&&((i=new t.Collection).model=e,this._collections.push(i)),i},resolveIdForItem:function(e,n){var r=i.isString(n)||i.isNumber(n)?n:null;return null===r&&(n instanceof t.RelationalModel?r=n.id:i.isObject(n)&&(r=n[e.prototype.idAttribute])),r||0===r||(r=null),r},find:function(e,t){var i=this.resolveIdForItem(e,t),n=this.getCollection(e);if(n){var r=n.get(i);if(r instanceof e)return r}return null},register:function(e){var t=this.getCollection(e);if(t){var i=e.collection;t.add(e),e.collection=i}},checkId:function(e,i){var n=this.getCollection(e),r=n&&n.get(i);if(r&&e!==r)throw t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",r,e),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(e){var t=this.getCollection(e);t.contains(e)||this.register(e),t._onModelEvent("change:"+e.idAttribute,e,t),e.trigger("relational:change:id",e,t)},unregister:function(e){var n,r;e instanceof t.Model?(n=this.getCollection(e),r=[e]):e instanceof t.Collection?(n=this.getCollection(e.model),r=i.clone(e.models)):(n=this.getCollection(e),r=i.clone(n.models)),i.each(r,function(e){this.stopListening(e),i.invoke(e.getRelations(),"stopListening")},this),i.contains(this._collections,e)?n.reset([]):i.each(r,function(e){n.get(e)?n.remove(e):n.trigger("relational:remove",e,n)},this)},reset:function(){this.stopListening(),i.each(this._collections,function(e){this.unregister(e)},this),this._collections=[],this._subModels=[],this._modelScopes=[e]}}),t.Relational.store=new t.Store,t.Relation=function(e,n,r){if(this.instance=e,n=i.isObject(n)?n:{},this.reverseRelation=i.defaults(n.reverseRelation||{},this.options.reverseRelation),this.options=i.defaults(n,this.options,t.Relation.prototype.options),this.reverseRelation.type=i.isString(this.reverseRelation.type)?t[this.reverseRelation.type]||t.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,i.isUndefined(this.relatedModel)&&(this.relatedModel=this.model),!i.isFunction(this.relatedModel)||this.relatedModel.prototype instanceof t.RelationalModel||(this.relatedModel=i.result(this,"relatedModel")),i.isString(this.relatedModel)&&(this.relatedModel=t.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&t.Relational.store.addReverseRelation(i.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),e)){var s=this.keySource;s!==this.key&&i.isObject(this.instance.get(this.key))&&(s=this.key),this.setKeyContents(this.instance.get(s)),this.relatedCollection=t.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(r),this.options.autoFetch&&this.instance.getAsync(this.key,i.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},t.Relation.extend=t.Model.extend,i.extend(t.Relation.prototype,t.Events,t.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var e=this.instance,n=this.key,r=this.model,s=this.relatedModel,o=t.Relational.showWarnings&&"undefined"!=typeof console;if(!r||!n||!s)return o&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,r,n,s),!1;if(!(r.prototype instanceof t.RelationalModel))return o&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,e),!1;if(!(s.prototype instanceof t.RelationalModel))return o&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,s),!1;if(this instanceof t.HasMany&&this.reverseRelation.type===t.HasMany)return o&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(e&&i.keys(e._relations).length){var a=i.find(e._relations,function(e){return e.key===n},this);if(a)return o&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,n,e,a),!1}return!0},setRelated:function(e){this.related=e,this.instance.attributes[this.key]=e},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){for(var t=[],n=i.isUndefined(e)?this.related&&(this.related.models||[this.related]):[e],r=null,s=null,o=0;o<(n||[]).length;o++){r=n[o].getRelations()||[];for(var a=0;a<r.length;a++)s=r[a],this._isReverseRelation(s)&&t.push(s)}return t},destroy:function(){this.stopListening(),this instanceof t.HasOne?this.setRelated(null):this instanceof t.HasMany&&this.setRelated(this._prepareCollection()),i.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),t.HasOne=t.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var t=this.findRelated(e);this.setRelated(t),i.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,e)},this)},findRelated:function(e){var t=null;if(e=i.defaults({parse:this.options.parse},e),this.keyContents instanceof this.relatedModel)t=this.keyContents;else if(this.keyContents||0===this.keyContents){var n=i.defaults({create:this.options.createModels},e);t=this.relatedModel.findOrCreate(this.keyContents,n)}return t&&(this.keyId=null),t},setKeyContents:function(e){this.keyContents=e,this.keyId=t.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,n,r){if(!this.isLocked()){this.acquire(),r=r?i.clone(r):{};var s=i.isUndefined(r.__related),o=s?this.related:r.__related;if(s){this.setKeyContents(n);var a=this.findRelated(r);this.setRelated(a)}if(o&&this.related!==o&&i.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,null,r)},this),i.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,r)},this),!r.silent&&this.related!==o){var l=this;this.changed=!0,t.Relational.eventQueue.add(function(){l.instance.trigger("change:"+l.key,l.instance,l.related,r,!0),l.changed=!1})}this.release()}},tryAddRelated:function(e,t,i){!this.keyId&&0!==this.keyId||e.id!==this.keyId||(this.addRelated(e,i),this.keyId=null)},addRelated:function(e,t){var n=this;e.queue(function(){if(e!==n.related){var r=n.related||null;n.setRelated(e),n.onChange(n.instance,e,i.defaults({__related:r},t))}})},removeRelated:function(e,t,n){if(this.related&&e===this.related){var r=this.related||null;this.setRelated(null),this.onChange(this.instance,e,i.defaults({__related:r},n))}}}),t.HasMany=t.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:t.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(e){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,!i.isFunction(this.collectionType)||this.collectionType===t.Collection||this.collectionType.prototype instanceof t.Collection||(this.collectionType=i.result(this,"collectionType")),i.isString(this.collectionType)&&(this.collectionType=t.Relational.store.getObjectByName(this.collectionType)),this.collectionType!==t.Collection&&!(this.collectionType.prototype instanceof t.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var n=this.findRelated(e);this.setRelated(n)},_prepareCollection:function(e){if(this.related&&this.stopListening(this.related),!(e&&e instanceof t.Collection)){var n=i.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;e=new this.collectionType(null,n)}if(e.model=this.relatedModel,this.options.collectionKey){var r=!0===this.options.collectionKey?this.options.reverseRelation.key:this.options.collectionKey;e[r]&&e[r]!==this.instance?t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,r,this.options.collectionKey):r&&(e[r]=this.instance)}return this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset),e},findRelated:function(e){var n=null;if(e=i.defaults({parse:this.options.parse},e),this.keyContents instanceof t.Collection)this._prepareCollection(this.keyContents),n=this.keyContents;else{var r=[];i.each(this.keyContents,function(t){var n=null;(n=t instanceof this.relatedModel?t:i.isObject(t)&&e.parse&&this.relatedModel.prototype.parse?this.relatedModel.prototype.parse(i.clone(t),e):t)&&r.push(n)},this),(n=this.related instanceof t.Collection?this.related:this._prepareCollection()).set(r,i.defaults({parse:!1},e))}return this.keyIds=i.difference(this.keyIds,i.pluck(n.models,"id")),n},setKeyContents:function(e){this.keyContents=e instanceof t.Collection?e:null,this.keyIds=[],this.keyContents||!e&&0!==e||(this.keyContents=i.isArray(e)?e:[e],i.each(this.keyContents,function(e){var i=t.Relational.store.resolveIdForItem(this.relatedModel,e);(i||0===i)&&this.keyIds.push(i)},this))},onChange:function(e,n,r){r=r?i.clone(r):{},this.setKeyContents(n),this.changed=!1;var s=this.findRelated(r);if(this.setRelated(s),!r.silent){var o=this;t.Relational.eventQueue.add(function(){o.changed&&(o.instance.trigger("change:"+o.key,o.instance,o.related,r,!0),o.changed=!1)})}},handleAddition:function(e,n,r){r=r?i.clone(r):{},this.changed=!0,i.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,r)},this);var s=this;!r.silent&&t.Relational.eventQueue.add(function(){s.instance.trigger("add:"+s.key,e,s.related,r)})},handleRemoval:function(e,n,r){r=r?i.clone(r):{},this.changed=!0,i.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,r)},this);var s=this;!r.silent&&t.Relational.eventQueue.add(function(){s.instance.trigger("remove:"+s.key,e,s.related,r)})},handleReset:function(e,n){var r=this;!(n=n?i.clone(n):{}).silent&&t.Relational.eventQueue.add(function(){r.instance.trigger("reset:"+r.key,r.related,n)})},tryAddRelated:function(e,t,n){i.contains(this.keyIds,e.id)&&(this.addRelated(e,n),this.keyIds=i.without(this.keyIds,e.id))},addRelated:function(e,t){var n=this;e.queue(function(){n.related&&!n.related.get(e)&&n.related.add(e,i.defaults({parse:!1},t))})},removeRelated:function(e,t,i){this.related.get(e)&&this.related.remove(e,i)}}),t.RelationalModel=t.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,n){if(n&&n.collection){var r=this,s=this.collection=n.collection;delete n.collection,this._deferProcessing=!0;var o=function(e){e===r&&(r._deferProcessing=!1,r.processQueue(),s.off("relational:add",o))};s.on("relational:add",o),i.defer(function(){o(r)})}t.Relational.store.processOrphanRelations(),t.Relational.store.listenTo(this,"relational:unregister",t.Relational.store.unregister),this._queue=new t.BlockingQueue,this._queue.block(),t.Relational.eventQueue.block();try{t.Model.apply(this,arguments)}finally{t.Relational.eventQueue.unblock()}},trigger:function(e){if(e.length>5&&0===e.indexOf("change")){var i=this,n=arguments;t.Relational.eventQueue.isBlocked()?t.Relational.eventQueue.add(function(){var r=!0;if("change"===e)r=i.hasChanged()||i._attributeChangeFired,i._attributeChangeFired=!1;else{var s=e.slice(7),o=i.getRelation(s);o?(r=!0===n[4])?i.changed[s]=n[2]:o.changed||delete i.changed[s]:r&&(i._attributeChangeFired=!0)}r&&t.Model.prototype.trigger.apply(i,n)}):t.Model.prototype.trigger.apply(i,n)}else"destroy"===e?(t.Model.prototype.trigger.apply(this,arguments),t.Relational.store.unregister(this)):t.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(e){this.acquire(),this._relations={},i.each(this.relations||[],function(i){t.Relational.store.initializeRelation(this,i,e)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(e,t){this._isInitialized&&!this.isLocked()&&i.each(this._relations,function(i){if(!e||i.keySource in e||i.key in e){var n=this.attributes[i.keySource]||this.attributes[i.key],r=e&&(e[i.keySource]||e[i.key]);(i.related!==n||null===n&&null===r)&&this.trigger("relational:change:"+i.key,this,n,t||{})}i.keySource!==i.key&&delete this.attributes[i.keySource]},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(e){return this._relations[e]},getRelations:function(){return i.values(this._relations)},getIdsToFetch:function(e,n){var r=e instanceof t.Relation?e:this.getRelation(e),s=r?r.keyIds&&r.keyIds.slice(0)||(r.keyId||0===r.keyId?[r.keyId]:[]):[];if(n){var o=r.related&&(r.related.models||[r.related]);i.each(o,function(e){(e.id||0===e.id)&&s.push(e.id)})}return s},getAsync:function(e,n){n=i.extend({add:!0,remove:!1,refresh:!1},n);var r=this,s=[],o=this.getRelation(e),a=o&&this.getIdsToFetch(o,n.refresh),l=o.related instanceof t.Collection?o.related:o.relatedCollection;if(a&&a.length){var h,c=[],p=[],u=function(){c=i.map(a,function(e){var t=o.relatedModel.findModel(e);if(!t){var i={};i[o.relatedModel.prototype.idAttribute]=e,t=o.relatedModel.findOrCreate(i,n),p.push(t)}return t},this)};if(l instanceof t.Collection&&i.isFunction(l.url)){var d=l.url();(h=l.url(a))===d&&(u(),(h=l.url(c))===d&&(h=null))}if(h){var f=i.defaults({error:function(){i.each(p,function(e){e.trigger("destroy",e,e.collection,n)}),n.error&&n.error.apply(c,arguments)},url:h},n);s=[l.fetch(f)]}else c.length||u(),s=i.map(c,function(e){var t=i.defaults({error:function(){i.contains(p,e)&&e.trigger("destroy",e,e.collection,n),n.error&&n.error.apply(c,arguments)}},n);return e.fetch(t)},this)}return this.deferArray(s).then(function(){return t.Model.prototype.get.call(r,e)})},deferArray:function(e){return t.$.when.apply(null,e)},set:function(e,n,r){var s,o;t.Relational.eventQueue.block(),i.isObject(e)||null==e?(s=e,r=n):(s={})[e]=n;try{var a=this.id,l=s&&this.idAttribute in s&&s[this.idAttribute];t.Relational.store.checkId(this,l),o=t.Model.prototype.set.apply(this,arguments),this._isInitialized||this.isLocked()?l&&l!==a&&t.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),(l||0===l)&&t.Relational.store.register(this),this.initializeRelations(r)),s&&this.updateRelations(s,r)}finally{t.Relational.eventQueue.unblock()}return o},clone:function(){var e=i.clone(this.attributes);return i.isUndefined(e[this.idAttribute])||(e[this.idAttribute]=null),i.each(this.getRelations(),function(t){delete e[t.key]}),new this.constructor(e)},toJSON:function(e){if(this.isLocked())return this.id;this.acquire();var n=t.Model.prototype.toJSON.call(this,e);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in n||(n[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),i.each(this._relations,function(r){var s=n[r.key],o=r.options.includeInJSON,a=null;!0===o?s&&i.isFunction(s.toJSON)&&(a=s.toJSON(e)):i.isString(o)?(s instanceof t.Collection?a=s.pluck(o):s instanceof t.Model&&(a=s.get(o)),o===r.relatedModel.prototype.idAttribute&&(r instanceof t.HasMany?a=a.concat(r.keyIds):r instanceof t.HasOne&&((a=a||r.keyId)||i.isObject(r.keyContents)||(a=r.keyContents||null)))):i.isArray(o)?s instanceof t.Collection?(a=[],s.each(function(e){var t={};i.each(o,function(i){t[i]=e.get(i)}),a.push(t)})):s instanceof t.Model&&(a={},i.each(o,function(e){a[e]=s.get(e)})):delete n[r.key],null===a&&e&&e.wait&&(a=s),o&&(n[r.keyDestination]=a),r.keyDestination!==r.key&&delete n[r.key]}),this.release(),n}},{setup:function(e){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?t.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,i.each(this.prototype.relations||[],function(e){if(e.model||(e.model=this),e.reverseRelation&&e.model===this){var n=!0;if(i.isString(e.relatedModel)){var r=t.Relational.store.getObjectByName(e.relatedModel);n=r&&r.prototype instanceof t.RelationalModel}n?t.Relational.store.initializeRelation(null,e):i.isString(e.relatedModel)&&t.Relational.store.addOrphanRelation(e)}},this),this},build:function(e,t){return this.initializeModelHierarchy(),new(this._findSubModelType(this,e)||this)(e,t)},_findSubModelType:function(e,t){if(e._subModels&&e.prototype.subModelTypeAttribute in t){var i=t[e.prototype.subModelTypeAttribute],n=e._subModels[i];if(n)return n;for(i in e._subModels)if(n=this._findSubModelType(e._subModels[i],t))return n}return null},initializeModelHierarchy:function(){if(this.inheritRelations(),this.prototype.subModelTypes){var e=i.keys(this._subModels),n=i.omit(this.prototype.subModelTypes,e);i.each(n,function(e){var i=t.Relational.store.getObjectByName(e);i&&i.initializeModelHierarchy()})}},inheritRelations:function(){if(i.isUndefined(this._superModel)||i.isNull(this._superModel))if(t.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.inheritRelations(),this._superModel.prototype.relations){var e=i.filter(this._superModel.prototype.relations||[],function(e){return!i.any(this.prototype.relations||[],function(t){return e.relatedModel===t.relatedModel&&e.key===t.key},this)},this);this.prototype.relations=e.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(e,t){t||(t={});var n=i.isObject(e)&&t.parse&&this.prototype.parse?this.prototype.parse(i.clone(e),t):e,r=this.findModel(n);return i.isObject(e)&&(r&&!1!==t.merge?(delete t.collection,delete t.url,r.set(n,t)):r||!1===t.create||(r=this.build(n,i.defaults({parse:!1},t)))),r},find:function(e,t){return t||(t={}),t.create=!1,this.findOrCreate(e,t)},findModel:function(e){return t.Relational.store.find(this,e)}}),i.extend(t.RelationalModel.prototype,t.Semaphore),t.Collection.prototype.__prepareModel=t.Collection.prototype._prepareModel,t.Collection.prototype._prepareModel=function(e,n){var r;return e instanceof t.Model?(e.collection||(e.collection=this),r=e):((n=n?i.clone(n):{}).collection=this,(r=void 0!==this.model.findOrCreate?this.model.findOrCreate(e,n):new this.model(e,n))&&r.validationError&&(this.trigger("invalid",this,e,n),r=!1)),r};var n=t.Collection.prototype.__set=t.Collection.prototype.set;t.Collection.prototype.set=function(e,r){if(!(this.model.prototype instanceof t.RelationalModel))return n.call(this,e,r);r&&r.parse&&(e=this.parse(e,r));var s=!i.isArray(e),o=[],a=[],l=null;e=s?e?[e]:[]:i.clone(e);for(var h=0;h<e.length;h++)(l=e[h])instanceof t.Model||(l=t.Collection.prototype._prepareModel.call(this,l,r)),l&&(a.push(l),this.get(l)||this.get(l.cid)?null!==l.id&&void 0!==l.id&&(this._byId[l.id]=l):o.push(l));a=s?a.length?a[0]:null:a;var c=n.call(this,a,i.defaults({merge:!1,parse:!1},r));for(h=0;h<o.length;h++)l=o[h],(this.get(l)||this.get(l.cid))&&this.trigger("relational:add",l,this,r);return c};var r=t.Collection.prototype.___removeModels=t.Collection.prototype._removeModels;t.Collection.prototype._removeModels=function(e,n){if(!(this.model.prototype instanceof t.RelationalModel))return r.call(this,e,n);var s=[];i.each(e,function(e){(e=this.get(e)||e&&this.get(e.cid))&&s.push(e)},this);var o=r.call(this,s,n);return i.each(s,function(e){this.trigger("relational:remove",e,this,n)},this),o};var s=t.Collection.prototype.__reset=t.Collection.prototype.reset;t.Collection.prototype.reset=function(e,n){n=i.extend({merge:!0},n);var r=s.call(this,e,n);return this.model.prototype instanceof t.RelationalModel&&this.trigger("relational:reset",this,n),r};var o=t.Collection.prototype.__sort=t.Collection.prototype.sort;t.Collection.prototype.sort=function(e){var i=o.call(this,e);return this.model.prototype instanceof t.RelationalModel&&this.trigger("relational:reset",this,e),i};var a=t.Collection.prototype.__trigger=t.Collection.prototype.trigger;t.Collection.prototype.trigger=function(e){if(!(this.model.prototype instanceof t.RelationalModel))return a.apply(this,arguments);if("add"===e||"remove"===e||"reset"===e||"sort"===e){var n=this,r=arguments;i.isObject(r[3])&&((r=i.toArray(r))[3]=i.clone(r[3])),t.Relational.eventQueue.add(function(){a.apply(n,r)})}else a.apply(this,arguments);return this},t.RelationalModel.extend=function(e,i){var n=t.Model.extend.call(this,e,i);return n.setup(this),n}}),function(e,t){if("function"==typeof define&&define.amd)define(["backbone","underscore"],function(i,n){return e.Marionette=e.Mn=t(e,i,n)});else if("undefined"!=typeof exports){var i=require("backbone"),n=require("underscore");module.exports=t(e,i,n)}else e.Marionette=e.Mn=t(e,e.Backbone,e._)}(this,function(e,t,i){"use strict";!function(e,t){var i=e.ChildViewContainer;e.ChildViewContainer=function(e,t){var i=function(e){this._views={},this._indexByModel={},this._indexByCustom={},this._updateLength(),t.each(e,this.add,this)};t.extend(i.prototype,{add:function(e,t){var i=e.cid;return this._views[i]=e,e.model&&(this._indexByModel[e.model.cid]=i),t&&(this._indexByCustom[t]=i),this._updateLength(),this},findByModel:function(e){return this.findByModelCid(e.cid)},findByModelCid:function(e){var t=this._indexByModel[e];return this.findByCid(t)},findByCustom:function(e){var t=this._indexByCustom[e];return this.findByCid(t)},findByIndex:function(e){return t.values(this._views)[e]},findByCid:function(e){return this._views[e]},remove:function(e){var i=e.cid;return e.model&&delete this._indexByModel[e.model.cid],t.any(this._indexByCustom,function(e,t){if(e===i)return delete this._indexByCustom[t],!0},this),delete this._views[i],this._updateLength(),this},call:function(e){this.apply(e,t.tail(arguments))},apply:function(e,i){t.each(this._views,function(n){t.isFunction(n[e])&&n[e].apply(n,i||[])})},_updateLength:function(){this.length=t.size(this._views)}});return t.each(["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck","reduce"],function(e){i.prototype[e]=function(){var i=[t.values(this._views)].concat(t.toArray(arguments));return t[e].apply(t,i)}}),i}(0,t),e.ChildViewContainer.VERSION="0.1.11",e.ChildViewContainer.noConflict=function(){return e.ChildViewContainer=i,this},e.ChildViewContainer}(t,i),function(e,t){var i,n,r=e.Wreqr,s=e.Wreqr={};e.Wreqr.VERSION="1.3.6",e.Wreqr.noConflict=function(){return e.Wreqr=r,this},s.Handlers=function(e,t){var i=function(e){this.options=e,this._wreqrHandlers={},t.isFunction(this.initialize)&&this.initialize(e)};return i.extend=e.Model.extend,t.extend(i.prototype,e.Events,{setHandlers:function(e){t.each(e,function(e,i){var n=null;t.isObject(e)&&!t.isFunction(e)&&(n=e.context,e=e.callback),this.setHandler(i,e,n)},this)},setHandler:function(e,t,i){var n={callback:t,context:i};this._wreqrHandlers[e]=n,this.trigger("handler:add",e,t,i)},hasHandler:function(e){return!!this._wreqrHandlers[e]},getHandler:function(e){var t=this._wreqrHandlers[e];if(t)return function(){return t.callback.apply(t.context,arguments)}},removeHandler:function(e){delete this._wreqrHandlers[e]},removeAllHandlers:function(){this._wreqrHandlers={}}}),i}(e,t),s.CommandStorage=(i=function(e){this.options=e,this._commands={},t.isFunction(this.initialize)&&this.initialize(e)},t.extend(i.prototype,e.Events,{getCommands:function(e){var t=this._commands[e];return t||(t={command:e,instances:[]},this._commands[e]=t),t},addCommand:function(e,t){this.getCommands(e).instances.push(t)},clearCommands:function(e){this.getCommands(e).instances=[]}}),i),s.Commands=function(e,t){return e.Handlers.extend({storageType:e.CommandStorage,constructor:function(t){this.options=t||{},this._initializeStorage(this.options),this.on("handler:add",this._executeCommands,this),e.Handlers.prototype.constructor.apply(this,arguments)},execute:function(e){e=arguments[0];var i=t.rest(arguments);this.hasHandler(e)?this.getHandler(e).apply(this,i):this.storage.addCommand(e,i)},_executeCommands:function(e,i,n){var r=this.storage.getCommands(e);t.each(r.instances,function(e){i.apply(n,e)}),this.storage.clearCommands(e)},_initializeStorage:function(e){var i,n=e.storageType||this.storageType;i=t.isFunction(n)?new n:n,this.storage=i}})}(s,t),s.RequestResponse=function(e,t){return e.Handlers.extend({request:function(e){if(this.hasHandler(e))return this.getHandler(e).apply(this,t.rest(arguments))}})}(s,t),s.EventAggregator=function(e,t){var i=function(){};return i.extend=e.Model.extend,t.extend(i.prototype,e.Events),i}(e,t),s.Channel=(n=function(t){this.vent=new e.Wreqr.EventAggregator,this.reqres=new e.Wreqr.RequestResponse,this.commands=new e.Wreqr.Commands,this.channelName=t},t.extend(n.prototype,{reset:function(){return this.vent.off(),this.vent.stopListening(),this.reqres.removeAllHandlers(),this.commands.removeAllHandlers(),this},connectEvents:function(e,t){return this._connect("vent",e,t),this},connectCommands:function(e,t){return this._connect("commands",e,t),this},connectRequests:function(e,t){return this._connect("reqres",e,t),this},_connect:function(e,i,n){if(i){n=n||this;var r="vent"===e?"on":"setHandler";t.each(i,function(i,s){this[e][r](s,t.bind(i,n))},this)}}}),n),s.radio=function(e,t){var i=function(){this._channels={},this.vent={},this.commands={},this.reqres={},this._proxyMethods()};t.extend(i.prototype,{channel:function(e){if(!e)throw new Error("Channel must receive a name");return this._getChannel(e)},_getChannel:function(t){var i=this._channels[t];return i||(i=new e.Channel(t),this._channels[t]=i),i},_proxyMethods:function(){t.each(["vent","commands","reqres"],function(e){t.each(n[e],function(t){this[e][t]=r(this,e,t)},this)},this)}});var n={vent:["on","off","trigger","once","stopListening","listenTo","listenToOnce"],commands:["execute","setHandler","setHandlers","removeHandler","removeAllHandlers"],reqres:["request","setHandler","setHandlers","removeHandler","removeAllHandlers"]},r=function(e,i,n){return function(r){var s=e._getChannel(r)[i];return s[n].apply(s,t.rest(arguments))}};return new i}(s,t),e.Wreqr}(t,i);var n=e.Marionette,r=e.Mn,s=t.Marionette={};s.VERSION="2.4.5",s.noConflict=function(){return e.Marionette=n,e.Mn=r,this},t.Marionette=s,s.Deferred=t.$.Deferred,s.extend=t.Model.extend,s.isNodeAttached=function(e){return t.$.contains(document.documentElement,e)},s.mergeOptions=function(e,t){e&&i.extend(this,i.pick(e,t))},s.getOption=function(e,t){if(e&&t)return e.options&&void 0!==e.options[t]?e.options[t]:e[t]},s.proxyGetOption=function(e){return s.getOption(this,e)},s._getValue=function(e,t,n){return i.isFunction(e)&&(e=n?e.apply(t,n):e.call(t)),e},s.normalizeMethods=function(e){return i.reduce(e,function(e,t,n){return i.isFunction(t)||(t=this[t]),t&&(e[n]=t),e},{},this)},s.normalizeUIString=function(e,t){return e.replace(/@ui\.[a-zA-Z-_$0-9]*/g,function(e){return t[e.slice(4)]})},s.normalizeUIKeys=function(e,t){return i.reduce(e,function(e,i,n){return e[s.normalizeUIString(n,t)]=i,e},{})},s.normalizeUIValues=function(e,t,n){return i.each(e,function(r,o){i.isString(r)?e[o]=s.normalizeUIString(r,t):i.isObject(r)&&i.isArray(n)&&(i.extend(r,s.normalizeUIValues(i.pick(r,n),t)),i.each(n,function(e){var n=r[e];i.isString(n)&&(r[e]=s.normalizeUIString(n,t))}))}),e},s.actAsCollection=function(e,t){i.each(["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck"],function(n){e[n]=function(){var e=[i.values(i.result(this,t))].concat(i.toArray(arguments));return i[n].apply(i,e)}})};var o=s.deprecate=function(e,t){i.isObject(e)&&(e=e.prev+" is going to be removed in the future. Please use "+e.next+" instead."+(e.url?" See: "+e.url:"")),void 0!==t&&t||o._cache[e]||(o._warn("Deprecation warning: "+e),o._cache[e]=!0)};o._console="undefined"!=typeof console?console:{},o._warn=function(){return(o._console.warn||o._console.log||function(){}).apply(o._console,arguments)},o._cache={},s._triggerMethod=function(){var e=/(^|:)(\w)/gi;function t(e,t,i){return i.toUpperCase()}return function(n,r,s){var o=arguments.length<3;o&&(r=(s=r)[0]);var a,l=n["on"+r.replace(e,t)];return i.isFunction(l)&&(a=l.apply(n,o?i.rest(s):s)),i.isFunction(n.trigger)&&(o+s.length>1?n.trigger.apply(n,o?s:[r].concat(i.drop(s,0))):n.trigger(r)),a}}(),s.triggerMethod=function(e){return s._triggerMethod(this,arguments)},s.triggerMethodOn=function(e){return(i.isFunction(e.triggerMethod)?e.triggerMethod:s.triggerMethod).apply(e,i.rest(arguments))},s.MonitorDOMRefresh=function(e){function t(){e._isShown&&e._isRendered&&s.isNodeAttached(e.el)&&s.triggerMethodOn(e,"dom:refresh",e)}e._isDomRefreshMonitored||(e._isDomRefreshMonitored=!0,e.on({show:function(){e._isShown=!0,t()},render:function(){e._isRendered=!0,t()}}))},function(e){function t(t,n,r,s){var o=s.split(/\s+/);i.each(o,function(i){var s=t[i];if(!s)throw new e.Error('Method "'+i+'" was configured as an event handler, but does not exist.');t.listenTo(n,r,s)})}function n(e,t,i,n){e.listenTo(t,i,n)}function r(e,t,n,r){var s=r.split(/\s+/);i.each(s,function(i){var r=e[i];e.stopListening(t,n,r)})}function s(e,t,i,n){e.stopListening(t,i,n)}function o(t,n,r,s,o){if(n&&r){if(!i.isObject(r))throw new e.Error({message:"Bindings must be an object or function.",url:"marionette.functions.html#marionettebindentityevents"});r=e._getValue(r,t),i.each(r,function(e,r){i.isFunction(e)?s(t,n,r,e):o(t,n,r,e)})}}e.bindEntityEvents=function(e,i,r){o(e,i,r,n,t)},e.unbindEntityEvents=function(e,t,i){o(e,t,i,s,r)},e.proxyBindEntityEvents=function(t,i){return e.bindEntityEvents(this,t,i)},e.proxyUnbindEntityEvents=function(t,i){return e.unbindEntityEvents(this,t,i)}}(s);var a=["description","fileName","lineNumber","name","message","number"];return s.Error=s.extend.call(Error,{urlRoot:"http://marionettejs.com/docs/v"+s.VERSION+"/",constructor:function(e,t){i.isObject(e)?e=(t=e).message:t||(t={});var n=Error.call(this,e);i.extend(this,i.pick(n,a),i.pick(t,a)),this.captureStackTrace(),t.url&&(this.url=this.urlRoot+t.url)},captureStackTrace:function(){Error.captureStackTrace&&Error.captureStackTrace(this,s.Error)},toString:function(){return this.name+": "+this.message+(this.url?" See: "+this.url:"")}}),s.Error.extend=s.extend,s.Callbacks=function(){this._deferred=s.Deferred(),this._callbacks=[]},i.extend(s.Callbacks.prototype,{add:function(e,t){var n=i.result(this._deferred,"promise");this._callbacks.push({cb:e,ctx:t}),n.then(function(i){t&&(i.context=t),e.call(i.context,i.options)})},run:function(e,t){this._deferred.resolve({options:e,context:t})},reset:function(){var e=this._callbacks;this._deferred=s.Deferred(),this._callbacks=[],i.each(e,function(e){this.add(e.cb,e.ctx)},this)}}),s.Controller=function(e){this.options=e||{},i.isFunction(this.initialize)&&this.initialize(this.options)},s.Controller.extend=s.extend,i.extend(s.Controller.prototype,t.Events,{destroy:function(){return s._triggerMethod(this,"before:destroy",arguments),s._triggerMethod(this,"destroy",arguments),this.stopListening(),this.off(),this},triggerMethod:s.triggerMethod,mergeOptions:s.mergeOptions,getOption:s.proxyGetOption}),s.Object=function(e){this.options=i.extend({},i.result(this,"options"),e),this.initialize.apply(this,arguments)},s.Object.extend=s.extend,i.extend(s.Object.prototype,t.Events,{initialize:function(){},destroy:function(e){return e=e||{},this.triggerMethod("before:destroy",e),this.triggerMethod("destroy",e),this.stopListening(),this},triggerMethod:s.triggerMethod,mergeOptions:s.mergeOptions,getOption:s.proxyGetOption,bindEntityEvents:s.proxyBindEntityEvents,unbindEntityEvents:s.proxyUnbindEntityEvents}),s.Region=s.Object.extend({constructor:function(e){if(this.options=e||{},this._initEl=this.el=this.getOption("el"),this.el=this.el instanceof t.$?this.el[0]:this.el,!this.el)throw new s.Error({name:"NoElError",message:'An "el" must be specified for a region.'});this.$el=this.getEl(this.el),s.Object.call(this,e)},show:function(e,t){if(this._ensureElement()){this._ensureViewIsIntact(e),s.MonitorDOMRefresh(e);var n=t||{},r=e!==this.currentView,o=!!n.preventDestroy,a=!!n.forceShow,l=!!this.currentView,h=r&&!o,c=r||a;if(l&&this.triggerMethod("before:swapOut",this.currentView,this,t),this.currentView&&r&&delete this.currentView._parent,h?this.empty():l&&c&&this.currentView.off("destroy",this.empty,this),c){e.once("destroy",this.empty,this),e._parent=this,this._renderView(e),l&&this.triggerMethod("before:swap",e,this,t),this.triggerMethod("before:show",e,this,t),s.triggerMethodOn(e,"before:show",e,this,t),l&&this.triggerMethod("swapOut",this.currentView,this,t);var p=s.isNodeAttached(this.el),u=[],d=i.extend({triggerBeforeAttach:this.triggerBeforeAttach,triggerAttach:this.triggerAttach},n);return p&&d.triggerBeforeAttach&&(u=this._displayedViews(e),this._triggerAttach(u,"before:")),this.attachHtml(e),this.currentView=e,p&&d.triggerAttach&&(u=this._displayedViews(e),this._triggerAttach(u)),l&&this.triggerMethod("swap",e,this,t),this.triggerMethod("show",e,this,t),s.triggerMethodOn(e,"show",e,this,t),this}return this}},triggerBeforeAttach:!0,triggerAttach:!0,_triggerAttach:function(e,t){var n=(t||"")+"attach";i.each(e,function(e){s.triggerMethodOn(e,n,e,this)},this)},_displayedViews:function(e){return i.union([e],i.result(e,"_getNestedViews")||[])},_renderView:function(e){e.supportsRenderLifecycle||s.triggerMethodOn(e,"before:render",e),e.render(),e.supportsRenderLifecycle||s.triggerMethodOn(e,"render",e)},_ensureElement:function(){if(i.isObject(this.el)||(this.$el=this.getEl(this.el),this.el=this.$el[0]),!this.$el||0===this.$el.length){if(this.getOption("allowMissingEl"))return!1;throw new s.Error('An "el" '+this.$el.selector+" must exist in DOM")}return!0},_ensureViewIsIntact:function(e){if(!e)throw new s.Error({name:"ViewNotValid",message:"The view passed is undefined and therefore invalid. You must pass a view instance to show."});if(e.isDestroyed)throw new s.Error({name:"ViewDestroyedError",message:'View (cid: "'+e.cid+'") has already been destroyed and cannot be used.'})},getEl:function(e){return t.$(e,s._getValue(this.options.parentEl,this))},attachHtml:function(e){this.$el.contents().detach(),this.el.appendChild(e.el)},empty:function(e){var t=this.currentView,i=!!(e||{}).preventDestroy;return t?(t.off("destroy",this.empty,this),this.triggerMethod("before:empty",t),i||this._destroyView(),this.triggerMethod("empty",t),delete this.currentView,i&&this.$el.contents().detach(),this):this},_destroyView:function(){var e=this.currentView;e.isDestroyed||(e.supportsDestroyLifecycle||s.triggerMethodOn(e,"before:destroy",e),e.destroy?e.destroy():(e.remove(),e.isDestroyed=!0),e.supportsDestroyLifecycle||s.triggerMethodOn(e,"destroy",e))},attachView:function(e){return this.currentView&&delete this.currentView._parent,e._parent=this,this.currentView=e,this},hasView:function(){return!!this.currentView},reset:function(){return this.empty(),this.$el&&(this.el=this._initEl),delete this.$el,this}},{buildRegion:function(e,t){if(i.isString(e))return this._buildRegionFromSelector(e,t);if(e.selector||e.el||e.regionClass)return this._buildRegionFromObject(e,t);if(i.isFunction(e))return this._buildRegionFromRegionClass(e);throw new s.Error({message:"Improper region configuration type.",url:"marionette.region.html#region-configuration-types"})},_buildRegionFromSelector:function(e,t){return new t({el:e})},_buildRegionFromObject:function(e,t){var n=e.regionClass||t,r=i.omit(e,"selector","regionClass");return e.selector&&!r.el&&(r.el=e.selector),new n(r)},_buildRegionFromRegionClass:function(e){return new e}}),s.RegionManager=s.Controller.extend({constructor:function(e){this._regions={},this.length=0,s.Controller.call(this,e),this.addRegions(this.getOption("regions"))},addRegions:function(e,t){return e=s._getValue(e,this,arguments),i.reduce(e,function(e,n,r){return i.isString(n)&&(n={selector:n}),n.selector&&(n=i.defaults({},n,t)),e[r]=this.addRegion(r,n),e},{},this)},addRegion:function(e,t){var i;return i=t instanceof s.Region?t:s.Region.buildRegion(t,s.Region),this.triggerMethod("before:add:region",e,i),i._parent=this,this._store(e,i),this.triggerMethod("add:region",e,i),i},get:function(e){return this._regions[e]},getRegions:function(){return i.clone(this._regions)},removeRegion:function(e){var t=this._regions[e];return this._remove(e,t),t},removeRegions:function(){var e=this.getRegions();return i.each(this._regions,function(e,t){this._remove(t,e)},this),e},emptyRegions:function(){var e=this.getRegions();return i.invoke(e,"empty"),e},destroy:function(){return this.removeRegions(),s.Controller.prototype.destroy.apply(this,arguments)},_store:function(e,t){this._regions[e]||this.length++,this._regions[e]=t},_remove:function(e,t){this.triggerMethod("before:remove:region",e,t),t.empty(),t.stopListening(),delete t._parent,delete this._regions[e],this.length--,this.triggerMethod("remove:region",e,t)}}),s.actAsCollection(s.RegionManager.prototype,"_regions"),s.TemplateCache=function(e){this.templateId=e},i.extend(s.TemplateCache,{templateCaches:{},get:function(e,t){var i=this.templateCaches[e];return i||(i=new s.TemplateCache(e),this.templateCaches[e]=i),i.load(t)},clear:function(){var e,t=i.toArray(arguments),n=t.length;if(n>0)for(e=0;e<n;e++)delete this.templateCaches[t[e]];else this.templateCaches={}}}),i.extend(s.TemplateCache.prototype,{load:function(e){if(this.compiledTemplate)return this.compiledTemplate;var t=this.loadTemplate(this.templateId,e);return this.compiledTemplate=this.compileTemplate(t,e),this.compiledTemplate},loadTemplate:function(e,i){var n=t.$(e);if(!n.length)throw new s.Error({name:"NoTemplateError",message:'Could not find template: "'+e+'"'});return n.html()},compileTemplate:function(e,t){return i.template(e,t)}}),s.Renderer={render:function(e,t){if(!e)throw new s.Error({name:"TemplateNotFoundError",message:"Cannot render the template since its false, null or undefined."});return(i.isFunction(e)?e:s.TemplateCache.get(e))(t)}},s.View=t.View.extend({isDestroyed:!1,supportsRenderLifecycle:!0,supportsDestroyLifecycle:!0,constructor:function(e){this.render=i.bind(this.render,this),e=s._getValue(e,this),this.options=i.extend({},i.result(this,"options"),e),this._behaviors=s.Behaviors(this),t.View.call(this,this.options),s.MonitorDOMRefresh(this)},getTemplate:function(){return this.getOption("template")},serializeModel:function(e){return e.toJSON.apply(e,i.rest(arguments))},mixinTemplateHelpers:function(e){e=e||{};var t=this.getOption("templateHelpers");return t=s._getValue(t,this),i.extend(e,t)},normalizeUIKeys:function(e){var t=i.result(this,"_uiBindings");return s.normalizeUIKeys(e,t||i.result(this,"ui"))},normalizeUIValues:function(e,t){var n=i.result(this,"ui"),r=i.result(this,"_uiBindings");return s.normalizeUIValues(e,r||n,t)},configureTriggers:function(){if(this.triggers){var e=this.normalizeUIKeys(i.result(this,"triggers"));return i.reduce(e,function(e,t,i){return e[i]=this._buildViewTrigger(t),e},{},this)}},delegateEvents:function(e){return this._delegateDOMEvents(e),this.bindEntityEvents(this.model,this.getOption("modelEvents")),this.bindEntityEvents(this.collection,this.getOption("collectionEvents")),i.each(this._behaviors,function(e){e.bindEntityEvents(this.model,e.getOption("modelEvents")),e.bindEntityEvents(this.collection,e.getOption("collectionEvents"))},this),this},_delegateDOMEvents:function(e){var n=s._getValue(e||this.events,this);n=this.normalizeUIKeys(n),i.isUndefined(e)&&(this.events=n);var r={},o=i.result(this,"behaviorEvents")||{},a=this.configureTriggers(),l=i.result(this,"behaviorTriggers")||{};i.extend(r,o,n,a,l),t.View.prototype.delegateEvents.call(this,r)},undelegateEvents:function(){return t.View.prototype.undelegateEvents.apply(this,arguments),this.unbindEntityEvents(this.model,this.getOption("modelEvents")),this.unbindEntityEvents(this.collection,this.getOption("collectionEvents")),i.each(this._behaviors,function(e){e.unbindEntityEvents(this.model,e.getOption("modelEvents")),e.unbindEntityEvents(this.collection,e.getOption("collectionEvents"))},this),this},_ensureViewIsIntact:function(){if(this.isDestroyed)throw new s.Error({name:"ViewDestroyedError",message:'View (cid: "'+this.cid+'") has already been destroyed and cannot be used.'})},destroy:function(){if(this.isDestroyed)return this;var e=i.toArray(arguments);return this.triggerMethod.apply(this,["before:destroy"].concat(e)),this.isDestroyed=!0,this.triggerMethod.apply(this,["destroy"].concat(e)),this.unbindUIElements(),this.isRendered=!1,this.remove(),i.invoke(this._behaviors,"destroy",e),this},bindUIElements:function(){this._bindUIElements(),i.invoke(this._behaviors,this._bindUIElements)},_bindUIElements:function(){if(this.ui){this._uiBindings||(this._uiBindings=this.ui);var e=i.result(this,"_uiBindings");this.ui={},i.each(e,function(e,t){this.ui[t]=this.$(e)},this)}},unbindUIElements:function(){this._unbindUIElements(),i.invoke(this._behaviors,this._unbindUIElements)},_unbindUIElements:function(){this.ui&&this._uiBindings&&(i.each(this.ui,function(e,t){delete this.ui[t]},this),this.ui=this._uiBindings,delete this._uiBindings)},_buildViewTrigger:function(e){var t=i.defaults({},e,{preventDefault:!0,stopPropagation:!0}),n=i.isObject(e)?t.event:e;return function(e){e&&(e.preventDefault&&t.preventDefault&&e.preventDefault(),e.stopPropagation&&t.stopPropagation&&e.stopPropagation());var i={view:this,model:this.model,collection:this.collection};this.triggerMethod(n,i)}},setElement:function(){var e=t.View.prototype.setElement.apply(this,arguments);return i.invoke(this._behaviors,"proxyViewProperties",this),e},triggerMethod:function(){var e=s._triggerMethod(this,arguments);return this._triggerEventOnBehaviors(arguments),this._triggerEventOnParentLayout(arguments[0],i.rest(arguments)),e},_triggerEventOnBehaviors:function(e){for(var t=s._triggerMethod,i=this._behaviors,n=0,r=i&&i.length;n<r;n++)t(i[n],e)},_triggerEventOnParentLayout:function(e,t){var n=this._parentLayoutView();if(n){var r=s.getOption(n,"childViewEventPrefix")+":"+e,o=[this].concat(t);s._triggerMethod(n,r,o);var a=s.getOption(n,"childEvents");a=s._getValue(a,n);var l=n.normalizeMethods(a);l&&i.isFunction(l[e])&&l[e].apply(n,o)}},_getImmediateChildren:function(){return[]},_getNestedViews:function(){var e=this._getImmediateChildren();return e.length?i.reduce(e,function(e,t){return t._getNestedViews?e.concat(t._getNestedViews()):e},e):e},_parentLayoutView:function(){for(var e=this._parent;e;){if(e instanceof s.LayoutView)return e;e=e._parent}},normalizeMethods:s.normalizeMethods,mergeOptions:s.mergeOptions,getOption:s.proxyGetOption,bindEntityEvents:s.proxyBindEntityEvents,unbindEntityEvents:s.proxyUnbindEntityEvents}),s.ItemView=s.View.extend({constructor:function(){s.View.apply(this,arguments)},serializeData:function(){if(!this.model&&!this.collection)return{};var e=[this.model||this.collection];return arguments.length&&e.push.apply(e,arguments),this.model?this.serializeModel.apply(this,e):{items:this.serializeCollection.apply(this,e)}},serializeCollection:function(e){return e.toJSON.apply(e,i.rest(arguments))},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderTemplate(),this.isRendered=!0,this.bindUIElements(),this.triggerMethod("render",this),this},_renderTemplate:function(){var e=this.getTemplate();if(!1!==e){if(!e)throw new s.Error({name:"UndefinedTemplateError",message:"Cannot render the template since it is null or undefined."});var t=this.mixinTemplateHelpers(this.serializeData()),i=s.Renderer.render(e,t,this);return this.attachElContent(i),this}},attachElContent:function(e){return this.$el.html(e),this}}),s.CollectionView=s.View.extend({childViewEventPrefix:"childview",sort:!0,constructor:function(e){this.once("render",this._initialEvents),this._initChildViewStorage(),s.View.apply(this,arguments),this.on({"before:show":this._onBeforeShowCalled,show:this._onShowCalled,"before:attach":this._onBeforeAttachCalled,attach:this._onAttachCalled}),this.initRenderBuffer()},initRenderBuffer:function(){this._bufferedChildren=[]},startBuffering:function(){this.initRenderBuffer(),this.isBuffering=!0},endBuffering:function(){var e,t=this._isShown&&s.isNodeAttached(this.el);this.isBuffering=!1,this._isShown&&this._triggerMethodMany(this._bufferedChildren,this,"before:show"),t&&this._triggerBeforeAttach&&(e=this._getNestedViews(),this._triggerMethodMany(e,this,"before:attach")),this.attachBuffer(this,this._createBuffer()),t&&this._triggerAttach&&(e=this._getNestedViews(),this._triggerMethodMany(e,this,"attach")),this._isShown&&this._triggerMethodMany(this._bufferedChildren,this,"show"),this.initRenderBuffer()},_triggerMethodMany:function(e,t,n){var r=i.drop(arguments,3);i.each(e,function(e){s.triggerMethodOn.apply(e,[e,n,e,t].concat(r))})},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this.render),this.getOption("sort")&&this.listenTo(this.collection,"sort",this._sortViews))},_onCollectionAdd:function(e,t,n){var r=void 0!==n.at&&(n.index||t.indexOf(e));if((this.getOption("filter")||!1===r)&&(r=i.indexOf(this._filteredSortedModels(r),e)),this._shouldAddChild(e,r)){this.destroyEmptyView();var s=this.getChildView(e);this.addChild(e,s,r)}},_onCollectionRemove:function(e){var t=this.children.findByModel(e);this.removeChildView(t),this.checkEmpty()},_onBeforeShowCalled:function(){this._triggerBeforeAttach=this._triggerAttach=!1,this.children.each(function(e){s.triggerMethodOn(e,"before:show",e)})},_onShowCalled:function(){this.children.each(function(e){s.triggerMethodOn(e,"show",e)})},_onBeforeAttachCalled:function(){this._triggerBeforeAttach=!0},_onAttachCalled:function(){this._triggerAttach=!0},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderChildren(),this.isRendered=!0,this.triggerMethod("render",this),this},reorder:function(){var e=this.children,t=this._filteredSortedModels();if(i.some(t,function(t){return!e.findByModel(t)}))this.render();else{var n=i.map(t,function(t,i){var n=e.findByModel(t);return n._index=i,n.el}),r=e.filter(function(e){return!i.contains(n,e.el)});this.triggerMethod("before:reorder"),this._appendReorderedChildren(n),i.each(r,this.removeChildView,this),this.checkEmpty(),this.triggerMethod("reorder")}},resortView:function(){s.getOption(this,"reorderOnSort")?this.reorder():this.render()},_sortViews:function(){var e=this._filteredSortedModels();i.find(e,function(e,t){var i=this.children.findByModel(e);return!i||i._index!==t},this)&&this.resortView()},_emptyViewIndex:-1,_appendReorderedChildren:function(e){this.$el.append(e)},_renderChildren:function(){this.destroyEmptyView(),this.destroyChildren({checkEmpty:!1}),this.isEmpty(this.collection)?this.showEmptyView():(this.triggerMethod("before:render:collection",this),this.startBuffering(),this.showCollection(),this.endBuffering(),this.triggerMethod("render:collection",this),this.children.isEmpty()&&this.getOption("filter")&&this.showEmptyView())},showCollection:function(){var e,t=this._filteredSortedModels();i.each(t,function(t,i){e=this.getChildView(t),this.addChild(t,e,i)},this)},_filteredSortedModels:function(e){var t,n=this.getViewComparator(),r=this.collection.models;(e=Math.min(Math.max(e,0),r.length-1),n)&&(e&&(t=r[e],r=r.slice(0,e).concat(r.slice(e+1))),r=this._sortModelsBy(r,n),t&&r.splice(e,0,t));return this.getOption("filter")&&(r=i.filter(r,function(e,t){return this._shouldAddChild(e,t)},this)),r},_sortModelsBy:function(e,t){return"string"==typeof t?i.sortBy(e,function(e){return e.get(t)},this):1===t.length?i.sortBy(e,t,this):e.sort(i.bind(t,this))},showEmptyView:function(){var e=this.getEmptyView();if(e&&!this._showingEmptyView){this.triggerMethod("before:render:empty"),this._showingEmptyView=!0;var i=new t.Model;this.addEmptyView(i,e),this.triggerMethod("render:empty")}},destroyEmptyView:function(){this._showingEmptyView&&(this.triggerMethod("before:remove:empty"),this.destroyChildren(),delete this._showingEmptyView,this.triggerMethod("remove:empty"))},getEmptyView:function(){return this.getOption("emptyView")},addEmptyView:function(e,t){var n,r=this._isShown&&!this.isBuffering&&s.isNodeAttached(this.el),o=this.getOption("emptyViewOptions")||this.getOption("childViewOptions");i.isFunction(o)&&(o=o.call(this,e,this._emptyViewIndex));var a=this.buildChildView(e,t,o);a._parent=this,this.proxyChildEvents(a),a.once("render",function(){this._isShown&&s.triggerMethodOn(a,"before:show",a),r&&this._triggerBeforeAttach&&(n=this._getViewAndNested(a),this._triggerMethodMany(n,this,"before:attach"))},this),this.children.add(a),this.renderChildView(a,this._emptyViewIndex),r&&this._triggerAttach&&(n=this._getViewAndNested(a),this._triggerMethodMany(n,this,"attach")),this._isShown&&s.triggerMethodOn(a,"show",a)},getChildView:function(e){var t=this.getOption("childView");if(!t)throw new s.Error({name:"NoChildViewError",message:'A "childView" must be specified'});return t},addChild:function(e,t,i){var n=this.getOption("childViewOptions");n=s._getValue(n,this,[e,i]);var r=this.buildChildView(e,t,n);return this._updateIndices(r,!0,i),this.triggerMethod("before:add:child",r),this._addChildView(r,i),this.triggerMethod("add:child",r),r._parent=this,r},_updateIndices:function(e,t,i){this.getOption("sort")&&(t&&(e._index=i),this.children.each(function(i){i._index>=e._index&&(i._index+=t?1:-1)}))},_addChildView:function(e,t){var i,n=this._isShown&&!this.isBuffering&&s.isNodeAttached(this.el);this.proxyChildEvents(e),e.once("render",function(){this._isShown&&!this.isBuffering&&s.triggerMethodOn(e,"before:show",e),n&&this._triggerBeforeAttach&&(i=this._getViewAndNested(e),this._triggerMethodMany(i,this,"before:attach"))},this),this.children.add(e),this.renderChildView(e,t),n&&this._triggerAttach&&(i=this._getViewAndNested(e),this._triggerMethodMany(i,this,"attach")),this._isShown&&!this.isBuffering&&s.triggerMethodOn(e,"show",e)},renderChildView:function(e,t){return e.supportsRenderLifecycle||s.triggerMethodOn(e,"before:render",e),e.render(),e.supportsRenderLifecycle||s.triggerMethodOn(e,"render",e),this.attachHtml(this,e,t),e},buildChildView:function(e,t,n){var r=new t(i.extend({model:e},n));return s.MonitorDOMRefresh(r),r},removeChildView:function(e){return e?(this.triggerMethod("before:remove:child",e),e.supportsDestroyLifecycle||s.triggerMethodOn(e,"before:destroy",e),e.destroy?e.destroy():e.remove(),e.supportsDestroyLifecycle||s.triggerMethodOn(e,"destroy",e),delete e._parent,this.stopListening(e),this.children.remove(e),this.triggerMethod("remove:child",e),this._updateIndices(e,!1),e):e},isEmpty:function(){return!this.collection||0===this.collection.length},checkEmpty:function(){this.isEmpty(this.collection)&&this.showEmptyView()},attachBuffer:function(e,t){e.$el.append(t)},_createBuffer:function(){var e=document.createDocumentFragment();return i.each(this._bufferedChildren,function(t){e.appendChild(t.el)}),e},attachHtml:function(e,t,i){e.isBuffering?e._bufferedChildren.splice(i,0,t):e._insertBefore(t,i)||e._insertAfter(t)},_insertBefore:function(e,t){var i;return this.getOption("sort")&&t<this.children.length-1&&(i=this.children.find(function(e){return e._index===t+1})),!!i&&(i.$el.before(e.el),!0)},_insertAfter:function(e){this.$el.append(e.el)},_initChildViewStorage:function(){this.children=new t.ChildViewContainer},destroy:function(){return this.isDestroyed?this:(this.triggerMethod("before:destroy:collection"),this.destroyChildren({checkEmpty:!1}),this.triggerMethod("destroy:collection"),s.View.prototype.destroy.apply(this,arguments))},destroyChildren:function(e){var t=e||{},n=!0,r=this.children.map(i.identity);return i.isUndefined(t.checkEmpty)||(n=t.checkEmpty),this.children.each(this.removeChildView,this),n&&this.checkEmpty(),r},_shouldAddChild:function(e,t){var n=this.getOption("filter");return!i.isFunction(n)||n.call(this,e,t,this.collection)},proxyChildEvents:function(e){var t=this.getOption("childViewEventPrefix");this.listenTo(e,"all",function(){var n=i.toArray(arguments),r=n[0],s=this.normalizeMethods(i.result(this,"childEvents"));n[0]=t+":"+r,n.splice(1,0,e),void 0!==s&&i.isFunction(s[r])&&s[r].apply(this,n.slice(1)),this.triggerMethod.apply(this,n)})},_getImmediateChildren:function(){return i.values(this.children._views)},_getViewAndNested:function(e){return[e].concat(i.result(e,"_getNestedViews")||[])},getViewComparator:function(){return this.getOption("viewComparator")}}),s.CompositeView=s.CollectionView.extend({constructor:function(){s.CollectionView.apply(this,arguments)},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this._renderChildren),this.getOption("sort")&&this.listenTo(this.collection,"sort",this._sortViews))},getChildView:function(e){return this.getOption("childView")||this.constructor},serializeData:function(){var e={};return this.model&&(e=i.partial(this.serializeModel,this.model).apply(this,arguments)),e},render:function(){return this._ensureViewIsIntact(),this._isRendering=!0,this.resetChildViewContainer(),this.triggerMethod("before:render",this),this._renderTemplate(),this._renderChildren(),this._isRendering=!1,this.isRendered=!0,this.triggerMethod("render",this),this},_renderChildren:function(){(this.isRendered||this._isRendering)&&s.CollectionView.prototype._renderChildren.call(this)},_renderTemplate:function(){var e={};e=this.serializeData(),e=this.mixinTemplateHelpers(e),this.triggerMethod("before:render:template");var t=this.getTemplate(),i=s.Renderer.render(t,e,this);this.attachElContent(i),this.bindUIElements(),this.triggerMethod("render:template")},attachElContent:function(e){return this.$el.html(e),this},attachBuffer:function(e,t){this.getChildViewContainer(e).append(t)},_insertAfter:function(e){this.getChildViewContainer(this,e).append(e.el)},_appendReorderedChildren:function(e){this.getChildViewContainer(this).append(e)},getChildViewContainer:function(e,t){if(e.$childViewContainer)return e.$childViewContainer;var i,n=s.getOption(e,"childViewContainer");if(n){var r=s._getValue(n,e);if((i="@"===r.charAt(0)&&e.ui?e.ui[r.substr(4)]:e.$(r)).length<=0)throw new s.Error({name:"ChildViewContainerMissingError",message:'The specified "childViewContainer" was not found: '+e.childViewContainer})}else i=e.$el;return e.$childViewContainer=i,i},resetChildViewContainer:function(){this.$childViewContainer&&(this.$childViewContainer=void 0)}}),s.LayoutView=s.ItemView.extend({regionClass:s.Region,options:{destroyImmediate:!1},childViewEventPrefix:"childview",constructor:function(e){e=e||{},this._firstRender=!0,this._initializeRegions(e),s.ItemView.call(this,e)},render:function(){return this._ensureViewIsIntact(),this._firstRender?this._firstRender=!1:this._reInitializeRegions(),s.ItemView.prototype.render.apply(this,arguments)},destroy:function(){return this.isDestroyed?this:(!0===this.getOption("destroyImmediate")&&this.$el.remove(),this.regionManager.destroy(),s.ItemView.prototype.destroy.apply(this,arguments))},showChildView:function(e,t,n){var r=this.getRegion(e);return r.show.apply(r,i.rest(arguments))},getChildView:function(e){return this.getRegion(e).currentView},addRegion:function(e,t){var i={};return i[e]=t,this._buildRegions(i)[e]},addRegions:function(e){return this.regions=i.extend({},this.regions,e),this._buildRegions(e)},removeRegion:function(e){return delete this.regions[e],this.regionManager.removeRegion(e)},getRegion:function(e){return this.regionManager.get(e)},getRegions:function(){return this.regionManager.getRegions()},_buildRegions:function(e){var t={regionClass:this.getOption("regionClass"),parentEl:i.partial(i.result,this,"el")};return this.regionManager.addRegions(e,t)},_initializeRegions:function(e){var t;this._initRegionManager(),t=s._getValue(this.regions,this,[e])||{};var n=this.getOption.call(e,"regions");n=s._getValue(n,this,[e]),i.extend(t,n),t=this.normalizeUIValues(t,["selector","el"]),this.addRegions(t)},_reInitializeRegions:function(){this.regionManager.invoke("reset")},getRegionManager:function(){return new s.RegionManager},_initRegionManager:function(){this.regionManager=this.getRegionManager(),this.regionManager._parent=this,this.listenTo(this.regionManager,"before:add:region",function(e){this.triggerMethod("before:add:region",e)}),this.listenTo(this.regionManager,"add:region",function(e,t){this[e]=t,this.triggerMethod("add:region",e,t)}),this.listenTo(this.regionManager,"before:remove:region",function(e){this.triggerMethod("before:remove:region",e)}),this.listenTo(this.regionManager,"remove:region",function(e,t){delete this[e],this.triggerMethod("remove:region",e,t)})},_getImmediateChildren:function(){return i.chain(this.regionManager.getRegions()).pluck("currentView").compact().value()}}),s.Behavior=s.Object.extend({constructor:function(e,t){this.view=t,this.defaults=i.result(this,"defaults")||{},this.options=i.extend({},this.defaults,e),this.ui=i.extend({},i.result(t,"ui"),i.result(this,"ui")),s.Object.apply(this,arguments)},$:function(){return this.view.$.apply(this.view,arguments)},destroy:function(){return this.stopListening(),this},proxyViewProperties:function(e){this.$el=e.$el,this.el=e.el}}),s.Behaviors=function(e,t){var i=/^(\S+)\s*(.*)$/;function n(e,i){return t.isObject(e.behaviors)?(i=n.parseBehaviors(e,i||t.result(e,"behaviors")),n.wrap(e,i,t.keys(r)),i):{}}var r={behaviorTriggers:function(e,t){return new s(this,t).buildBehaviorTriggers()},behaviorEvents:function(n,r){var s={};return t.each(r,function(n,r){var a={},l=t.clone(t.result(n,"events"))||{};l=e.normalizeUIKeys(l,o(n));var h=0;t.each(l,function(e,s){var o=s.match(i),l=o[1]+"."+[this.cid,r,h++," "].join("")+o[2],c=t.isFunction(e)?e:n[e];c&&(a[l]=t.bind(c,n))},this),s=t.extend(s,a)},this),s}};function s(e,t){this._view=e,this._behaviors=t,this._triggers={}}function o(e){return e._uiBindings||e.ui}return t.extend(n,{behaviorsLookup:function(){throw new e.Error({message:"You must define where your behaviors are stored.",url:"marionette.behaviors.html#behaviorslookup"})},getBehaviorClass:function(t,i){return t.behaviorClass?t.behaviorClass:e._getValue(n.behaviorsLookup,this,[t,i])[i]},parseBehaviors:function(e,i){return t.chain(i).map(function(i,r){var s=new(n.getBehaviorClass(i,r))(i,e),o=n.parseBehaviors(e,t.result(s,"behaviors"));return[s].concat(o)}).flatten().value()},wrap:function(e,i,n){t.each(n,function(n){e[n]=t.partial(r[n],e[n],i)})}}),t.extend(s.prototype,{buildBehaviorTriggers:function(){return t.each(this._behaviors,this._buildTriggerHandlersForBehavior,this),this._triggers},_buildTriggerHandlersForBehavior:function(i,n){var r=t.clone(t.result(i,"triggers"))||{};r=e.normalizeUIKeys(r,o(i)),t.each(r,t.bind(this._setHandlerForBehavior,this,i,n))},_setHandlerForBehavior:function(e,t,i,n){var r=n.replace(/^\S+/,function(e){return e+".behaviortriggers"+t});this._triggers[r]=this._view._buildViewTrigger(i)}}),n}(s,i),s.AppRouter=t.Router.extend({constructor:function(e){this.options=e||{},t.Router.apply(this,arguments);var i=this.getOption("appRoutes"),n=this._getController();this.processAppRoutes(n,i),this.on("route",this._processOnRoute,this)},appRoute:function(e,t){var i=this._getController();this._addAppRoute(i,e,t)},_processOnRoute:function(e,t){if(i.isFunction(this.onRoute)){var n=i.invert(this.getOption("appRoutes"))[e];this.onRoute(e,n,t)}},processAppRoutes:function(e,t){if(t){var n=i.keys(t).reverse();i.each(n,function(i){this._addAppRoute(e,i,t[i])},this)}},_getController:function(){return this.getOption("controller")},_addAppRoute:function(e,t,n){var r=e[n];if(!r)throw new s.Error('Method "'+n+'" was not found on the controller');this.route(t,n,i.bind(r,e))},mergeOptions:s.mergeOptions,getOption:s.proxyGetOption,triggerMethod:s.triggerMethod,bindEntityEvents:s.proxyBindEntityEvents,unbindEntityEvents:s.proxyUnbindEntityEvents}),s.Application=s.Object.extend({constructor:function(e){this._initializeRegions(e),this._initCallbacks=new s.Callbacks,this.submodules={},i.extend(this,e),this._initChannel(),s.Object.apply(this,arguments)},execute:function(){this.commands.execute.apply(this.commands,arguments)},request:function(){return this.reqres.request.apply(this.reqres,arguments)},addInitializer:function(e){this._initCallbacks.add(e)},start:function(e){this.triggerMethod("before:start",e),this._initCallbacks.run(e,this),this.triggerMethod("start",e)},addRegions:function(e){return this._regionManager.addRegions(e)},emptyRegions:function(){return this._regionManager.emptyRegions()},removeRegion:function(e){return this._regionManager.removeRegion(e)},getRegion:function(e){return this._regionManager.get(e)},getRegions:function(){return this._regionManager.getRegions()},module:function(e,t){var n=s.Module.getClass(t),r=i.toArray(arguments);return r.unshift(this),n.create.apply(n,r)},getRegionManager:function(){return new s.RegionManager},_initializeRegions:function(e){var t=i.isFunction(this.regions)?this.regions(e):this.regions||{};this._initRegionManager();var n=s.getOption(e,"regions");return i.isFunction(n)&&(n=n.call(this,e)),i.extend(t,n),this.addRegions(t),this},_initRegionManager:function(){this._regionManager=this.getRegionManager(),this._regionManager._parent=this,this.listenTo(this._regionManager,"before:add:region",function(){s._triggerMethod(this,"before:add:region",arguments)}),this.listenTo(this._regionManager,"add:region",function(e,t){this[e]=t,s._triggerMethod(this,"add:region",arguments)}),this.listenTo(this._regionManager,"before:remove:region",function(){s._triggerMethod(this,"before:remove:region",arguments)}),this.listenTo(this._regionManager,"remove:region",function(e){delete this[e],s._triggerMethod(this,"remove:region",arguments)})},_initChannel:function(){this.channelName=i.result(this,"channelName")||"global",this.channel=i.result(this,"channel")||t.Wreqr.radio.channel(this.channelName),this.vent=i.result(this,"vent")||this.channel.vent,this.commands=i.result(this,"commands")||this.channel.commands,this.reqres=i.result(this,"reqres")||this.channel.reqres}}),s.Module=function(e,t,n){this.moduleName=e,this.options=i.extend({},this.options,n),this.initialize=n.initialize||this.initialize,this.submodules={},this._setupInitializersAndFinalizers(),this.app=t,i.isFunction(this.initialize)&&this.initialize(e,t,this.options)},s.Module.extend=s.extend,i.extend(s.Module.prototype,t.Events,{startWithParent:!0,initialize:function(){},addInitializer:function(e){this._initializerCallbacks.add(e)},addFinalizer:function(e){this._finalizerCallbacks.add(e)},start:function(e){this._isInitialized||(i.each(this.submodules,function(t){t.startWithParent&&t.start(e)}),this.triggerMethod("before:start",e),this._initializerCallbacks.run(e,this),this._isInitialized=!0,this.triggerMethod("start",e))},stop:function(){this._isInitialized&&(this._isInitialized=!1,this.triggerMethod("before:stop"),i.invoke(this.submodules,"stop"),this._finalizerCallbacks.run(void 0,this),this._initializerCallbacks.reset(),this._finalizerCallbacks.reset(),this.triggerMethod("stop"))},addDefinition:function(e,t){this._runModuleDefinition(e,t)},_runModuleDefinition:function(e,n){if(e){var r=i.flatten([this,this.app,t,s,t.$,i,n]);e.apply(this,r)}},_setupInitializersAndFinalizers:function(){this._initializerCallbacks=new s.Callbacks,this._finalizerCallbacks=new s.Callbacks},triggerMethod:s.triggerMethod}),i.extend(s.Module,{create:function(e,t,n){var r=e,s=i.drop(arguments,3),o=(t=t.split(".")).length,a=[];return a[o-1]=n,i.each(t,function(t,i){var o=r;r=this._getModule(o,t,e,n),this._addModuleDefinition(o,r,a[i],s)},this),r},_getModule:function(e,t,n,r,s){var o=i.extend({},r),a=this.getClass(r),l=e[t];return l||(l=new a(t,n,o),e[t]=l,e.submodules[t]=l),l},getClass:function(e){var t=s.Module;return e?e.prototype instanceof t?e:e.moduleClass||t:t},_addModuleDefinition:function(e,t,i,n){var r=this._getDefine(i),s=this._getStartWithParent(i,t);r&&t.addDefinition(r,n),this._addStartWithParent(e,t,s)},_getStartWithParent:function(e,t){var n;return i.isFunction(e)&&e.prototype instanceof s.Module?(n=t.constructor.prototype.startWithParent,!!i.isUndefined(n)||n):!i.isObject(e)||(n=e.startWithParent,!!i.isUndefined(n)||n)},_getDefine:function(e){return!i.isFunction(e)||e.prototype instanceof s.Module?i.isObject(e)?e.define:null:e},_addStartWithParent:function(e,t,i){t.startWithParent=t.startWithParent&&i,t.startWithParent&&!t.startWithParentIsConfigured&&(t.startWithParentIsConfigured=!0,e.addInitializer(function(e){t.startWithParent&&t.start(e)}))}}),s});