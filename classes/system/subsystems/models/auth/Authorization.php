<?php
 namespace UmiCms\System\Auth;use UmiCms\Service;use UmiCms\System\Cookies;use UmiCms\System\Protection;use UmiCms\System\Session\iSession;use UmiCms\System\Auth\PasswordHash\iAlgorithm;use UmiCms\System\Auth\PasswordHash\WrongAlgorithmException;class Authorization implements iAuthorization {const UMI_CMS_SESSION_COOKIE_NAME = 'umicms_session';private $authorizedUserId;private $session;private $tokenGenerator;private $permissionsCollection;private $cookieJar;private $umiObjects;private $configuration;private $hashAlgorithm;public function __construct(   iSession $v21d6f40cfb511982e4424e0e250a9557,   Protection\CsrfProtection $v541505e0d390eee9c63842d4d6f57c1b,   \iPermissionsCollection $v9572e97ec76effe3bd53a913f54b6d20,   Cookies\iCookieJar $v3952212ff477ba2f5b443a38a081fecb,   \iUmiObjectsCollection $vcf18563b2faa9f3635cd5ad27a53fa1e,   \iConfiguration $vccd1066343c95877b75b79d47c36bebe,   iAlgorithm $ved469618898d75b149e5c7c4b6a1c415  ) {$this->session = $v21d6f40cfb511982e4424e0e250a9557;$this->tokenGenerator = $v541505e0d390eee9c63842d4d6f57c1b;$this->permissionsCollection = $v9572e97ec76effe3bd53a913f54b6d20;$this->cookieJar = $v3952212ff477ba2f5b443a38a081fecb;$this->umiObjects = $vcf18563b2faa9f3635cd5ad27a53fa1e;$this->configuration = $vccd1066343c95877b75b79d47c36bebe;$this->hashAlgorithm = $ved469618898d75b149e5c7c4b6a1c415;}public function authorize($v8e44f0089b076e18a718eb9ca3d94674) {$this->authorizeStateless($v8e44f0089b076e18a718eb9ca3d94674);$this->startSession($v8e44f0089b076e18a718eb9ca3d94674);$this->setCookieToken($v8e44f0089b076e18a718eb9ca3d94674);return $this;}public function authorizeStateless($v8e44f0089b076e18a718eb9ca3d94674) {$this->validateUserId($v8e44f0089b076e18a718eb9ca3d94674);$this->setAuthorizedUserId($v8e44f0089b076e18a718eb9ca3d94674);return $this;}public function getAuthorizedUserId() {return $this->authorizedUserId;}public function deAuthorize() {$this->deAuthorizeStateless();$this->stopSession();$this->removeCookieToken();return $this;}public function deAuthorizeStateless() {$this->setAuthorizedUserId(null);return $this;}public function authorizeUsingFixedSessionId($v8e44f0089b076e18a718eb9ca3d94674) {$this->authorizeStateless($v8e44f0089b076e18a718eb9ca3d94674);$this->startSession($v8e44f0089b076e18a718eb9ca3d94674, false);return $this;}public function authorizeFakeUser($v8e44f0089b076e18a718eb9ca3d94674) {$this->validateUserId($v8e44f0089b076e18a718eb9ca3d94674);$vc4fb0ad3c16f46d4d48cf475c70b62e3 = $this->getAuthorizedUserId();$this->deAuthorize();$v3952212ff477ba2f5b443a38a081fecb = $this->getCookieJar();$vee11cbb19052e40b07aac0ca060c23ee = $this->getObjectCollection()    ->getObject($v8e44f0089b076e18a718eb9ca3d94674);switch ($vee11cbb19052e40b07aac0ca060c23ee->getTypeGUID()) {case 'users-user': {$this->authorize($v8e44f0089b076e18a718eb9ca3d94674);$v3952212ff477ba2f5b443a38a081fecb->remove('customer-id');break;}case 'emarket-customer': {$v018e77635d40709feb0c09c6fb84ee00 = (int) $this->getConfiguration()      ->get('modules', 'emarket.customer-expiration-time');$v3952212ff477ba2f5b443a38a081fecb->setEncrypted('customer-id', $v8e44f0089b076e18a718eb9ca3d94674, time() + $v018e77635d40709feb0c09c6fb84ee00);break;}}$this->savePreviousUserId($vc4fb0ad3c16f46d4d48cf475c70b62e3);return $this;}private function savePreviousUserId($v8e44f0089b076e18a718eb9ca3d94674) {$v21d6f40cfb511982e4424e0e250a9557 = $this->getSession();$v21d6f40cfb511982e4424e0e250a9557->set('fake-user', true);$v21d6f40cfb511982e4424e0e250a9557->set('old_user_id', $v8e44f0089b076e18a718eb9ca3d94674);}public function authorizeUsingPreviousUserId($vc4fb0ad3c16f46d4d48cf475c70b62e3) {$this->validateUserId($vc4fb0ad3c16f46d4d48cf475c70b62e3);$this->deAuthorize();$this->authorize($vc4fb0ad3c16f46d4d48cf475c70b62e3);$this->getCookieJar()->remove('customer-id');return $this;}private function startSession($v8e44f0089b076e18a718eb9ca3d94674, $v4e5e6b53e4fd4c512400805ffbceb8d6 = true) {$v21d6f40cfb511982e4424e0e250a9557 = $this->getSession();if ($v4e5e6b53e4fd4c512400805ffbceb8d6) {$v21d6f40cfb511982e4424e0e250a9557->changeId();}$v94a08da1fecbb6e8b46990538c7b50b2 = $this->getTokenGenerator()    ->generateToken();$v6a7a6093039f8bca7bbce3912056ed8a = $this->getPermissionsCollection()    ->isSv($v8e44f0089b076e18a718eb9ca3d94674);$v21d6f40cfb511982e4424e0e250a9557->set('user_id', $v8e44f0089b076e18a718eb9ca3d94674);$v21d6f40cfb511982e4424e0e250a9557->set('csrf_token', $v94a08da1fecbb6e8b46990538c7b50b2);$v21d6f40cfb511982e4424e0e250a9557->set('user_is_sv', $v6a7a6093039f8bca7bbce3912056ed8a);$v21d6f40cfb511982e4424e0e250a9557->startActiveTime();$this->getCookieJar()->set(self::UMI_CMS_SESSION_COOKIE_NAME, 1,    time() + $v21d6f40cfb511982e4424e0e250a9557->getCookieLifeTime());}private function stopSession() {$v21d6f40cfb511982e4424e0e250a9557 = $this->getSession();$v3952212ff477ba2f5b443a38a081fecb = $this->getCookieJar();$v88fb50099bfcc271b03302aee6183b58 = $v21d6f40cfb511982e4424e0e250a9557->getName();$v3952212ff477ba2f5b443a38a081fecb->remove($v88fb50099bfcc271b03302aee6183b58);if ($v21d6f40cfb511982e4424e0e250a9557->get('fake-user')) {$v3952212ff477ba2f5b443a38a081fecb->remove('customer-id');}$v21d6f40cfb511982e4424e0e250a9557->clear();$v3952212ff477ba2f5b443a38a081fecb->remove(self::UMI_CMS_SESSION_COOKIE_NAME);}private function setCookieToken($v8e44f0089b076e18a718eb9ca3d94674) {$v10573b873d2fa5a365d558a45e328e47 = Service::Request();$v4018f36c494a097dcef948b782247e39 = $v10573b873d2fa5a365d558a45e328e47->Post()->get('save-auth-token');if (!$v4018f36c494a097dcef948b782247e39) {return;}$v21d6f40cfb511982e4424e0e250a9557 = $this->getSession();$vee11cbb19052e40b07aac0ca060c23ee = $this->getObjectCollection()    ->getObject($v8e44f0089b076e18a718eb9ca3d94674);$vd56b699830e77ba53855679cb1d252da = $vee11cbb19052e40b07aac0ca060c23ee->getValue('login');$v0800fc577294c34e0b28ad2839435945 = uniqid();$v3952212ff477ba2f5b443a38a081fecb = $this->getCookieJar();$v3952212ff477ba2f5b443a38a081fecb->setEncrypted('umi-auth-token', $vd56b699830e77ba53855679cb1d252da . ':' . $v0800fc577294c34e0b28ad2839435945, time() + $v21d6f40cfb511982e4424e0e250a9557->getCookieLifeTime());$ved469618898d75b149e5c7c4b6a1c415 = $this->getHashAlgorithm();$v9311d29b3ebf1f2c5215b510dc0d9d78 = $v10573b873d2fa5a365d558a45e328e47->remoteAddress();$vfa71f997fa1a947459dc5495fdb40b0f = $v10573b873d2fa5a365d558a45e328e47->userAgent();$v94a08da1fecbb6e8b46990538c7b50b2 = $ved469618898d75b149e5c7c4b6a1c415::hash($v0800fc577294c34e0b28ad2839435945 . $v9311d29b3ebf1f2c5215b510dc0d9d78 . $vfa71f997fa1a947459dc5495fdb40b0f);$vee11cbb19052e40b07aac0ca060c23ee->setValue('auth_token', $v94a08da1fecbb6e8b46990538c7b50b2);$vee11cbb19052e40b07aac0ca060c23ee->commit();}private function removeCookieToken() {$v3952212ff477ba2f5b443a38a081fecb = $this->getCookieJar();$v3952212ff477ba2f5b443a38a081fecb->remove('umi-auth-token');}private function validateUserId($v8e44f0089b076e18a718eb9ca3d94674) {if (!is_int($v8e44f0089b076e18a718eb9ca3d94674) || $v8e44f0089b076e18a718eb9ca3d94674 <= 0) {throw new AuthorizationException('Wrong user id given, integer > 0 expected');}}private function setAuthorizedUserId($v8e44f0089b076e18a718eb9ca3d94674) {$this->authorizedUserId = $v8e44f0089b076e18a718eb9ca3d94674;return $this;}private function getSession() {return $this->session;}private function getTokenGenerator() {return $this->tokenGenerator;}private function getPermissionsCollection() {return $this->permissionsCollection;}private function getCookieJar() {return $this->cookieJar;}private function getObjectCollection() {return $this->umiObjects;}private function getConfiguration() {return $this->configuration;}private function getHashAlgorithm() {return $this->hashAlgorithm;}}