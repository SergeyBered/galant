<?php
 namespace UmiCms\Utils\AutoThumb;use \iConfiguration as iConfig;use \iImageProcessor as iImageProcessor;use UmiCms\Classes\System\Entities\Image\iFactory as iImageFactory;class Generator implements iGenerator {private $config;private $imageFactory;private $imageProcessor;public function __construct(iConfig $v2245023265ae4cf87d02c8b6ba991139, iImageFactory $vc76618e39a97c7e3d6d7ab8973932e05, iImageProcessor $v41fce2005fa27bdf619a257961c4f9c4) {$this->config = $v2245023265ae4cf87d02c8b6ba991139;$this->imageFactory = $vc76618e39a97c7e3d6d7ab8973932e05;$this->imageProcessor = $v41fce2005fa27bdf619a257961c4f9c4;}public function execute($vd6fe1d0be6347b8ef2427fa629c04485) {$vd6fe1d0be6347b8ef2427fa629c04485 = trim($vd6fe1d0be6347b8ef2427fa629c04485);if ($vd6fe1d0be6347b8ef2427fa629c04485 === '') {throw new \ErrorException('Empty path given');}$vd6fe1d0be6347b8ef2427fa629c04485 = str_replace('./', '/', $vd6fe1d0be6347b8ef2427fa629c04485);if (!$this->isAllowedPath($vd6fe1d0be6347b8ef2427fa629c04485)) {throw new \ErrorException(sprintf('Image path not allowed: %s', $vd6fe1d0be6347b8ef2427fa629c04485));}return $this->generate($vd6fe1d0be6347b8ef2427fa629c04485);}private function isAllowedPath($vd6fe1d0be6347b8ef2427fa629c04485) {$veec4d6416f6ba06d977d1eec284beb23 = realpath(dirname(CURRENT_WORKING_DIR . $vd6fe1d0be6347b8ef2427fa629c04485));$v08d829de8c6fb268f1ab8a4583012b7f = $this->getAllowedPathList();return !(strcmp(mb_substr($veec4d6416f6ba06d977d1eec284beb23, 0, mb_strlen($v08d829de8c6fb268f1ab8a4583012b7f[0])), $v08d829de8c6fb268f1ab8a4583012b7f[0]) != 0    && strcmp(mb_substr($veec4d6416f6ba06d977d1eec284beb23, 0, mb_strlen($v08d829de8c6fb268f1ab8a4583012b7f[1])), $v08d829de8c6fb268f1ab8a4583012b7f[1]) != 0);}private function getAllowedPathList() {return [    $this->config->includeParam('user-images-path'),    $this->config->includeParam('user-files-path')   ];}private function getAutoThumbPath() {return $this->config->includeParam('user-images-path') . '/cms/thumbs/autothumbs';}private function generate($vd6fe1d0be6347b8ef2427fa629c04485) {$vd6fe1d0be6347b8ef2427fa629c04485 = str_replace('sl_', '', $vd6fe1d0be6347b8ef2427fa629c04485);$vd78b68a69f88f543cde90ab00273c043 = ltrim($vd6fe1d0be6347b8ef2427fa629c04485, "/\\");$va1d1049cdaf306625e25bc211a3b977b = explode('/', $vd78b68a69f88f543cde90ab00273c043);$vaa4faec39b052ab79ebabfb1935b0b8d = array_pop($va1d1049cdaf306625e25bc211a3b977b);$v2b3f19f1424b0418ffe9ffd9674007c3 = explode('.', $vaa4faec39b052ab79ebabfb1935b0b8d);$vba62a12192298e8289da09e354385080 = array_pop($v2b3f19f1424b0418ffe9ffd9674007c3);$vbeab11e57052bfff2c247939c7790ace = md5($vd6fe1d0be6347b8ef2427fa629c04485);$vb43c766cbc1365dca0ffcee38e46b613 = $this->getAutoThumbPath() . '/' . $vbeab11e57052bfff2c247939c7790ace . '.' . $vba62a12192298e8289da09e354385080;$v58b708f40d5f1ced9564cd059ff97ac8 = implode('.', $v2b3f19f1424b0418ffe9ffd9674007c3);$v488b6d22ffca7b0c8dee10aa69f62bc1 = explode('_', $v58b708f40d5f1ced9564cd059ff97ac8);$v53f4192e94c0558ef41be280647b297e = (int) array_pop($v488b6d22ffca7b0c8dee10aa69f62bc1);$v04d01eb22f7effb347f1f32f507dc5a8 = (int) array_pop($v488b6d22ffca7b0c8dee10aa69f62bc1);$v32ca700f1f0e0748cef8e793fe312f1c = './' . implode('/', $va1d1049cdaf306625e25bc211a3b977b) . '/' . implode('_', $v488b6d22ffca7b0c8dee10aa69f62bc1) . '.' . $vba62a12192298e8289da09e354385080;$vadd3055bdf11d28a64794438ba67d0c8 = $this->imageFactory->create($v32ca700f1f0e0748cef8e793fe312f1c);if ($vadd3055bdf11d28a64794438ba67d0c8->getIsBroken()) {throw new \ErrorException(sprintf('Image source not exists: %s', $v32ca700f1f0e0748cef8e793fe312f1c));}if ((!file_exists($vb43c766cbc1365dca0ffcee38e46b613)) || (filemtime($v32ca700f1f0e0748cef8e793fe312f1c) > filemtime($vb43c766cbc1365dca0ffcee38e46b613))) {if (!$this->isEnoughDiscSpace()) {throw new \ErrorException('Disc quota exceeded');}$vb43c766cbc1365dca0ffcee38e46b613 = $this->createThumbnail($v32ca700f1f0e0748cef8e793fe312f1c, $v04d01eb22f7effb347f1f32f507dc5a8, $v53f4192e94c0558ef41be280647b297e, $vb43c766cbc1365dca0ffcee38e46b613);}$vf12105146129696d6a7e0ed521db2e48 = $this->imageFactory->create($vb43c766cbc1365dca0ffcee38e46b613);if ($vf12105146129696d6a7e0ed521db2e48->getIsBroken()) {throw new \ErrorException(sprintf('Cannot create thumb: %s', $vb43c766cbc1365dca0ffcee38e46b613));}return $vf12105146129696d6a7e0ed521db2e48;}private function isEnoughDiscSpace() {$vd8a9135649ad74408c6806cf16ca73b1 = $this->config->get('system', 'quota-files-and-images');$vbee0097d5d01ef174f290ed3d0dcb3e3 = getBytesFromString($vd8a9135649ad74408c6806cf16ca73b1);if ($vbee0097d5d01ef174f290ed3d0dcb3e3 != 0) {$vf3c2b1a1c083d4190513f4d3ad99c8fe = 0;foreach ($this->getAllowedPathList() as $v5f8f22b8cdbaeee8cf857673a9b6ba20) {$vf3c2b1a1c083d4190513f4d3ad99c8fe += getDirSize($v5f8f22b8cdbaeee8cf857673a9b6ba20);}if ($vf3c2b1a1c083d4190513f4d3ad99c8fe >= $vbee0097d5d01ef174f290ed3d0dcb3e3) {return false;}}return true;}private function createThumbnail($vd78b68a69f88f543cde90ab00273c043, $v04d01eb22f7effb347f1f32f507dc5a8 = 0, $v53f4192e94c0558ef41be280647b297e = 0, $vb43c766cbc1365dca0ffcee38e46b613 = '') {$v78805a221a988e79ef3f42d7c5bfd418 = $this->imageFactory->create($vd78b68a69f88f543cde90ab00273c043);$v95ba34c93f832039933f98d9237c7f4d = $v78805a221a988e79ef3f42d7c5bfd418->getFileName();$v10bdb8078550a2a4da1889b8431e8284 = $v78805a221a988e79ef3f42d7c5bfd418->getExt();$v37db4850e0f7701f1a8ee4b8eadea64e = $v78805a221a988e79ef3f42d7c5bfd418->getExt(true);$vfd1d69f13fd1a329632594b124029de0 = $v78805a221a988e79ef3f42d7c5bfd418->getWidth();$v135e606fdf5156d69e1934da10132797 = $v78805a221a988e79ef3f42d7c5bfd418->getHeight();$vb43c766cbc1365dca0ffcee38e46b613 = (string) $vb43c766cbc1365dca0ffcee38e46b613;if ($vb43c766cbc1365dca0ffcee38e46b613 === '') {$vc9ac356eb928811a5ab47729761eb050 = $v95ba34c93f832039933f98d9237c7f4d . '_' . $v04d01eb22f7effb347f1f32f507dc5a8 . '_' . $v53f4192e94c0558ef41be280647b297e . '_' . $v37db4850e0f7701f1a8ee4b8eadea64e . '.' . $v10bdb8078550a2a4da1889b8431e8284;$vb43c766cbc1365dca0ffcee38e46b613 = $this->getAutoThumbPath() . '/' . $vc9ac356eb928811a5ab47729761eb050;}if (file_exists($vb43c766cbc1365dca0ffcee38e46b613)) {return $vb43c766cbc1365dca0ffcee38e46b613;}if (($v04d01eb22f7effb347f1f32f507dc5a8 > $vfd1d69f13fd1a329632594b124029de0 && $v53f4192e94c0558ef41be280647b297e > $v135e606fdf5156d69e1934da10132797) || ($v04d01eb22f7effb347f1f32f507dc5a8 > $vfd1d69f13fd1a329632594b124029de0 && $v53f4192e94c0558ef41be280647b297e == 0) || ($v04d01eb22f7effb347f1f32f507dc5a8 == 0 && $v53f4192e94c0558ef41be280647b297e > $v135e606fdf5156d69e1934da10132797)) {copy($vd78b68a69f88f543cde90ab00273c043, $vb43c766cbc1365dca0ffcee38e46b613);}else {if (!$v53f4192e94c0558ef41be280647b297e) {$v53f4192e94c0558ef41be280647b297e = (int) round($v135e606fdf5156d69e1934da10132797 * ($v04d01eb22f7effb347f1f32f507dc5a8 / $vfd1d69f13fd1a329632594b124029de0));}if (!$v04d01eb22f7effb347f1f32f507dc5a8) {$v04d01eb22f7effb347f1f32f507dc5a8 = (int) round($vfd1d69f13fd1a329632594b124029de0 * ($v53f4192e94c0558ef41be280647b297e / $v135e606fdf5156d69e1934da10132797));}if (!$v04d01eb22f7effb347f1f32f507dc5a8 && !$v53f4192e94c0558ef41be280647b297e) {$v04d01eb22f7effb347f1f32f507dc5a8 = $vfd1d69f13fd1a329632594b124029de0;$v53f4192e94c0558ef41be280647b297e = $v135e606fdf5156d69e1934da10132797;}$this->imageProcessor->thumbnail($vd78b68a69f88f543cde90ab00273c043, $vb43c766cbc1365dca0ffcee38e46b613, $v04d01eb22f7effb347f1f32f507dc5a8, $v53f4192e94c0558ef41be280647b297e);}return $vb43c766cbc1365dca0ffcee38e46b613;}}