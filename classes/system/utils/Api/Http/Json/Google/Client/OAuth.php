<?php
 namespace UmiCms\Classes\System\Utils\Api\Http\Json\Google\Client;use \iConfiguration as iConfig;use Psr\Http\Message\RequestInterface;use Psr\Http\Message\ResponseInterface;use UmiCms\Classes\System\Utils\Api\Http\Client;use UmiCms\Utils\Logger\iFactory as iLoggerFactory;use UmiCms\Classes\System\Utils\Api\Http\Exception;use UmiCms\System\Protection\Jwt\Token\iFactory as iJvtFactory;class OAuth extends Client implements iOAuth {const SERVICE_HOST = 'https://www.googleapis.com/oauth2/v4/';const TOKEN_LIFE_TIME = 3600;private $privateKey;private $serviceAccount;private $scope;private $jvtFactory;public function __construct(   iLoggerFactory $v7c04afd48a735990b1eb450ae0110c68, iConfig $vccd1066343c95877b75b79d47c36bebe, iJvtFactory $v80a0f2c5dfeec53b567ed6178fa3d313  ) {$this->initLogger($v7c04afd48a735990b1eb450ae0110c68, $vccd1066343c95877b75b79d47c36bebe);$v54ebd3fd5407718f9cf38963a09f2324 = $vccd1066343c95877b75b79d47c36bebe->get('debug', 'enabled');$this->setKeepLog($v54ebd3fd5407718f9cf38963a09f2324);$this->initHttpClient();$this->jvtFactory = $v80a0f2c5dfeec53b567ed6178fa3d313;}public function setServiceAccount(string $v95b688e848864db960ef4ff925aac116) : iOAuth {$this->serviceAccount = $v95b688e848864db960ef4ff925aac116;return $this;}public function setScope(string $v31a1fd140be4bef2d11e121ec9a18a58) : iOAuth {$this->scope = $v31a1fd140be4bef2d11e121ec9a18a58;return $this;}public function getToken() : string {$v10573b873d2fa5a365d558a45e328e47 = $this->createPostRequest([    'grant_type' => 'urn:ietf:params:oauth:grant-type:jwt-bearer',    'assertion' => $this->getJwtToken()   ], [    'token'   ]);$vd1fc8eaf36937be0c3ba8cfe0a2c1bfe = $this->getResponse($v10573b873d2fa5a365d558a45e328e47);if (!isset($vd1fc8eaf36937be0c3ba8cfe0a2c1bfe['access_token'])) {throw new Exception\BadResponse('Google.OAuth client error', 1);}return $vd1fc8eaf36937be0c3ba8cfe0a2c1bfe['access_token'];}protected function getServiceUrl() {return self::SERVICE_HOST;}protected function getLogDirectory() {return 'GoogleOAuth';}protected function getDefaultHeaders() {return array_merge([    'Content-Type' => 'application/x-www-form-urlencoded',    'Accept' => 'application/json',   ]);}protected function encodePostData($v8d777f385d3dfec8815d20f7496026dc) {return http_build_query($v8d777f385d3dfec8815d20f7496026dc, '', '&');}protected function getResponseBody(ResponseInterface $vd1fc8eaf36937be0c3ba8cfe0a2c1bfe) {$v1a2567345bba0c62a6859cb5030ec65e = parent::getResponseBody($vd1fc8eaf36937be0c3ba8cfe0a2c1bfe);return empty($v1a2567345bba0c62a6859cb5030ec65e) ? [] : $this->parseJson($v1a2567345bba0c62a6859cb5030ec65e);}protected function getResponse(RequestInterface $v10573b873d2fa5a365d558a45e328e47) {$vd1fc8eaf36937be0c3ba8cfe0a2c1bfe = $this->send($v10573b873d2fa5a365d558a45e328e47);$this->log($v10573b873d2fa5a365d558a45e328e47, $vd1fc8eaf36937be0c3ba8cfe0a2c1bfe);$v841a2d689ad86bd1611447453c22c6fc = $this->getResponseBody($vd1fc8eaf36937be0c3ba8cfe0a2c1bfe);if (isset($v841a2d689ad86bd1611447453c22c6fc['error'])) {throw new Exception\BadRequest($v841a2d689ad86bd1611447453c22c6fc['error'], 2);}return $v841a2d689ad86bd1611447453c22c6fc;}private function getJwtToken() : string {$v802327566b7996c79c96d3ba34995432 = time();$v736b91750e516139acc13c5eb6564f92 = [    'iss' => $this->getServiceAccount(),    'scope' => $this->getScope(),    'aud' => 'https://www.googleapis.com/oauth2/v4/token',    'exp' => $v802327566b7996c79c96d3ba34995432 + self::TOKEN_LIFE_TIME,    'iat' => $v802327566b7996c79c96d3ba34995432,   ];return $this->jvtFactory->createByPrivateKey(self::PRIVATE_KEY_NAME, $v736b91750e516139acc13c5eb6564f92)    ->getValue();}private function getServiceAccount() : string {if (!$this->serviceAccount) {throw new \ErrorException('Google service account expected');}return $this->serviceAccount;}private function getScope() : string {if (!$this->scope) {throw new \ErrorException('Google auth scope expected');}return $this->scope;}}