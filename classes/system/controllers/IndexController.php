<?php
 namespace UmiCms\Classes\System\Controllers;use \iRegedit as iRegistry;use \iUmiHierarchy as iPages;use \iConfiguration as iConfig;use UmiCms\System\Session\iSession;use UmiCms\Classes\System\MiddleWares;use \umiPropertiesHelper as iPropertyHelper;use UmiCms\System\Cache\Statical\iFacade as iStaticCache;use UmiCms\System\Hierarchy\Domain\iDetector as iDomainDetector;use UmiCms\System\Hierarchy\Language\iDetector as iLanguageDetector;class IndexController extends AbstractController implements iIndexController {private $pages;private $config;private $registry;private $session;private $staticCache;private $propertyHelper;private $domainDetector;private $languageDetector;use MiddleWares\tAuth;use MiddleWares\tUmiManager;use MiddleWares\tStub;use MiddleWares\tUmapRouter;use MiddleWares\tModuleRouter;use MiddleWares\tMirrorHandler;public function setPages(iPages $vb3b32a2d422265cd25c3323ed0157f81) {$this->pages = $vb3b32a2d422265cd25c3323ed0157f81;return $this;}public function setConfig(iConfig $v2245023265ae4cf87d02c8b6ba991139) {$this->config = $v2245023265ae4cf87d02c8b6ba991139;return $this;}public function setRegistry(iRegistry $va9205dcfd4a6f7c2cbe8be01566ff84a) {$this->registry = $va9205dcfd4a6f7c2cbe8be01566ff84a;return $this;}public function setSession(iSession $v21d6f40cfb511982e4424e0e250a9557) {$this->session = $v21d6f40cfb511982e4424e0e250a9557;return $this;}public function setStaticCache(iStaticCache $v805e6b8e623f5dd06f99f55e55230cca) {$this->staticCache = $v805e6b8e623f5dd06f99f55e55230cca;return $this;}public function setPropertyHelper(iPropertyHelper $vf31850dc43e68b04d7948bd4d87f0ddd) {$this->propertyHelper = $vf31850dc43e68b04d7948bd4d87f0ddd;return $this;}public function setDomainDetector(iDomainDetector $v45651ec82e45766b3d707ee33df1a61a) {$this->domainDetector = $v45651ec82e45766b3d707ee33df1a61a;return $this;}public function setLanguageDetector(iLanguageDetector $vf24870e9df244bb77374445d936a6741) {$this->languageDetector = $vf24870e9df244bb77374445d936a6741;return $this;}public function execute() {parent::execute();$this->redirectIfRequired();$this->loginByEnvironment();$this->validateUmiManagerRequest();$this->initializeSession();$this->showStubPageIfRequired();$this->executeUmap();$this->analyzeModuleRequest();$this->deleteRepeatedSlashesInUrl();$this->redirectToUrlWithSuffix();$this->handleRequestFromMirror();$this->handleRequestFromHttp();$this->handleRequest();$this->saveProperties();$this->disableBanners();$this->updateStatistics();$this->cleanStaticCache();$this->endRequest();}private function redirectIfRequired() {$v9096a2028f38f6dc9d1dda709078d092 = startsWith(trim($this->request->uri(), ' /'), 'index.php');if ($this->config->get('seo', 'index-redirect') && $v9096a2028f38f6dc9d1dda709078d092) {$this->buffer->redirect('/');}$v884d9804999fc47a3c2694e49ad2536a = null;$v851f5ac9941d720844d143ed9cfcf60a = $this->languageDetector->detectPrefix();if ($this->isZeroPageNumber() && $this->isDefaultLanguagePrefix()) {$v960a76b96531914e7ec573c5eefffe2b = $this->request->uriWithoutPageNumber();$v884d9804999fc47a3c2694e49ad2536a = $this->getAddressWithoutPrefix($v960a76b96531914e7ec573c5eefffe2b, $v851f5ac9941d720844d143ed9cfcf60a);}elseif ($this->isDefaultLanguagePrefix()) {$v960a76b96531914e7ec573c5eefffe2b = $this->request->uri();$v884d9804999fc47a3c2694e49ad2536a = $this->getAddressWithoutPrefix($v960a76b96531914e7ec573c5eefffe2b, $v851f5ac9941d720844d143ed9cfcf60a);}elseif ($this->isZeroPageNumber()) {$v884d9804999fc47a3c2694e49ad2536a = $this->request->uriWithoutPageNumber();}if ($v884d9804999fc47a3c2694e49ad2536a !== null) {$this->buffer->redirect($v884d9804999fc47a3c2694e49ad2536a);}}private function isZeroPageNumber() : bool {$v10573b873d2fa5a365d558a45e328e47 = $this->request;return ($v10573b873d2fa5a365d558a45e328e47->issetPageNumber() && $v10573b873d2fa5a365d558a45e328e47->pageNumber() === 0 && $v10573b873d2fa5a365d558a45e328e47->isHtml());}private function isDefaultLanguagePrefix() : bool {$va8824de960fc60e621d3db2ac003cc0b = $this->domainDetector->detect()    ->getDefaultLangId();$vc7998d8b485a9d8075971e7056de2f65 = $this->languageDetector->detect();$ve0bc8687a11f6870bb10f218364ab965 = ($vc7998d8b485a9d8075971e7056de2f65->getId() === $va8824de960fc60e621d3db2ac003cc0b);return $ve0bc8687a11f6870bb10f218364ab965 && ($vc7998d8b485a9d8075971e7056de2f65->getPrefix() === $this->request->getFirstPart());}private function getAddressWithoutPrefix(string $v884d9804999fc47a3c2694e49ad2536a, string $v851f5ac9941d720844d143ed9cfcf60a) : string {$v8d3f1df842e902235bf8ca5b1ceef0b8 = ltrim($v884d9804999fc47a3c2694e49ad2536a, '/');if (!startsWith($v8d3f1df842e902235bf8ca5b1ceef0b8, $v851f5ac9941d720844d143ed9cfcf60a)) {return $v884d9804999fc47a3c2694e49ad2536a;}return substr_replace($v8d3f1df842e902235bf8ca5b1ceef0b8, '', 0, strlen($v851f5ac9941d720844d143ed9cfcf60a));}private function initializeSession() {$vc66c00ae9f18fc0c67d8973bd07dc4cd = preg_replace('/^(http(s)?:\/\/)?(www\.)?/', '', $this->request->referrer());$v67b3dba8bc6778101892eb77249db32e = preg_replace('/^(http(s)?:\/\/)?(www\.)?/', '', $this->request->host());if (mb_strpos($vc66c00ae9f18fc0c67d8973bd07dc4cd, $v67b3dba8bc6778101892eb77249db32e) !== 0) {$this->session->set('http_referer', $this->request->referrer());$this->session->set('http_target', $this->request->uri());}if (!$this->session->get('http_target')) {$this->session->set('http_target', $this->request->uri());}}private function deleteRepeatedSlashesInUrl() {if ($this->request->isAdmin()) {return;}$v694b5b6b5536d28285396c8ce7c268bc = $this->languageDetector->detectId();$v72ee76c5c29383b7c9f9225c1fa4d10b = $this->domainDetector->detectId();$v9305b73d359bd06734fee0b3638079e1 = $this->request->uri();$v240bf022e685b0ee30ad9fe9e1fb5d5b = '|([\/]{2,})|';$v93bcbcb5ec41604528c6916531a67a28 = preg_match($v240bf022e685b0ee30ad9fe9e1fb5d5b, $v9305b73d359bd06734fee0b3638079e1);if (!$this->registry->get("//settings/seo/$v72ee76c5c29383b7c9f9225c1fa4d10b/$v694b5b6b5536d28285396c8ce7c268bc/process-slashes") || !$v93bcbcb5ec41604528c6916531a67a28) {return;}$v204f9e067699db3a0a4f2bddad38f659 = $this->registry->get("//settings/seo/$v72ee76c5c29383b7c9f9225c1fa4d10b/$v694b5b6b5536d28285396c8ce7c268bc/process-slashes-status");switch ($v204f9e067699db3a0a4f2bddad38f659) {case 'redirect': {$v9305b73d359bd06734fee0b3638079e1 = preg_replace($v240bf022e685b0ee30ad9fe9e1fb5d5b, '/', $v9305b73d359bd06734fee0b3638079e1);$this->buffer->redirect($v9305b73d359bd06734fee0b3638079e1);break;}case 'not-found': {$this->moduleRouter->setNotFoundState();$this->buffer->status('404 Not Found');break;}}}private function redirectToUrlWithSuffix() {$va53451c915c27ad49e3322b200453e90 = $this->config->get('seo', 'url-suffix.add');$v50d644c42a9f32486af6d339527e1020 = $this->moduleRouter->getCurrentElementId();$v8500a842b36de8f81d8d225c44655427 = $this->moduleRouter->getCurrentModule() == 'content';$v352ead75008ab5565bf41b4d9d6fca17 = $this->moduleRouter->getCurrentMethod() == 'content';$v920510c4519dcb8cd0499f5c09169a1a = ($v50d644c42a9f32486af6d339527e1020 === false) && ($v8500a842b36de8f81d8d225c44655427 && $v352ead75008ab5565bf41b4d9d6fca17);if (!$v920510c4519dcb8cd0499f5c09169a1a && $va53451c915c27ad49e3322b200453e90) {\def_module::requireSlashEnding();}}private function handleRequestFromMirror() {$v15d61712450a686a7f365adf4fef581f = (int) $this->config->get('seo', 'primary-domain-redirect');$this->checkMirror($v15d61712450a686a7f365adf4fef581f);}private function handleRequestFromHttp() {if ($this->request->isAdmin() || $this->request->isHttps()) {return;}$vad5f82e879a9c5d6b5b442eb37e50551 = $this->domainDetector->detect();if (!$vad5f82e879a9c5d6b5b442eb37e50551->isUsingSsl() || !$this->config->get('seo', 'https-redirect')) {return;}$v884d9804999fc47a3c2694e49ad2536a = $vad5f82e879a9c5d6b5b442eb37e50551->getCurrentUrl() . $this->request->uri();$this->buffer->redirect($v884d9804999fc47a3c2694e49ad2536a);}private function handleRequest() {$v33a006acbb740f60fee7f80b68beacfa = $this->getCachedContent();if (is_string($v33a006acbb740f60fee7f80b68beacfa)) {$this->handleCachedRequest($v33a006acbb740f60fee7f80b68beacfa);}else {$this->handleHtmlRequest();}}private function getCachedContent() {$v70e8822b2e035fa3777d666207aeafa8 = $this->eventPointFactory->create('systemPrepare', 'before');$v70e8822b2e035fa3777d666207aeafa8->call();$v33a006acbb740f60fee7f80b68beacfa = $this->staticCache->load();$v70e8822b2e035fa3777d666207aeafa8->setMode('after');$v70e8822b2e035fa3777d666207aeafa8->call();return $v33a006acbb740f60fee7f80b68beacfa;}private function handleCachedRequest($v33a006acbb740f60fee7f80b68beacfa) {$this->buffer->contentType('text/html');$this->buffer->charset('utf-8');$this->buffer->push($v33a006acbb740f60fee7f80b68beacfa);}private function handleHtmlRequest() {$v568e4df6b72662047d3c5db25163f9ad = !$this->config->get('debug', 'callstack.disabled');$result = $this->executeModuleRequest($v568e4df6b72662047d3c5db25163f9ad);if ($this->request->isStreamCallStack()) {$this->response->printXmlAsString($result);}if ($this->moduleRouter->isNotFoundState()) {$this->buffer->status('404 Not Found');}$this->buffer->push($result);$this->buffer->option('generation-time', true);$this->staticCache->save($this->buffer->content());}private function saveProperties() {$this->propertyHelper->saveProperties();}private function disableBanners() {if ($this->request->isAdmin()) {return;}$v009a93317a248d0fbcd664b6fa5e79e8 = $this->moduleRouter->getModule('banners');if ($v009a93317a248d0fbcd664b6fa5e79e8 instanceof \banners) {$v009a93317a248d0fbcd664b6fa5e79e8->saveUpdates();}}private function updateStatistics() {if ($this->request->isAdmin()) {return;}$va912a94d79b5124d876951f96ebb256f = $this->moduleRouter->getModule('stat');if ($va912a94d79b5124d876951f96ebb256f instanceof \stat && $va912a94d79b5124d876951f96ebb256f->isEnabled()) {$va912a94d79b5124d876951f96ebb256f->pushStat();}}private function cleanStaticCache() {$vbf95cbea2fbc6aab956a058a7afb3e45 = $this->pages->getUpdatedElements();$this->staticCache->deletePageListCache($vbf95cbea2fbc6aab956a058a7afb3e45);}private function endRequest() {$this->buffer->end();}}