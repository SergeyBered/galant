<?php
 namespace UmiCms\Utils\DomainKeyCode;use \iRegedit as iRegistry;use \iConfiguration as iConfig;use \iDomainsCollection as iDomains;use \iCmsController as iModuleLoader;use \umiTemplater as iTemplateEngine;use UmiCms\System\Request\iFacade as iRequest;use \umiRemoteFileGetter as iLicenseServerClient;use UmiCms\Classes\System\Template\Engine\iFactory as iTemplateEngineFactory;class Saver implements iSaver {private $registry;private $request;private $config;private $domains;private $moduleLoader;private $templateEngine;private $client;public function __construct(   iRegistry $va9205dcfd4a6f7c2cbe8be01566ff84a, iRequest $v10573b873d2fa5a365d558a45e328e47, iConfig $v2245023265ae4cf87d02c8b6ba991139, iDomains $ve4e46deb7f9cc58c7abfb32e5570b6f3,   iModuleLoader $ve73640dc910137b64969c6b9234502ea, iTemplateEngineFactory $v15d3af1b358e821390b4f83b9779bb37, iLicenseServerClient $v62608e08adc29a8d6dbc9754e659f125  ) {$this->registry = $va9205dcfd4a6f7c2cbe8be01566ff84a;$this->request = $v10573b873d2fa5a365d558a45e328e47;$this->config = $v2245023265ae4cf87d02c8b6ba991139;$this->domains = $ve4e46deb7f9cc58c7abfb32e5570b6f3;$this->moduleLoader = $ve73640dc910137b64969c6b9234502ea;$this->templateEngine = $v15d3af1b358e821390b4f83b9779bb37->createPhp(null);$this->client = $v62608e08adc29a8d6dbc9754e659f125;}public function saveToServer($vb96beb1fb95f7fa45257bb48942aef8a) {$this->dropCache();$v21ffce5b8a6cc8cc6a41448dd69623c9 = [    'ip' => $this->request->serverAddress() ?: $this->request->documentRoot(),    'domain' => $this->request->host(),    'keycode' => $vb96beb1fb95f7fa45257bb48942aef8a,    'previous_edition' => $this->registry->get('//settings/system_edition'),    'last_update_time' => $this->registry->get('//settings/last_updated')   ];$v572d4e421e5e6b9bc11d815e8a027112 = 'aHR0cDovL3Vkb2QudW1paG9zdC5ydS91ZGF0YTovL2N1c3RvbS9wcmltYXJ5Q2hlY2tDb2RlLw==';$v572d4e421e5e6b9bc11d815e8a027112 = base64_decode($v572d4e421e5e6b9bc11d815e8a027112) . base64_encode(serialize($v21ffce5b8a6cc8cc6a41448dd69623c9)) . '/';$result = $this->client::get($v572d4e421e5e6b9bc11d815e8a027112, false, false, false, false, false, 30);$v0f635d0e0f3874fff8b581c132e6c7a7 = simplexml_load_string($result);$v0f635d0e0f3874fff8b581c132e6c7a7->addChild('is_domain_not_default', (int) !$this->domains->isDefaultDomain($this->request->host()));return $v0f635d0e0f3874fff8b581c132e6c7a7;}public function saveToCms($vb96beb1fb95f7fa45257bb48942aef8a, $v97e32a574aa9ef24f76a81fc43aba6ce) {$this->dropCache();if (!$v97e32a574aa9ef24f76a81fc43aba6ce) {throw new \ErrorException('Incorrect edition given');}$this->validateKeyCode($vb96beb1fb95f7fa45257bb48942aef8a, $v97e32a574aa9ef24f76a81fc43aba6ce);$this->setDefaultDomain();$this->registry->set('//settings/keycode', $vb96beb1fb95f7fa45257bb48942aef8a);$this->registry->set('//settings/system_edition', $v97e32a574aa9ef24f76a81fc43aba6ce);$this->registry->set('//settings/previous_edition', $this->registry->get('//settings/system_edition'));$this->deleteIllegalComponents();}private function dropCache() {$vd9f2b1aedd9f1fb2c283460afa645f73 = $this->config->includeParam('system.runtime-cache');foreach ([$vd9f2b1aedd9f1fb2c283460afa645f73 . 'registry', $vd9f2b1aedd9f1fb2c283460afa645f73 . 'trash'] as $v47826cacc65c665212b821e6ff80b9b0) {if (is_file($v47826cacc65c665212b821e6ff80b9b0)) {unlink($v47826cacc65c665212b821e6ff80b9b0);}}}private function validateKeyCode($vb96beb1fb95f7fa45257bb48942aef8a, $v97e32a574aa9ef24f76a81fc43aba6ce) {if (mb_strlen(str_replace('-', '', $vb96beb1fb95f7fa45257bb48942aef8a)) != 33) {throw new \ErrorException('Incorrect key code format given');}$v67b3dba8bc6778101892eb77249db32e = $this->request->host();$v74ccec8c8284be460528624db0943ba3 = ['commerce', 'business', 'corporate', 'commerce_enc', 'business_enc', 'corporate_enc', 'gov'];$v45cee5e0fe2cae080c44e7a4ffc70361 = in_array($v97e32a574aa9ef24f76a81fc43aba6ce, $v74ccec8c8284be460528624db0943ba3) ? 'pro' : $v97e32a574aa9ef24f76a81fc43aba6ce;$ve8701a96f778fea2f6da0920e291d189 = $this->templateEngine::getSomething($v45cee5e0fe2cae080c44e7a4ffc70361, $v67b3dba8bc6778101892eb77249db32e);if ($ve8701a96f778fea2f6da0920e291d189 != mb_substr($vb96beb1fb95f7fa45257bb48942aef8a, 12)) {throw new \ErrorException('Incorrect key code given');}}private function setDefaultDomain() {$v67b3dba8bc6778101892eb77249db32e = $this->request->host();try {$v9d6e24ec78d309695833f4c9f8310d7a = $this->domains->getDefaultDomain();$v9d6e24ec78d309695833f4c9f8310d7a->setHost($v67b3dba8bc6778101892eb77249db32e);$v9d6e24ec78d309695833f4c9f8310d7a->commit();}catch (\databaseException $v42552b1f133f9f8eb406d4f306ea9fd1) {if ($v42552b1f133f9f8eb406d4f306ea9fd1->getCode() == \IConnection::DUPLICATE_KEY_ERROR_CODE) {$v3d5ed8db11ff5eea231151580225ecc7 = $this->domains->getDomainId($v67b3dba8bc6778101892eb77249db32e);$this->domains->setDefaultDomain($v3d5ed8db11ff5eea231151580225ecc7);}else {throw $v42552b1f133f9f8eb406d4f306ea9fd1;}}}private function deleteIllegalComponents() {$v43189b341491e5bde86748c08c109365 = $this->moduleLoader->getModule('autoupdate');if ($v43189b341491e5bde86748c08c109365 instanceof \autoupdate) {$v43189b341491e5bde86748c08c109365->deleteIllegalComponents();}}}