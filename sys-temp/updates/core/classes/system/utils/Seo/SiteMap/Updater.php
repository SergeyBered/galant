<?php
 namespace UmiCms\Classes\System\Utils\SiteMap;use \iConfiguration as iConfig;use \iUmiHierarchy as iPageFacade;use \iUmiHierarchyElement as iPage;use UmiCms\System\Events\iEventPointFactory as iEventFactory;use UmiCms\Classes\System\Utils\SiteMap\Image\iFacade as iImageFacade;use UmiCms\Classes\System\Utils\SiteMap\Location\iFacade as iLocationFacade;class Updater implements iUpdater {const DEFAULT_CHANGE_FREQUENCY = 'weekly';private $locationFacade;private $pageFacade;private $eventFactory;private $imageFacade;private $config;public function __construct(   iLocationFacade $v71c548f4ea56fe180189691eaaa41803,   iPageFacade $vb81ca7c0ccaa77e7aa91936ab0070695,   iEventFactory $v67c06be409275078f3a98d129b0123c8,   iImageFacade $ve6db6d90cce0b60a71b353564e9fbe36,   iConfig $v2245023265ae4cf87d02c8b6ba991139  ) {$this->locationFacade = $v71c548f4ea56fe180189691eaaa41803;$this->pageFacade = $vb81ca7c0ccaa77e7aa91936ab0070695;$this->eventFactory = $v67c06be409275078f3a98d129b0123c8;$this->imageFacade = $ve6db6d90cce0b60a71b353564e9fbe36;$this->config = $v2245023265ae4cf87d02c8b6ba991139;}public function update(iPage $v71860c77c6745379b0d44304d66b6a13) {$va6eb4816205178e88dad66a16a19ff45 = (int) $v71860c77c6745379b0d44304d66b6a13->getId();$v2a304a1348456ccd2234cd71a81bd338 = $this->getLink($va6eb4816205178e88dad66a16a19ff45);$v5fa40b2485d1096a170d2d7ecd0f7030 = date('Y-m-d H:i:s', $v71860c77c6745379b0d44304d66b6a13->getUpdateTime());$vb988295c268025b49dfb3df26171ddc3 = (float) $this->getPriority($va6eb4816205178e88dad66a16a19ff45);$v075d12d847ab6a1266bae1458b09cfc0 = (int) $this->getMaxLevel($v71860c77c6745379b0d44304d66b6a13);$v72ee76c5c29383b7c9f9225c1fa4d10b = (int) $v71860c77c6745379b0d44304d66b6a13->getDomainId();$vf585b7f018bb4ced15a03683a733e50b = (int) $v71860c77c6745379b0d44304d66b6a13->getLangId();$v14d4e53ca531d9fbd0c0e01d4064cf7c = (string) $this->config    ->get('site-map', 'site-map-url-change-frequency', self::DEFAULT_CHANGE_FREQUENCY);$vf280fa25484b1dcd8f06326d682aafbf = $this->getRobotsDeny($v71860c77c6745379b0d44304d66b6a13);$v57d884f26335ff80b8f40b20b4d08eeb = $this->isHiddenType($v71860c77c6745379b0d44304d66b6a13);mt_srand();$v8020dc1b2d050a8daa6d5e1650c3be4d = mt_rand(0, 16);$this->delete($va6eb4816205178e88dad66a16a19ff45);$v4119639092e62c55ea8be348e4d9260d = $this->eventFactory->create('before_update_sitemap', 'before')    ->setParam('id', $va6eb4816205178e88dad66a16a19ff45)    ->setParam('page', $v71860c77c6745379b0d44304d66b6a13)    ->setParam('domainId', $v72ee76c5c29383b7c9f9225c1fa4d10b)    ->setParam('langId', $vf585b7f018bb4ced15a03683a733e50b)    ->addRef('link', $v2a304a1348456ccd2234cd71a81bd338)    ->addRef('pagePriority', $vb988295c268025b49dfb3df26171ddc3)    ->addRef('changeFrequency', $v14d4e53ca531d9fbd0c0e01d4064cf7c)    ->setParam('updateTime', $v5fa40b2485d1096a170d2d7ecd0f7030)    ->setParam('level', $v075d12d847ab6a1266bae1458b09cfc0)    ->setParam('sort', $v8020dc1b2d050a8daa6d5e1650c3be4d)    ->setParam('is_hidden_type', $v57d884f26335ff80b8f40b20b4d08eeb)    ->addRef('robots_deny', $vf280fa25484b1dcd8f06326d682aafbf);$v4119639092e62c55ea8be348e4d9260d->call();$v4119639092e62c55ea8be348e4d9260d->setParam('link', $v2a304a1348456ccd2234cd71a81bd338)    ->setParam('pagePriority', $vb988295c268025b49dfb3df26171ddc3)    ->setParam('changeFrequency', $v14d4e53ca531d9fbd0c0e01d4064cf7c);$v57d884f26335ff80b8f40b20b4d08eeb = $v4119639092e62c55ea8be348e4d9260d->getParam('is_hidden_type');if ($v71860c77c6745379b0d44304d66b6a13->getIsActive() && !$vf280fa25484b1dcd8f06326d682aafbf && !$v71860c77c6745379b0d44304d66b6a13->getIsDeleted() && $v2a304a1348456ccd2234cd71a81bd338 && !$v57d884f26335ff80b8f40b20b4d08eeb) {$this->locationFacade->createByEvent($v4119639092e62c55ea8be348e4d9260d);}return $this;}public function updateImages(iPage $v71860c77c6745379b0d44304d66b6a13) : iUpdater {$vd5189de027922f81005951e6efe0efd5 = $this->locationFacade->get($v71860c77c6745379b0d44304d66b6a13->getId());if (!$vd5189de027922f81005951e6efe0efd5 instanceof iLocation) {return $this;}$v72bc6e7707131edcbe44c867e3bc83e1 = $this->imageFacade->createByLocation($vd5189de027922f81005951e6efe0efd5);$v4119639092e62c55ea8be348e4d9260d = $this->eventFactory->create('update_sitemap_image', 'after')    ->setParam('location', $vd5189de027922f81005951e6efe0efd5)    ->setParam('image_list', $v72bc6e7707131edcbe44c867e3bc83e1);$v4119639092e62c55ea8be348e4d9260d->call();return $this;}public function updateList(array $v91c8246e48b278ccf9e985d258de9cc9) {foreach ($v91c8246e48b278ccf9e985d258de9cc9 as $v71860c77c6745379b0d44304d66b6a13) {if (!$v71860c77c6745379b0d44304d66b6a13 instanceof iPage) {continue;}$this->update($v71860c77c6745379b0d44304d66b6a13);}return $this;}public function updateWithImagesList(array $v91c8246e48b278ccf9e985d258de9cc9) : iUpdater {foreach ($v91c8246e48b278ccf9e985d258de9cc9 as $v71860c77c6745379b0d44304d66b6a13) {if (!$v71860c77c6745379b0d44304d66b6a13 instanceof iPage) {continue;}$this->updateImages($v71860c77c6745379b0d44304d66b6a13);}return $this;}public function delete($va6eb4816205178e88dad66a16a19ff45) {$this->locationFacade->delete($va6eb4816205178e88dad66a16a19ff45);return $this;}public function deleteList(array $vbf95cbea2fbc6aab956a058a7afb3e45) {if (empty($vbf95cbea2fbc6aab956a058a7afb3e45)) {return $this;}$v0763e0b509c9384232da95d941a0f85a = array_map(function ($vb80bb7740288fda1f201890375a60c8f) {return (int) $vb80bb7740288fda1f201890375a60c8f;}, $vbf95cbea2fbc6aab956a058a7afb3e45);$this->locationFacade->deleteList($v0763e0b509c9384232da95d941a0f85a);return $this;}public function deleteAll() {$this->imageFacade->deleteAll();$this->locationFacade->deleteAll();return $this;}public function deleteByDomain($vb80bb7740288fda1f201890375a60c8f) {$this->locationFacade->deleteByDomain($vb80bb7740288fda1f201890375a60c8f);return $this;}public function deleteImagesByDomain(int $vb80bb7740288fda1f201890375a60c8f) : iUpdater {$this->imageFacade->deleteByDomain($vb80bb7740288fda1f201890375a60c8f);return $this;}private function getRobotsDeny(iPage $v71860c77c6745379b0d44304d66b6a13) {$v3a6dbc22c79208bc65665635bc19d967 = $this->pageFacade->getAllParents($v71860c77c6745379b0d44304d66b6a13->getId(), true);$v326f338554374193a7a745b14d96459d = $this->pageFacade->loadElements($v3a6dbc22c79208bc65665635bc19d967);foreach ($v326f338554374193a7a745b14d96459d as $vd0e45878043844ffc41aac437e86b602) {if ($vd0e45878043844ffc41aac437e86b602->getValue('robots_deny')) {return true;}}return false;}private function isHiddenType(iPage $v71860c77c6745379b0d44304d66b6a13) : bool {return $v71860c77c6745379b0d44304d66b6a13->getHierarchyType()->hidePages();}private function getLink($va6eb4816205178e88dad66a16a19ff45) {$v0382b9fd9ef50b6a335f35e0aaaebf99 = $this->pageFacade->forceAbsolutePath();$vd6002bad1f6c9bdfa67a8df49c831798 = false;$v3cf2633035406f8e3eb4962af191fe14 = false;$vece42746c2b3aa1e585809fa739602ae = true;$v2a304a1348456ccd2234cd71a81bd338 = $this->pageFacade->getPathById($va6eb4816205178e88dad66a16a19ff45, $vd6002bad1f6c9bdfa67a8df49c831798, $v3cf2633035406f8e3eb4962af191fe14, $vece42746c2b3aa1e585809fa739602ae);$this->pageFacade->forceAbsolutePath($v0382b9fd9ef50b6a335f35e0aaaebf99);return $v2a304a1348456ccd2234cd71a81bd338;}private function getPriority($va6eb4816205178e88dad66a16a19ff45) {$va6eb4816205178e88dad66a16a19ff45 = (int) $va6eb4816205178e88dad66a16a19ff45;$vc9e9a848920877e76685b2e4e76de38d = $this->pageFacade->getLevel($va6eb4816205178e88dad66a16a19ff45);$v8aac9ddfd8f1554f195cfe07c8bd36f5 = round(1 / ($vc9e9a848920877e76685b2e4e76de38d + 1), 1);if ($v8aac9ddfd8f1554f195cfe07c8bd36f5 < 0.1) {$v8aac9ddfd8f1554f195cfe07c8bd36f5 = 0.1;}return $v8aac9ddfd8f1554f195cfe07c8bd36f5;}private function getMaxLevel(iPage $v71860c77c6745379b0d44304d66b6a13) {return $v71860c77c6745379b0d44304d66b6a13->getIsDefault() ? 0 : (int) $this->pageFacade->getMaxDepth($v71860c77c6745379b0d44304d66b6a13->getId(), 1);}}