<?php
 use UmiCms\Service;class umiObjectPropertyFile extends umiObjectProperty {const SINGLE_FILE_ORDER = 1;protected function loadValue() {$vd97a187384fb2a6e45703dfaee973d62 = [];$v0fea6a13c52b4d4725368f24b045ca84 = $this->getPropData();if (isset($v0fea6a13c52b4d4725368f24b045ca84['file_val']) && !isEmptyArray($v0fea6a13c52b4d4725368f24b045ca84['file_val'])) {return $this->getFromCache($v0fea6a13c52b4d4725368f24b045ca84['file_val']);}$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v80071f37861c360a27b7327e132c911a = $this->getTableName();$v16b2b26000987faccb260b9d39df1269 = (int) $this->getObjectId();$v945100186b119048837b9859c2c46410 = (int) $this->getFieldId();$vef5714e0519bfaa645cdff7d28843b70 =<<<SQL
SELECT `id`, `src`, `title`, `ord`
FROM `$v80071f37861c360a27b7327e132c911a`
WHERE `obj_id` = $v16b2b26000987faccb260b9d39df1269 AND `field_id` = $v945100186b119048837b9859c2c46410;
SQL;   $result = $v4717d53ebfdfea8477f780ec66151dcb    ->queryResult($vef5714e0519bfaa645cdff7d28843b70)    ->setFetchType(IQueryResult::FETCH_ASSOC);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$vd97a187384fb2a6e45703dfaee973d62[] = $this->mapFile($vf1965a857bc285d26fe22023aa5ab50d);}return $this->filterBrokenFiles($vd97a187384fb2a6e45703dfaee973d62);}protected function getFromCache(array $v0fea6a13c52b4d4725368f24b045ca84) {$v72bc6e7707131edcbe44c867e3bc83e1 = [];foreach ($v0fea6a13c52b4d4725368f24b045ca84 as $vf1965a857bc285d26fe22023aa5ab50d) {$v72bc6e7707131edcbe44c867e3bc83e1[] = $this->mapFile($vf1965a857bc285d26fe22023aa5ab50d);}return $this->filterBrokenFiles($v72bc6e7707131edcbe44c867e3bc83e1);}protected function mapFile($vf1965a857bc285d26fe22023aa5ab50d) {$v8c7dd922ad47494fc02c388e12c00eac = $this->createSecureFile(self::unescapeFilePath($vf1965a857bc285d26fe22023aa5ab50d['src']));$v8c7dd922ad47494fc02c388e12c00eac->setId($vf1965a857bc285d26fe22023aa5ab50d['id']);$v8c7dd922ad47494fc02c388e12c00eac->setTitle($vf1965a857bc285d26fe22023aa5ab50d['title']);$v8c7dd922ad47494fc02c388e12c00eac->setOrder($vf1965a857bc285d26fe22023aa5ab50d['ord']);return $v8c7dd922ad47494fc02c388e12c00eac;}protected function filterBrokenFiles(array $vd97a187384fb2a6e45703dfaee973d62) {$v9eb34ba60945c28231943f199eb4aacc = Service::Request()->isAdmin();return array_filter($vd97a187384fb2a6e45703dfaee973d62, function($v8c7dd922ad47494fc02c388e12c00eac) use ($v9eb34ba60945c28231943f199eb4aacc) {return !$v8c7dd922ad47494fc02c388e12c00eac->getIsBroken() || $v9eb34ba60945c28231943f199eb4aacc;});}protected function saveValue() {$this->deleteCurrentRows();if (!is_array($this->value)) {return;}$v2063c1608d6e0baf80249c42e2be5804 = getFirstValue($this->value);$v2063c1608d6e0baf80249c42e2be5804 = ($v2063c1608d6e0baf80249c42e2be5804 instanceof iUmiFile) ? $v2063c1608d6e0baf80249c42e2be5804 : $this->createSecureFile($v2063c1608d6e0baf80249c42e2be5804);if ($v2063c1608d6e0baf80249c42e2be5804->getIsBroken()) {return;}$v80071f37861c360a27b7327e132c911a = $this->getTableName();$v16b2b26000987faccb260b9d39df1269 = (int) $this->getObjectId();$v945100186b119048837b9859c2c46410 = (int) $this->getFieldId();$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v25d902c24283ab8cfbac54dfa101ad31 = $v4717d53ebfdfea8477f780ec66151dcb->escape('.' . $v2063c1608d6e0baf80249c42e2be5804->getFilePath(true));$vd5d3db1765287eef77d7927cc956f50a = $v4717d53ebfdfea8477f780ec66151dcb->escape($v2063c1608d6e0baf80249c42e2be5804->getTitle());$v70a17ffa722a3985b86d30b034ad06d7 = (int) $v2063c1608d6e0baf80249c42e2be5804->getOrder() ?: self::SINGLE_FILE_ORDER;$v1b1cc7f086b3f074da452bc3129981eb = <<<SQL
INSERT INTO `$v80071f37861c360a27b7327e132c911a` (`obj_id`, `field_id`, `src`, `title`, `ord`) VALUES
($v16b2b26000987faccb260b9d39df1269, $v945100186b119048837b9859c2c46410, '$v25d902c24283ab8cfbac54dfa101ad31', '$vd5d3db1765287eef77d7927cc956f50a', $v70a17ffa722a3985b86d30b034ad06d7)
SQL;   $v4717d53ebfdfea8477f780ec66151dcb->query($v1b1cc7f086b3f074da452bc3129981eb);}protected function sortFileList(array $vd97a187384fb2a6e45703dfaee973d62) {usort($vd97a187384fb2a6e45703dfaee973d62, function($ve7733f281a6f44c414d75e784ecec2f3, $v4e2972547e49be64f8674d27205778b2) {if ($ve7733f281a6f44c414d75e784ecec2f3->getOrder() === $v4e2972547e49be64f8674d27205778b2->getOrder()) {return 0;}return ($ve7733f281a6f44c414d75e784ecec2f3->getOrder() < $v4e2972547e49be64f8674d27205778b2->getOrder()) ? -1 : 1;});return $vd97a187384fb2a6e45703dfaee973d62;}public function getMaxOrder() {$v80071f37861c360a27b7327e132c911a = $this->getTableName();$v16b2b26000987faccb260b9d39df1269 = (int) $this->getObjectId();$v945100186b119048837b9859c2c46410 = (int) $this->getFieldId();$v1b1cc7f086b3f074da452bc3129981eb = <<<SQL
SELECT max(`ord`) as ord FROM `$v80071f37861c360a27b7327e132c911a` WHERE `obj_id` = $v16b2b26000987faccb260b9d39df1269 AND `field_id` = $v945100186b119048837b9859c2c46410;
SQL;   $vf1965a857bc285d26fe22023aa5ab50d = $this->getConnection()    ->queryResult($v1b1cc7f086b3f074da452bc3129981eb)    ->setFetchType(IQueryResult::FETCH_ASSOC)    ->fetch();return (int) $vf1965a857bc285d26fe22023aa5ab50d['ord'];}protected function isNeedToSave(array $v7f7cfde5ec586119b48911a2c75851e5) {$v0382b9fd9ef50b6a335f35e0aaaebf99 = $this->prepareValue($this->value);$v7f7cfde5ec586119b48911a2c75851e5 = $this->prepareValue($v7f7cfde5ec586119b48911a2c75851e5);$v24274de22054fb30cbbabbf7fb5438c7 = $this->getFilePathFromValue($v0382b9fd9ef50b6a335f35e0aaaebf99) !== $this->getFilePathFromValue($v7f7cfde5ec586119b48911a2c75851e5);$vc57a764e939f0600ac7ab9c2cd03e399 = $this->getTitleFromValue($v0382b9fd9ef50b6a335f35e0aaaebf99) !== $this->getTitleFromValue($v7f7cfde5ec586119b48911a2c75851e5);return $v24274de22054fb30cbbabbf7fb5438c7 || $vc57a764e939f0600ac7ab9c2cd03e399;}private function prepareValue($v2063c1608d6e0baf80249c42e2be5804) {return isset($v2063c1608d6e0baf80249c42e2be5804[0]) ? $v2063c1608d6e0baf80249c42e2be5804[0] : '';}private function getFilePathFromValue($v2063c1608d6e0baf80249c42e2be5804) {return ($v2063c1608d6e0baf80249c42e2be5804 instanceof iUmiFile) ? $v2063c1608d6e0baf80249c42e2be5804->getFilePath() : $v2063c1608d6e0baf80249c42e2be5804;}private function getTitleFromValue($v2063c1608d6e0baf80249c42e2be5804) {return ($v2063c1608d6e0baf80249c42e2be5804 instanceof iUmiFile) ? $v2063c1608d6e0baf80249c42e2be5804->getTitle() : $v2063c1608d6e0baf80249c42e2be5804;}private function createSecureFile($vd6fe1d0be6347b8ef2427fa629c04485) {return Service::FileFactory()->createSecure($vd6fe1d0be6347b8ef2427fa629c04485);}}